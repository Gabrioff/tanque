<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Solana Memecoin Simulator</title>
    <!-- Cargar Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Cargar Chart.js (para las gr√°ficas) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Anotaciones de Chart.js (para l√≠neas de compra/venta) -->
    <!-- CORRECCI√ìN: Movido ANTES del script principal -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/3.0.1/chartjs-plugin-annotation.min.js"></script>
    <!-- Iconos Phosphor (para el icono de X y la UI) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Configuraci√≥n de Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'solana-green': '#14F195',
                        'solana-purple': '#9945FF',
                        'x-blue': '#1DA1F2', // Color de Twitter/X
                        'page-bg': '#111827', // gray-900
                        'item-bg': '#1F2937', // gray-800
                        'item-hover': '#374151', // gray-700
                    },
                    keyframes: {
                        livePulse: {
                            '0%, 100%': { opacity: 1, boxShadow: '0 0 5px #F11414' },
                            '50%': { opacity: 0.6, boxShadow: '0 0 15px 5px #F11414' },
                        },
                        liveScreen: {
                            '0%, 100%': { backgroundColor: 'rgba(239, 68, 68, 0.2)' },
                            '50%': { backgroundColor: 'rgba(34, 197, 94, 0.2)' },
                        },
                        shimmer: {
                            '0%': { backgroundPosition: '-1000px 0' },
                            '100%': { backgroundPosition: '1000px 0' },
                        },
                    },
                    animation: {
                        livePulse: 'livePulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        liveScreen: 'liveScreen 1.5s ease-in-out infinite',
                        shimmer: 'shimmer 1.5s infinite linear',
                    }
                }
            }
        }
    </script>
    <style>
        /* Estilo para la barra de scroll */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #374151; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #718096; }
        
        .glassmorphism {
            background: rgba(31, 41, 55, 0.7); /* item-bg con transparencia */
            backdrop-filter: blur(10px);
            border: 1px solid rgba(55, 65, 81, 0.5); /* item-hover con transparencia */
        }
        
        .modal { transition: opacity 0.25s ease, visibility 0.25s ease; }
        .modal-content { transition: transform 0.25s ease; }
        
        /* Estilo para Popover de X */
        .x-popover-container { position: relative; display: inline-block; }
        .x-popover {
            position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%) translateY(-10px);
            z-index: 100; opacity: 0; visibility: hidden; transition: all 0.2s ease;
            width: 250px; pointer-events: none;
        }
        .x-popover-container:hover .x-popover { opacity: 1; visibility: visible; pointer-events: auto; transform: translateX(-50%) translateY(0); }

        /* Estilo para la barra de navegaci√≥n inferior */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 40;
            background: rgba(31, 41, 55, 0.9); /* item-bg con blur */
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(55, 65, 81, 0.5);
            /* Permitir scroll horizontal si hay muchas pesta√±as */
            overflow-x: auto;
            white-space: nowrap;
        }
        .nav-btn {
            display: inline-flex; /* Cambiado de flex a inline-flex */
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            padding: 8px 12px; /* M√°s padding horizontal */
            color: #9CA3AF; /* gray-400 */
            transition: color 0.2s ease;
            flex-shrink: 0; /* Evitar que los botones se encojan */
            width: auto; /* Ancho autom√°tico */
            min-width: 65px; /* Ancho m√≠nimo por bot√≥n */
        }
        .nav-btn.active { color: #14F195; /* solana-green */ }
        .nav-btn i { font-size: 24px; }
        .nav-btn span { font-size: 10px; margin-top: 2px; }

        /* Contenedor principal de la p√°gina con padding para la barra de navegaci√≥n */
        .page-container {
            padding-bottom: 60px; /* Altura de la barra de navegaci√≥n */
            flex-grow: 1;
        }
        .page {
            padding: 1rem; /* p-4 */
            display: none; /* Oculto por defecto */
        }
        .page.active {
            display: block; /* Visible */
        }

        /* Estilo para Tarjeta PnL */
        .pnl-card-gradient-win {
            background-image: linear-gradient(135deg, #14F195 0%, #10B981 100%);
        }
        .pnl-card-gradient-loss {
            background-image: linear-gradient(135deg, #F87171 0%, #EF4444 100%);
        }
    </style>
</head>
<body class="bg-page-bg text-white font-sans antialiased flex flex-col min-h-screen">

    <!-- Encabezado Fijo -->
    <header class="bg-item-bg shadow-lg sticky top-0 z-30">
        <nav class="container mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-xl lg:text-2xl font-bold text-solana-green">
                üöÄ Solana Memecoin Sim
            </h1>
            <div class="flex items-center space-x-4">
                <button id="show-create-modal-btn" class="bg-solana-purple hover:bg-opacity-80 text-white font-bold p-2 rounded-full transition duration-200">
                    <i class="ph ph-plus text-xl"></i>
                </button>
                <div class="text-right">
                    <div class="text-sm text-gray-400">Balance</div>
                    <div id="ssol-balance" class="text-lg font-semibold text-solana-green">2.00 sSOL</div>
                </div>
            </div>
        </nav>
        <div id="player-id-banner" class="bg-solana-purple text-center py-1 px-4 text-xs font-mono">
            Cargando tu ID de jugador...
        </div>
    </header>

    <!-- Contenedor Principal de P√°ginas -->
    <main class="container mx-auto page-container">
        
        <!-- P√ÅGINA 1: MERCADO (Home) -->
        <section id="page-mercado" class="page active">
            <div class="mb-3">
                <input type="text" id="coin-filter-input" placeholder="Filtrar por nombre o s√≠mbolo..." class="w-full px-3 py-2 bg-item-bg border border-item-hover rounded-md focus:outline-none focus:ring-2 focus:ring-solana-purple">
            </div>
            <div id="memecoin-list" class="flex-grow overflow-y-auto space-y-2 pr-2">
                <p class="text-gray-400">No hay monedas. ¬°Lanza la primera!</p>
            </div>
        </section>

        <!-- P√ÅGINA 2: PORTAFOLIO -->
        <section id="page-portafolio" class="page">
            <h2 class="text-xl font-semibold mb-3 border-b border-gray-700 pb-2">Mi Portafolio</h2>
            <div id="portfolio-list" class="space-y-2 pr-2 mb-6">
                <p class="text-gray-400">A√∫n no tienes monedas.</p>
            </div>
            
            <h2 class="text-xl font-semibold mb-3 border-b border-gray-700 pb-2">Mis Activos</h2>
            <div id="my-assets-list" class="flex flex-wrap gap-2">
                <p class="text-gray-400 text-sm">A√∫n no tienes activos.</p>
            </div>
        </section>

        <!-- P√ÅGINA 3: FEED SOCIAL -->
        <section id="page-social" class="page">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Feed Social</h2>
                <div>
                    <button id="show-my-profile-btn" class="bg-item-hover hover:bg-gray-600 text-white font-bold py-2 px-3 rounded-md transition duration-200 text-sm mr-2">
                        Mi Perfil
                    </button>
                    <button id="create-social-post-btn" class="bg-solana-purple hover:bg-opacity-80 text-white font-bold py-2 px-3 rounded-md transition duration-200 text-sm">
                        Crear Post
                    </button>
                </div>
            </div>
            <div id="social-feed-list" class="space-y-3">
                <p class="text-gray-400">Cargando feed...</p>
            </div>
        </section>

        <!-- P√ÅGINA 4: TIENDA -->
        <section id="page-tienda" class="page">
            <h2 class="text-xl font-semibold mb-3 border-b border-gray-700 pb-2">Tienda de Activos</h2>
            
            <!-- Secci√≥n de Lujo -->
            <h3 class="text-lg font-semibold mb-2 text-solana-purple">Lujo</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="glassmorphism rounded-lg shadow-xl p-4 flex flex-col items-center text-center">
                    <span class="text-6xl mb-2">üèéÔ∏è</span>
                    <h3 class="text-2xl font-bold mb-1">Lambo</h3>
                    <p class="text-lg font-semibold text-solana-green mb-3">5.00 sSOL</p>
                    <button data-item="lambo" data-cost="5" data-category="luxury" class="buy-asset-btn w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 px-3 rounded-md transition duration-200 text-sm">
                        Comprar
                    </button>
                </div>
                <div class="glassmorphism rounded-lg shadow-xl p-4 flex flex-col items-center text-center">
                    <span class="text-6xl mb-2">üè∞</span>
                    <h3 class="text-2xl font-bold mb-1">Mansi√≥n</h3>
                    <p class="text-lg font-semibold text-solana-green mb-3">20.00 sSOL</p>
                    <button data-item="mansion" data-cost="20" data-category="luxury" class="buy-asset-btn w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-3 rounded-md transition duration-200 text-sm">
                        Comprar
                    </button>
                </div>
                <div class="glassmorphism rounded-lg shadow-xl p-4 flex flex-col items-center text-center">
                    <span class="text-6xl mb-2">üõ•Ô∏è</span>
                    <h3 class="text-2xl font-bold mb-1">Yate</h3>
                    <p class="text-lg font-semibold text-solana-green mb-3">50.00 sSOL</p>
                    <button data-item="yate" data-cost="50" data-category="luxury" class="buy-asset-btn w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 rounded-md transition duration-200 text-sm">
                        Comprar
                    </button>
                </div>
                <div class="glassmorphism rounded-lg shadow-xl p-4 flex flex-col items-center text-center">
                    <span class="text-6xl mb-2">üõ©Ô∏è</span>
                    <h3 class="text-2xl font-bold mb-1">Jet Privado</h3>
                    <p class="text-lg font-semibold text-solana-green mb-3">100.00 sSOL</p>
                    <button data-item="jet" data-cost="100" data-category="luxury" class="buy-asset-btn w-full bg-gray-300 hover:bg-gray-400 text-gray-900 font-bold py-2 px-3 rounded-md transition duration-200 text-sm">
                        Comprar
                    </button>
                </div>
            </div>

            <!-- Secci√≥n de Oficina -->
            <h3 class="text-lg font-semibold mb-2 text-solana-purple">Oficina</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="glassmorphism rounded-lg shadow-xl p-4 flex flex-col items-center text-center">
                    <span class="text-6xl mb-2">üíª</span>
                    <h3 class="text-2xl font-bold mb-1">PC Gamer</h3>
                    <p class="text-lg font-semibold text-solana-green mb-3">2.50 sSOL</p>
                    <button data-item="pc" data-cost="2.5" data-category="office" class="buy-asset-btn w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded-md transition duration-200 text-sm">
                        Comprar
                    </button>
                </div>
                <div class="glassmorphism rounded-lg shadow-xl p-4 flex flex-col items-center text-center">
                    <span class="text-6xl mb-2">üñ•Ô∏è</span>
                    <h3 class="text-2xl font-bold mb-1">Monitor Curvo</h3>
                    <p class="text-lg font-semibold text-solana-green mb-3">1.00 sSOL</p>
                    <button data-item="monitor" data-cost="1" data-category="office" class="buy-asset-btn w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-3 rounded-md transition duration-200 text-sm">
                        Comprar
                    </button>
                </div>
                 <div class="glassmorphism rounded-lg shadow-xl p-4 flex flex-col items-center text-center">
                    <span class="text-6xl mb-2">ü™ë</span>
                    <h3 class="text-2xl font-bold mb-1">Silla Ergon√≥mica</h3>
                    <p class="text-lg font-semibold text-solana-green mb-3">0.50 sSOL</Espan>
                    <button data-item="silla" data-cost="0.5" data-category="office" class="buy-asset-btn w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-3 rounded-md transition duration-200 text-sm">
                        Comprar
                    </button>
                </div>
            </div>
        </section>
        
        <!-- P√ÅGINA 5: OFICINA -->
        <section id="page-oficina" class="page">
            <h2 class="text-xl font-semibold mb-3 border-b border-gray-700 pb-2">Mi Oficina</h2>
            <div id="my-office-layout" class="bg-item-bg rounded-lg p-6 min-h-[300px] flex flex-wrap gap-4 items-center justify-center">
                <p id="office-placeholder" class="text-gray-400">Tu oficina est√° vac√≠a. ¬°Compra items en la tienda!</p>
                <!-- Los items comprados se a√±adir√°n aqu√≠ -->
            </div>
        </section>
        
        <!-- P√ÅGINA 6: CHAT GLOBAL -->
        <section id="page-chat" class="page">
            <h2 class="text-xl font-semibold mb-3 border-b border-gray-700 pb-2">Chat Global</h2>
            <div id="chat-messages-list" class="space-y-3 h-72 overflow-y-auto pr-2 mb-4 bg-item-bg/50 p-3 rounded-lg">
                <p class="text-gray-400 text-center">Cargando mensajes...</p>
            </div>
            <form id="send-chat-message-form" class="flex gap-2">
                <input type="text" id="chat-message-input" placeholder="Escribe un mensaje..." class="w-full px-3 py-2 bg-item-bg border border-item-hover rounded-md focus:outline-none focus:ring-2 focus:ring-solana-purple" maxlength="200" required>
                <button type="submit" class="bg-solana-purple hover:bg-opacity-80 text-white font-bold p-3 rounded-md transition duration-200">
                    <i class="ph ph-paper-plane-tilt text-xl"></i>
                </button>
            </form>
        </section>

        <!-- P√ÅGINA 7: JUGADORES (A√±adida de nuevo) -->
        <section id="page-jugadores" class="page">
            <h2 class="text-xl font-semibold mb-3 border-b border-gray-700 pb-2">Jugadores en la Sala</h2>
            <div id="players-list" class="overflow-y-auto space-y-2 pr-2">
                <p class="text-gray-400">Cargando jugadores...</p>
            </div>
        </section>

    </main>

    <!-- Barra de Navegaci√≥n Inferior (7 PESTA√ëAS) -->
    <nav class="bottom-nav flex shadow-lg">
        <button class="nav-btn active" data-page="page-mercado">
            <i class="ph ph-chart-line-up"></i>
            <span>Mercado</span>
        </button>
        <button class="nav-btn" data-page="page-portafolio">
            <i class="ph ph-wallet"></i>
            <span>Portafolio</span>
        </button>
        <button class="nav-btn" data-page="page-social">
            <i class="ph ph-user-sound"></i>
            <span>Feed</span>
        </button>
        <button class="nav-btn" data-page="page-tienda">
            <i class="ph ph-storefront"></i>
            <span>Tienda</span>
        </button>
         <button class="nav-btn" data-page="page-oficina">
            <i class="ph ph-desktop"></i>
            <span>Oficina</span>
        </button>
         <button class="nav-btn" data-page="page-chat">
            <i class="ph ph-chats-circle"></i>
            <span>Chat</span>
        </button>
        <button class="nav-btn" data-page="page-jugadores">
            <i class="ph ph-users"></i>
            <span>Jugadores</span>
        </button>
    </nav>


    <!-- MODALES (siguen existiendo, pero se llaman desde las p√°ginas) -->

    <!-- Modal para Mensajes Simples -->
    <div id="message-modal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden opacity-0 visibility-hidden">
        <div class="modal-content glassmorphism p-6 rounded-lg shadow-2xl max-w-sm mx-auto text-center transform scale-95">
            <p id="message-text" class="text-lg mb-4">Mensaje</p>
            <button id="close-message-btn" class="bg-solana-purple hover:bg-opacity-80 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                Cerrar
            </button>
        </div>
    </div>
    
    <!-- Modal para Crear Moneda -->
    <div id="create-coin-modal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden opacity-0 visibility-hidden p-4">
        <div class="modal-content glassmorphism p-6 rounded-lg shadow-2xl max-w-md w-full text-center transform scale-95 overflow-y-auto max-h-full">
            <div class="flex justify-between items-center mb-3 border-b border-gray-700 pb-2">
                <h2 class="text-xl font-semibold">Lanzar Nueva Memecoin</h2>
                <button id="close-create-modal-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <form id="create-coin-form" class="space-y-3 text-left">
                <!-- ... (campos de crear moneda sin cambios) ... -->
                <div>
                    <label for="coin-name" class="block text-sm font-medium text-gray-300">Nombre (Ej: DogeWifHat)</label>
                    <input type="text" id="coin-name" required class="w-full mt-1 px-3 py-2 bg-gray-900 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-solana-purple" maxlength="20">
                </div>
                <div>
                    <label for="coin-symbol" class="block text-sm font-medium text-gray-300">S√≠mbolo (Ej: WIF)</label>
                    <input type="text" id="coin-symbol" required class="w-full mt-1 px-3 py-2 bg-gray-900 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-solana-purple" maxlength="5" autocapitalize="characters">
                </div>
                <div>
                    <label for="coin-image-url" class="block text-sm font-medium text-gray-300">URL de Imagen</label>
                    <input type="url" id="coin-image-url" placeholder="https://..." class="w-full mt-1 px-3 py-2 bg-gray-900 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-solana-purple">
                </div>
                <div>
                    <label for="coin-x-url" class="block text-sm font-medium text-gray-300">URL de X (Twitter)</label>
                    <input type="url" id="coin-x-url" placeholder="https://x.com/yourcoin" class="w-full mt-1 px-3 py-2 bg-gray-900 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-x-blue">
                </div>
                <div class="grid grid-cols-2 gap-2">
                     <div>
                        <label for="coin-initial-ssol" class="block text-sm font-medium text-gray-300">sSOL Inicial (Liq.)</label>
                        <input type="number" id="coin-initial-ssol" step="0.01" min="0.01" required placeholder="0.1" class="w-full mt-1 px-3 py-2 bg-gray-900 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-solana-purple">
                    </div>
                     <div>
                        <label for="coin-initial-tokens" class="block text-sm font-medium text-gray-300">Tokens (Liq.)</Mlabel>
                        <input type="number" id="coin-initial-tokens" step="1000" min="1000" required placeholder="1000000" class="w-full mt-1 px-3 py-2 bg-gray-900 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-solana-purple">
                    </div>
                </div>
                <button type="submit" class="w-full bg-solana-purple hover:bg-opacity-80 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                    Lanzar (Costo: 0.01 sSOL + Liq.)
                </button>
            </form>
        </div>
    </div>
    
    <!-- Modal para Gr√°fica y Trading -->
    <div id="chart-modal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden opacity-0 visibility-hidden p-4">
        <div class="modal-content glassmorphism p-6 rounded-lg shadow-2xl max-w-3xl w-full text-center transform scale-95 overflow-y-auto max-h-full">
            <!-- ... (contenido del modal de gr√°fica) ... -->
            <div class="flex justify-between items-center mb-3 border-b border-gray-700 pb-2">
                 <div class="flex items-center gap-2">
                     <h2 id="modal-coin-name" class="text-2xl font-bold text-solana-green"></h2>
                     <span id="modal-live-badge" class="hidden animate-livePulse text-xs font-bold bg-red-600 text-white px-2 py-0.5 rounded-md">LIVE</span>
                 </div>
                <button id="close-chart-modal-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>

            <p id="modal-coin-price" class="text-xl font-mono text-center text-gray-300 mb-4">$0.00</p>
            <p id="modal-contract-id" class="text-sm font-mono text-center text-gray-500 mb-4">ID de Contrato: ...</p>
            
            <div class="relative h-48 md:h-72 mb-4">
                <canvas id="coin-chart-modal"></canvas>
            </div>
            
            <div class="flex gap-2 mb-4">
                <button id="view-live-btn" class="hidden w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                    Ver Directo
                </button>
                <!-- BOT√ìN PNL (NUEVO) -->
                <button id="show-pnl-card-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                    Ver PnL
                </button>
            </div>


            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <form id="buy-form-modal" class="space-y-2 glassmorphism p-4 rounded-lg">
                    <label for="buy-amount-ssol-modal" class="block text-sm font-medium text-gray-300">Gastar (sSOL) - Fee 0.3%</label>
                    <input type="number" id="buy-amount-ssol-modal" step="0.00000001" min="0.00000001" placeholder="0.1" class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-solana-green" required>
                    <button type="submit" class="w-full bg-solana-green hover:bg-opacity-80 text-gray-900 font-bold py-2 px-4 rounded-md transition duration-200">
                        Comprar
                    </button>
                </form>
                
                <form id="sell-form-modal" class="space-y-2 glassmorphism p-4 rounded-lg">
                    <label for="sell-amount-token-modal" class="block text-sm font-medium text-gray-300">Vender (Tokens) - Fee 0.3%</label>
                    <!-- CAMBIO: A√±adido 'inputmode="decimal"' para teclados m√≥viles -->
                    <input type="text" id="sell-amount-token-modal" inputmode="decimal" placeholder="1000" class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500" required>
                    <div class="grid grid-cols-3 gap-2 text-xs">
                        <button type="button" class="sell-percent-btn bg-gray-700 hover:bg-gray-600 py-1 rounded" data-percent="0.10">10%</button>
                        <button type="button" class="sell-percent-btn bg-gray-700 hover:bg-gray-600 py-1 rounded" data-percent="0.50">50%</button>
                        <button type="button" class="sell-percent-btn bg-gray-700 hover:bg-gray-600 py-1 rounded" data-percent="1.00">100%</button>
                    </div>
                    <button type="submit" class="w-full bg-red-600 hover:bg-opacity-80 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                        Vender
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Modal para Panel de Creador -->
    <div id="creator-dashboard-modal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden opacity-0 visibility-hidden p-4">
        <div class="modal-content glassmorphism p-6 rounded-lg shadow-2xl max-w-4xl w-full text-center transform scale-95 overflow-y-auto max-h-full">
            <div class="flex justify-between items-center mb-3 border-b border-gray-700 pb-2">
                <h2 class="text-xl font-semibold">Panel de Creador</h2>
                <button id="close-creator-dashboard-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="creator-coins-list" class="space-y-4 text-left">
                <p class="text-gray-400 text-center">No has creado ninguna moneda.</p>
            </div>
        </div>
    </div>
    
    <!-- Modal para Enviar sSOL (P2P) -->
    <div id="send-ssol-modal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden opacity-0 visibility-hidden p-4">
        <div class="modal-content glassmorphism p-6 rounded-lg shadow-2xl max-w-md w-full text-center transform scale-95">
            <div class="flex justify-between items-center mb-3 border-b border-gray-700 pb-2">
                <h2 class="text-xl font-semibold">Enviar sSOL</h2>
                <button id="close-send-ssol-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <form id="send-ssol-form" class="space-y-3 text-left">
                <p class="text-sm">Enviar a: <strong id="send-ssol-target-name" class="font-mono text-solana-green">...</strong></p>
                <div>
                    <label for="send-ssol-amount" class="block text-sm font-medium text-gray-300">Monto (sSOL)</label>
                    <input type="number" id="send-ssol-amount" step="0.01" min="0.01" required placeholder="0.1" class="w-full mt-1 px-3 py-2 bg-gray-900 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-solana-purple">
                </div>
                <button type="submit" class="w-full bg-solana-purple hover:bg-opacity-80 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                    Confirmar Env√≠o
                </button>
            </form>
        </div>
    </div>
    
    <!-- Modal para "Live Stream" -->
    <div id="live-stream-modal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden opacity-0 visibility-hidden p-4">
        <div class="modal-content glassmorphism p-6 rounded-lg shadow-2xl max-w-2xl w-full text-center transform scale-95">
            <div class="flex justify-between items-center mb-3 border-b border-gray-700 pb-2">
                <h2 id="live-coin-name" class="text-xl font-semibold text-red-500 animate-pulse">LIVE: ...</h2>
                <button id="close-live-stream-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="w-full h-64 bg-black rounded-lg mb-4 animate-liveScreen border-2 border-gray-700 flex items-center justify-center">
                <span class="text-3xl font-bold text-gray-500">SIMULACI√ìN DE LIVE</span>
            </div>
            <div class="flex justify-between items-center mb-3">
                <div class="text-lg">Espectadores: <span id="live-viewers" class="font-bold text-solana-green">...</span></div>
                <div class="flex space-x-2">
                    <button id="boost-live-btn-small" data-boost-level="small" class="boost-live-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-md text-sm transition">
                        Boost (0.1 sSOL)
                    </button>
                    <button id="boost-live-btn-medium" data-boost-level="medium" class="boost-live-btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-md text-sm transition">
                        Boost (1 sSOL)
                    </button>
                    <button id="boost-live-btn-large" data-boost-level="large" class="boost-live-btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-3 rounded-md text-sm transition">
                        Boost (10 sSOL)
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para MI PERFIL (antes Editar Perfil) -->
    <div id="my-profile-modal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden opacity-0 visibility-hidden p-4">
        <div class="modal-content glassmorphism p-6 rounded-lg shadow-2xl max-w-md w-full text-center transform scale-95 overflow-y-auto max-h-full">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-xl font-semibold">Mi Perfil</h2>
                <button id="close-my-profile-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            
            <!-- Formulario de Edici√≥n -->
            <form id="edit-social-profile-form" class="space-y-3 text-left mb-4">
                <div class="flex items-center gap-4">
                    <img id="social-avatar-preview" src="https://via.placeholder.com/60/374151/FFFFFF?text=P" alt="Avatar" class="w-16 h-16 rounded-full border-2 border-solana-green">
                    <div class="flex-grow">
                        <label for="social-username-input" class="block text-sm font-medium text-gray-300">Nombre de Usuario</label>
                        <input type="text" id="social-username-input" required class="w-full mt-1 px-3 py-2 bg-gray-900 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-solana-purple" maxlength="15">
                    </div>
                </div>
                <div>
                    <label for="social-avatar-input" class="block text-sm font-medium text-gray-300">URL de Avatar</label>
                    <input type="url" id="social-avatar-input" placeholder="https://..." class="w-full mt-1 px-3 py-2 bg-gray-900 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-solana-purple">
                </div>
                <button type="submit" class="w-full bg-solana-purple hover:bg-opacity-80 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                    Guardar Perfil
                </button>
            </form>

            <div class="text-left border-t border-gray-700 pt-4">
                <h3 class="font-semibold text-md mb-2">Mis Posts</h3>
                <div id="my-social-posts" class="space-y-3 h-48 overflow-y-auto pr-2">
                    <p class="text-gray-400 text-sm">A√∫n no has hecho posts.</p>
                </div>
            </div>
            
            <button id="show-creator-dashboard-btn-from-profile" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-200 mt-4">
                üíº Panel de Creador
            </button>
            
            <button id="launch-socialfi-coin-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-md transition duration-200 mt-2 hidden">
                üíé Lanzar Moneda SocialFi (50+ Seguidores)
            </button>
        </div>
    </div>

    <!-- Modal para Crear Post Social -->
    <div id="create-social-post-modal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden opacity-0 visibility-hidden p-4">
        <div class="modal-content glassmorphism p-6 rounded-lg shadow-2xl max-w-md w-full text-center transform scale-95">
            <div class="flex justify-between items-center mb-3 border-b border-gray-700 pb-2">
                <h2 class="text-xl font-semibold">Crear Nuevo Post</h2>
                <button id="close-create-social-post-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <form id="create-social-post-form" class="space-y-3 text-left">
                <div>
                    <label for="social-post-text" class="block text-sm font-medium text-gray-300">Texto del Post</label>
                    <textarea id="social-post-text" rows="4" required class="w-full mt-1 px-3 py-2 bg-gray-900 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-solana-purple" maxlength="280" placeholder="¬øQu√© est√°s pensando? Shillea tu moneda aqu√≠..."></textarea>
                </div>
                <button type="submit" class="w-full bg-solana-purple hover:bg-opacity-80 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                    Publicar Post
                </button>
            </form>
        </div>
    </div>

    <!-- Modal para Perfil de Otro Jugador -->
    <div id="player-profile-modal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden opacity-0 visibility-hidden p-4">
        <div class="modal-content glassmorphism p-6 rounded-lg shadow-2xl max-w-md w-full text-center transform scale-95 overflow-y-auto max-h-full">
            <div class="flex justify-between items-center mb-3">
                <h2 id="player-profile-username" class="text-xl font-semibold">Perfil del Jugador</h2>
                <button id="close-player-profile-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            
            <img id="player-profile-avatar" src="https://via.placeholder.com/60/374151/FFFFFF?text=P" alt="Avatar" class="w-16 h-16 rounded-full mx-auto mb-2 border-2 border-solana-green">
            <p class="text-sm text-gray-400 mb-4">Seguidores: <span id="player-profile-followers">0</span></p>
            
            <button id="follow-player-btn" class="w-full bg-x-blue hover:bg-opacity-80 text-white font-bold py-2 px-4 rounded-md transition duration-200 mb-4">
                Seguir
            </button>

            <!-- Monedas Creadas por el Jugador (NUEVO) -->
            <div class="text-left border-t border-gray-700 pt-4 mb-4">
                <h3 class="font-semibold text-md mb-2">Monedas Creadas</h3>
                <div id="player-profile-created-coins" class="space-y-2 h-32 overflow-y-auto pr-2">
                    <p class="text-gray-400 text-sm">Este jugador no ha creado monedas.</p>
                </div>
            </div>

            <div class="text-left border-t border-gray-700 pt-4">
                <h3 class="font-semibold text-md mb-2">Posts Recientes</h3>
                <div id="player-profile-posts" class="space-y-3 h-48 overflow-y-auto pr-2">
                    <p class="text-gray-400 text-sm">Este jugador no tiene posts.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para Tarjeta PnL (NUEVO) -->
    <div id="pnl-card-modal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden opacity-0 visibility-hidden p-4">
        <div class="modal-content p-0 rounded-lg shadow-2xl max-w-sm w-full text-center transform scale-95 bg-transparent">
            <!-- Contenido de la tarjeta PnL -->
            <div id="pnl-card-content" class="rounded-lg text-white p-6 relative overflow-hidden glassmorphism">
                <div class_id="pnl-card-header" class="flex justify-between items-center mb-4">
                    <span class="text-2xl font-bold">Mi PnL</span>
                    <span id="pnl-card-coin-symbol" class="text-2xl font-bold bg-white/20 px-3 py-1 rounded-md">WIF</span>
                </div>
                
                <div id="pnl-card-result-container" class="text-center mb-6">
                    <div id="pnl-card-percentage" class="text-6xl font-bold text-green-400">+1,200%</div>
                    <div id="pnl-card-ssol" class="text-2xl font-semibold text-gray-200">+1.50 sSOL</div>
                </div>

                <div class="space-y-3 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Total Invertido (sSOL)</span>
                        <span id="pnl-card-invested" class="font-mono">0.00</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Valor Actual (sSOL)</span>
                        <span id="pnl-card-current-value" class="font-mono">0.00</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Tokens Actuales</span>
                        <span id="pnl-card-tokens" class="font-mono">0.00</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Precio Promedio Compra</span>
                        <span id="pnl-card-avg-buy" class="font-mono">$0.00</span>
                    </div>
                </div>
                <div class="absolute -bottom-10 -right-10 w-32 h-32 bg-solana-green/30 rounded-full filter blur-3xl"></div>
            </div>
            
            <button id="close-pnl-card-btn" class="mt-4 bg-solana-purple hover:bg-opacity-80 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                Cerrar
            </button>
        </div>
    </div>


    <!-- Scripts de Firebase y L√≥gica del Juego -->
    <script type="module">
        // Importar funciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            collection, 
            onSnapshot, 
            runTransaction, 
            serverTimestamp,
            query,
            updateDoc,
            orderBy,
            limit,
            increment,
            writeBatch,
            collectionGroup,
            getDocs,
            addDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- INICIO: ENVOLTORIO MAIN ASYNC ---
        async function main() {
        
            // --- CONFIGURACI√ìN DE FIREBASE (TU PROYECTO) ---
            const appId = 'meme-59775'; // <-- ACTUALIZADO
            
            // Your web app's Firebase configuration
            // For Firebase JS SDK v7.20.0 and later, measurementId is optional
            const firebaseConfig = {
            ¬† apiKey: "AIzaSyBT-5vk-IxaOIF_QeIrxnyq4qk9_cwdydU",
            ¬† authDomain: "meme-59775.firebaseapp.com",
            ¬† projectId: "meme-59775",
            ¬† storageBucket: "meme-59775.firebasestorage.app",
            ¬† messagingSenderId: "36406553582",
            ¬† appId: "1:36406553582:web:ad77e2a6672b4a98917cff",
            ¬† measurementId: "G-2PFYP6VCB9"
            };

            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const analytics = getAnalytics(app);
            // --- FIN DE LA CONFIGURACI√ìN ---
            
            const db = getFirestore(app);
            const auth = getAuth(app);
            
            // INICIO: Logs de depuraci√≥n
            console.log("appId en uso:", appId);
            console.log("Config de Firebase:", firebaseConfig.projectId);
            // FIN: Logs de depuraci√≥n
            
            // --- REFERENCIAS AL DOM (MODALES Y OTROS) ---
            const messageModalEl = document.getElementById('message-modal');
            const messageTextEl = document.getElementById('message-text');
            const closeMessageBtn = document.getElementById('close-message-btn');
            
            const createCoinModalEl = document.getElementById('create-coin-modal');
            const showCreateModalBtn = document.getElementById('show-create-modal-btn');
            const closeCreateModalBtn = document.getElementById('close-create-modal-btn');

            const chartModalEl = document.getElementById('chart-modal');
            const closeChartModalBtn = document.getElementById('close-chart-modal-btn');
            const modalCoinNameEl = document.getElementById('modal-coin-name');
            const modalCoinPriceEl = document.getElementById('modal-coin-price');
            const modalLiveBadgeEl = document.getElementById('modal-live-badge');
            const viewLiveBtnEl = document.getElementById('view-live-btn');
            const modalContractIdEl = document.getElementById('modal-contract-id');
            const showPnlCardBtn = document.getElementById('show-pnl-card-btn');
            
            const pnlCardModalEl = document.getElementById('pnl-card-modal');
            const closePnlCardBtn = document.getElementById('close-pnl-card-btn');
            
            const creatorDashboardModalEl = document.getElementById('creator-dashboard-modal');
            const closeCreatorDashboardBtn = document.getElementById('close-creator-dashboard-btn');
            const creatorCoinsListEl = document.getElementById('creator-coins-list');
            
            const sendSsolModalEl = document.getElementById('send-ssol-modal');
            const closeSendSsolBtn = document.getElementById('close-send-ssol-btn');
            const sendSsolTargetNameEl = document.getElementById('send-ssol-target-name');
            const sendSsolFormEl = document.getElementById('send-ssol-form');
            const sendSsolAmountEl = document.getElementById('send-ssol-amount');
            
            const liveStreamModalEl = document.getElementById('live-stream-modal');
            const closeLiveStreamBtn = document.getElementById('close-live-stream-btn');
            const liveCoinNameEl = document.getElementById('live-coin-name');
            const liveViewersEl = document.getElementById('live-viewers');
            
            const myProfileModalEl = document.getElementById('my-profile-modal');
            const showMyProfileBtn = document.getElementById('show-my-profile-btn');
            const closeMyProfileBtn = document.getElementById('close-my-profile-btn');
            const editSocialProfileFormEl = document.getElementById('edit-social-profile-form');
            const socialUsernameInputEl = document.getElementById('social-username-input');
            const socialAvatarInputEl = document.getElementById('social-avatar-input');
            const socialAvatarPreviewEl = document.getElementById('social-avatar-preview');
            const mySocialPostsEl = document.getElementById('my-social-posts');
            const showCreatorDashboardBtnFromProfile = document.getElementById('show-creator-dashboard-btn-from-profile');
            const launchSocialFiCoinBtn = document.getElementById('launch-socialfi-coin-btn');

            const createSocialPostModalEl = document.getElementById('create-social-post-modal');
            const closeCreateSocialPostBtn = document.getElementById('close-create-social-post-btn');
            const createSocialPostBtn = document.getElementById('create-social-post-btn');
            const createSocialPostFormEl = document.getElementById('create-social-post-form');
            const socialPostTextEl = document.getElementById('social-post-text');

            const playerProfileModalEl = document.getElementById('player-profile-modal');
            const closePlayerProfileBtn = document.getElementById('close-player-profile-btn');
            const playerProfileUsernameEl = document.getElementById('player-profile-username');
            const playerProfileAvatarEl = document.getElementById('player-profile-avatar');
            const playerProfileFollowersEl = document.getElementById('player-profile-followers');
            const playerProfilePostsEl = document.getElementById('player-profile-posts');
            const playerProfileCreatedCoinsEl = document.getElementById('player-profile-created-coins');
            const followPlayerBtn = document.getElementById('follow-player-btn');
            
            
            // --- FUNCIONES DE MODAL ---
            function showModal(modalEl) {
                modalEl.classList.remove('hidden');
                setTimeout(() => {
                    modalEl.classList.remove('opacity-0', 'visibility-hidden');
                    modalEl.querySelector('.modal-content').classList.remove('scale-95');
                }, 10);
            }

            function hideModal(modalEl) {
                modalEl.classList.add('opacity-0');
                modalEl.querySelector('.modal-content').classList.add('scale-95');
                setTimeout(() => {
                    modalEl.classList.add('hidden', 'visibility-hidden');
                }, 250);
            }

            function showMessage(text) {
                messageTextEl.textContent = text;
                showModal(messageModalEl);
            }
            
            closeMessageBtn.addEventListener('click', () => hideModal(messageModalEl));
            showCreateModalBtn.addEventListener('click', () => showModal(createCoinModalEl));
            closeCreateModalBtn.addEventListener('click', () => hideModal(createCoinModalEl));
            closeChartModalBtn.addEventListener('click', () => {
                hideModal(chartModalEl);
                selectedCoinId = null; 
                if (memecoinChart) {
                    memecoinChart.options.plugins.annotation.annotations = {};
                    memecoinChart.update('none');
                }
                const coinElements = memecoinListEl.querySelectorAll('button');
                coinElements.forEach(child => {
                    child.classList.remove('bg-solana-purple/50');
                    child.classList.add('bg-item-bg');
                });
            });
            
            showPnlCardBtn.addEventListener('click', () => showPnlModal(selectedCoinId));
            closePnlCardBtn.addEventListener('click', () => hideModal(pnlCardModalEl));

            showCreatorDashboardBtnFromProfile.addEventListener('click', () => {
                hideModal(myProfileModalEl);
                showCreatorDashboard();
            });
            closeCreatorDashboardBtn.addEventListener('click', () => hideModal(creatorDashboardModalEl));
            
            closeSendSsolBtn.addEventListener('click', () => hideModal(sendSsolModalEl));
            closeLiveStreamBtn.addEventListener('click', () => hideModal(liveStreamModalEl));
            viewLiveBtnEl.addEventListener('click', () => showLiveStream());
            document.querySelectorAll('.boost-live-btn').forEach(btn => btn.addEventListener('click', (e) => boostLiveStream(e.target.dataset.boostLevel)));
            
            showMyProfileBtn.addEventListener('click', () => {
                const player = allPlayersCache.get(currentUserId);
                if (player) {
                    socialUsernameInputEl.value = player.username || '';
                    socialAvatarInputEl.value = player.avatarUrl || '';
                    socialAvatarPreviewEl.src = player.avatarUrl || 'https://via.placeholder.com/60/374151/FFFFFF?text=P';
                }
                showModal(myProfileModalEl);
            });
            closeMyProfileBtn.addEventListener('click', () => hideModal(myProfileModalEl));

            createSocialPostBtn.addEventListener('click', () => showModal(createSocialPostModalEl));
            closeCreateSocialPostBtn.addEventListener('click', () => hideModal(createSocialPostModalEl));
            
            closePlayerProfileBtn.addEventListener('click', () => hideModal(playerProfileModalEl));


            // --- VARIABLES GLOBALES DEL JUEGO ---
            let currentUserId = null;
            let selectedCoinId = null;
            let targetPlayerId = null; 
            let memecoinChart = null;
            let chartGradient = null; // Para el gradiente de la gr√°fica
            let allCoinsCache = new Map(); 
            let myPortfolioCache = new Map(); 
            let myAssetsCache = new Map(); 
            let myOfficeItemsCache = new Map();
            let allPlayersCache = new Map(); 
            let mySocialPostsCache = new Map(); 
            let globalSocialFeedCache = new Map();
            let globalChatCache = [];
            let selectedProfilePlayerId = null;
            let myFollowsCache = new Set(); // Cache para saber a qui√©n sigo
            
            // --- COMISIONES ---
            const LP_FEE = 0.0025; // 0.25%
            const CREATOR_FEE = 0.0005; // 0.05%
            const TOTAL_FEE = LP_FEE + CREATOR_FEE; // 0.3%
            const PROMO_POST_COST = 0.2; // Costo para promocionar un post
            
            // Referencias de Firestore
            const roomRef = collection(db, 'artifacts', appId, 'public', 'data', 'game_rooms', 'global_room', 'data');
            const playersRef = collection(db, 'artifacts', appId, 'public', 'data', 'game_rooms', 'global_room', 'players');
            const socialPostsRef = collection(db, 'artifacts', appId, 'public', 'data', 'game_rooms', 'global_room', 'social_posts');
            const chatMessagesRef = collection(db, 'artifacts', appId, 'public', 'data', 'game_rooms', 'global_room', 'chat_messages');
            

            // --- REFERENCIAS AL DOM (P√ÅGINAS) ---
            const ssolBalanceEl = document.getElementById('ssol-balance');
            const playerIdBannerEl = document.getElementById('player-id-banner');
            const coinFilterInputEl = document.getElementById('coin-filter-input');
            
            const pages = document.querySelectorAll('.page');
            const navButtons = document.querySelectorAll('.nav-btn');

            // Contenedores de listas
            const memecoinListEl = document.getElementById('memecoin-list');
            const portfolioListEl = document.getElementById('portfolio-list');
            const myAssetsListEl = document.getElementById('my-assets-list');
            const socialFeedListEl = document.getElementById('social-feed-list');
            const playersListEl = document.getElementById('players-list');
            const myOfficeLayoutEl = document.getElementById('my-office-layout');
            const officePlaceholderEl = document.getElementById('office-placeholder');
            const chatMessagesListEl = document.getElementById('chat-messages-list');

            // Formularios (dentro de modales)
            const createCoinFormEl = document.getElementById('create-coin-form');
            const coinNameEl = document.getElementById('coin-name');
            const coinSymbolEl = document.getElementById('coin-symbol');
            const coinImageUrlEl = document.getElementById('coin-image-url');
            const coinXUrlEl = document.getElementById('coin-x-url');
            const coinInitialSsolEl = document.getElementById('coin-initial-ssol');
            const coinInitialTokensEl = document.getElementById('coin-initial-tokens');
            
            const buyFormEl = document.getElementById('buy-form-modal');
            const sellFormEl = document.getElementById('sell-form-modal');
            const buyAmountEl = document.getElementById('buy-amount-ssol-modal');
            const sellAmountEl = document.getElementById('sell-amount-token-modal');
            
            const sendChatMessageFormEl = document.getElementById('send-chat-message-form');
            const chatMessageInputEl = document.getElementById('chat-message-input');


            // --- L√ìGICA DE NAVEGACI√ìN (SPA) ---
            function showPage(pageId) {
                pages.forEach(page => {
                    page.classList.toggle('active', page.id === pageId);
                });
                navButtons.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.page === pageId);
                });
            }

            navButtons.forEach(btn => {
                btn.addEventListener('click', () => showPage(btn.dataset.page));
            });
            

            // --- FUNCIONES DE UTILIDAD ---
            function formatPrice(value) {
                if (isNaN(value)) value = 0;
                return new Intl.NumberFormat('en-US', { 
                    style: 'currency', 
                    currency: 'USD',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 10
                }).format(value);
            }
            function formatCurrency(value) {
                if (isNaN(value)) value = 0;
                 return new Intl.NumberFormat('en-US', { 
                    style: 'currency', 
                    currency: 'USD',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(value);
            }
            function formatNumber(value) {
                if (isNaN(value)) value = 0;
                return new Intl.NumberFormat('en-US', { maximumFractionDigits: 2 }).format(value);
            }
            // Funci√≥n mejorada para aceptar comas y puntos
            function parseDecimalInput(value) {
                if (!value) return 0;
                // Reemplaza la coma por un punto y elimina todo excepto el primer punto
                let cleanValue = value.replace(/,/g, '.');
                const parts = cleanValue.split('.');
                if (parts.length > 2) {
                    cleanValue = parts[0] + '.' + parts.slice(1).join('');
                }
                let parsed = parseFloat(cleanValue);
                return isNaN(parsed) ? 0 : parsed;
            }
            function timeAgo(date) {
                if (!date) return 'justo ahora';
                const seconds = Math.floor((new Date() - date) / 1000);
                let interval = seconds / 31536000;
                if (interval > 1) return Math.floor(interval) + "a";
                interval = seconds / 2592000;
                if (interval > 1) return Math.floor(interval) + "m";
                interval = seconds / 86400;
                if (interval > 1) return Math.floor(interval) + "d";
                interval = seconds / 3600;
                if (interval > 1) return Math.floor(interval) + "h";
                interval = seconds / 60;
                if (interval > 1) return Math.floor(interval) + "min";
                return "ahora";
            }

            // --- L√ìGICA DE AUTENTICACI√ìN Y JUEGO ---
            
            async function initAuth() {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        playerIdBannerEl.textContent = `Tu ID de Jugador: ...${user.uid.slice(-6)}`;
                        await joinGame(user.uid);
                    } else {
                        try {
                            // CORRECCI√ìN: Verificar si la autenticaci√≥n an√≥nima est√° habilitada en Firebase
                            // Si ves el error "auth/configuration-not-found", ve a tu consola Firebase
                            // -> Authentication -> Sign-in method -> Habilita "Anonymous"
                            await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Error de autenticaci√≥n:", error);
                            showMessage("Error al conectar con el servidor. Verifica que la Autenticaci√≥n An√≥nima est√© habilitada en Firebase.");
                        }
                    }
                });
            }
            
            async function joinGame(userId) {
                const playerRef = doc(playersRef, userId);
                
                // INICIO: Logs de depuraci√≥n
                console.log("joinGame: Verificando jugador...");
                console.log("Ruta de getDoc(playerRef):", playerRef.path); 
                
                const playerDoc = await getDoc(playerRef).catch(e => {
                    console.error("Error en getDoc(playerRef):", e.message);
                    showMessage("Error al leer tu perfil. Revisa los permisos de Firestore.");
                });
                // FIN: Logs de depuraci√≥n
                
                if (!playerDoc) return; // Detener si hubo un error de permisos

                if (!playerDoc.exists()) {
                    await setDoc(playerRef, {
                        userId: userId,
                        sSOL_balance: 2, 
                        joinedAt: serverTimestamp(),
                        assets: {}, // Lujo
                        officeItems: {}, // Oficina
                        username: `Jugador${userId.slice(-4)}`,
                        avatarUrl: `https://placehold.co/60/374151/FFFFFF?text=${userId.slice(-1)}`,
                        socialFollowers: 0,
                        following: [] // Array de IDs de jugadores que sigo
                    });
                }
                
                listenForPlayerBalance(userId);
                listenForPlayers();
                listenForMemecoins();
                listenForMyPortfolio(userId);
                listenForMySocialProfile(userId); 
                listenForMySocialPosts(userId);
                listenForGlobalSocialFeed();
                listenForMyFollows(userId);
                listenForChatMessages(); // ¬°NUEVO!
            }
            
            // --- LISTENERS DE FIRESTORE (TIEMPO REAL) ---

            function listenForPlayerBalance(userId) {
                const playerRef = doc(playersRef, userId);
                onSnapshot(playerRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        ssolBalanceEl.textContent = `${formatNumber(data.sSOL_balance)} sSOL`;
                        myAssetsCache = new Map(Object.entries(data.assets || {}));
                        myOfficeItemsCache = new Map(Object.entries(data.officeItems || {}));
                        updateMyAssetsUI();
                        updateMyOfficeUI(); // Actualizar oficina
                    }
                });
            }

            function listenForPlayers() {
                onSnapshot(query(playersRef), (snapshot) => {
                    playersListEl.innerHTML = ''; 
                    allPlayersCache.clear();
                    if (snapshot.empty) {
                        playersListEl.innerHTML = '<p class="text-gray-400">Est√°s solo aqu√≠...</p>';
                        return;
                    }
                    snapshot.forEach(doc => {
                        const player = doc.data();
                        allPlayersCache.set(player.userId, player);
                        const isMe = player.userId === currentUserId;
                        
                        const playerEl = document.createElement('div');
                        playerEl.className = `flex w-full justify-between items-center p-3 rounded-lg ${isMe ? 'bg-solana-purple/30' : 'bg-item-bg'}`;
                        playerEl.innerHTML = `
                            <div class="flex items-center gap-3">
                                <img src="${player.avatarUrl || 'https://via.placeholder.com/40/374151/FFFFFF?text=P'}" alt="avatar" class="w-10 h-10 rounded-full">
                                <div>
                                    <span class="font-semibold truncate ${isMe ? 'text-solana-green' : ''}">
                                        ${player.username || '...'} ${isMe ? '(T√∫)' : ''}
                                    </span>
                                    <span class="text-sm text-gray-400 block">${formatNumber(player.socialFollowers || 0)} seguidores</span>
                                </div>
                            </div>
                            <span class="text-sm font-semibold">${formatNumber(player.sSOL_balance)} sSOL</span>
                        `;
                        
                        if (!isMe) {
                            // A√±adir botones para Seguir y Enviar sSOL
                            const controlsEl = document.createElement('div');
                            controlsEl.className = "flex gap-2";
                            
                            const sendBtn = document.createElement('button');
                            sendBtn.innerHTML = `<i class="ph ph-paper-plane-tilt text-xl"></i>`;
                            sendBtn.className = "p-2 bg-item-hover rounded-md hover:bg-gray-600 transition";
                            sendBtn.title = "Enviar sSOL";
                            sendBtn.addEventListener('click', () => {
                                targetPlayerId = player.userId;
                                sendSsolTargetNameEl.textContent = `${player.username || '...' + player.userId.slice(-6)}`;
                                showModal(sendSsolModalEl);
                            });
                            
                            const profileBtn = document.createElement('button');
                            profileBtn.innerHTML = `<i class="ph ph-user text-xl"></i>`;
                            profileBtn.className = "p-2 bg-item-hover rounded-md hover:bg-gray-600 transition";
                            profileBtn.title = "Ver Perfil";
                            profileBtn.addEventListener('click', () => {
                                showPlayerProfile(player.userId);
                            });
                            
                            controlsEl.appendChild(profileBtn);
                            controlsEl.appendChild(sendBtn);
                            playerEl.appendChild(controlsEl);
                        }
                        
                        playersListEl.appendChild(playerEl);
                    });
                });
            }
            
            function listenForMyFollows(userId) {
                const playerRef = doc(playersRef, userId);
                onSnapshot(playerRef, (doc) => {
                    if (doc.exists()) {
                        myFollowsCache = new Set(doc.data().following || []);
                    }
                });
            }

            function listenForMySocialProfile(userId) {
                const playerRef = doc(playersRef, userId);
                onSnapshot(playerRef, (doc) => {
                    if (doc.exists()) {
                        const player = doc.data();
                        // Actualizar modal de Mi Perfil
                        socialUsernameInputEl.value = player.username || '';
                        socialAvatarInputEl.value = player.avatarUrl || '';
                        socialAvatarPreviewEl.src = player.avatarUrl || 'https://via.placeholder.com/60/374151/FFFFFF?text=P';
                        
                        launchSocialFiCoinBtn.classList.toggle('hidden', (player.socialFollowers || 0) < 50);
                    }
                });
            }

            function listenForMySocialPosts(userId) {
                const postsQuery = query(socialPostsRef, orderBy('createdAt', 'desc'));
                onSnapshot(postsQuery, (snapshot) => {
                    mySocialPostsEl.innerHTML = '';
                    mySocialPostsCache.clear();
                    let hasPosts = false;
                    snapshot.forEach(doc => {
                        const post = doc.data();
                        if (post.userId === userId) { // Filtrar solo mis posts
                            hasPosts = true;
                            mySocialPostsCache.set(doc.id, post);
                            const postEl = document.createElement('div');
                            postEl.className = 'bg-item-hover p-3 rounded-lg text-sm';
                            postEl.innerHTML = `
                                <p>${post.text}</p>
                                <p class="text-xs text-gray-500 mt-2">${new Date(post.createdAt.toDate()).toLocaleString()}</p>
                            `;
                            mySocialPostsEl.appendChild(postEl);
                        }
                    });
                    if (!hasPosts) {
                        mySocialPostsEl.innerHTML = '<p class="text-gray-400 text-sm">A√∫n no has hecho posts.</p>';
                    }
                });
            }
            
            function listenForGlobalSocialFeed() {
                const q = query(socialPostsRef, orderBy("createdAt", "desc"), limit(100));
                onSnapshot(q, (snapshot) => {
                    socialFeedListEl.innerHTML = '';
                    globalSocialFeedCache.clear();
                    if (snapshot.empty) {
                        socialFeedListEl.innerHTML = '<p class="text-gray-400 text-center">¬°El feed est√° vac√≠o! S√© el primero en postear.</p>';
                        return;
                    }

                    // 1. Convertir snapshot a array
                    const posts = [];
                    snapshot.forEach(doc => {
                        posts.push({ id: doc.id, ...doc.data() });
                    });

                    // 2. Ordenar en JavaScript: boosted=true primero, luego por fecha
                    posts.sort((a, b) => {
                        if (a.boosted && !b.boosted) return -1;
                        if (!a.boosted && b.boosted) return 1;
                        const dateA = a.createdAt?.toDate() || new Date(0);
                        const dateB = b.createdAt?.toDate() || new Date(0);
                        return dateB - dateA;
                    });

                    // 3. Iterar sobre el array ordenado (posts) y tomar los primeros 50
                    posts.slice(0, 50).forEach(post => {
                        globalSocialFeedCache.set(post.id, post);
                        
                        const player = allPlayersCache.get(post.userId) || { username: 'Desconocido', avatarUrl: '' };
                        const postEl = document.createElement('div');
                        postEl.className = `glassmorphism p-4 rounded-lg ${post.boosted ? 'border-2 border-solana-purple' : 'border border-transparent'}`;
                        
                        let promoBtn = '';
                        if (post.userId === currentUserId && !post.boosted) {
                            promoBtn = `<button data-post-id="${post.id}" class="promote-post-btn text-sm text-solana-purple hover:text-solana-green transition">Promocionar (0.2 sSOL)</button>`;
                        } else if (post.boosted) {
                            promoBtn = `<span class="text-sm text-solana-purple font-semibold">¬°Promocionado!</span>`;
                        }

                        postEl.innerHTML = `
                            <div class="flex justify-between items-start">
                                <button data-player-id="${post.userId}" class="player-profile-link flex items-center gap-3 group">
                                    <img src="${player.avatarUrl || 'https://via.placeholder.com/40/374151/FFFFFF?text=P'}" alt="avatar" class="w-10 h-10 rounded-full group-hover:opacity-80 transition">
                                    <div>
                                        <p class="font-semibold text-white group-hover:text-solana-green transition">${player.username}</p>
                                        <p class="text-xs text-gray-400">${timeAgo(post.createdAt?.toDate())}</p>
                                    </div>
                                </button>
                                ${promoBtn}
                            </div>
                            <p class="mt-3 text-gray-200">${post.text}</p>
                        `;
                        socialFeedListEl.appendChild(postEl);
                    });
                    
                    // A√±adir listeners a los nuevos botones del feed
                    socialFeedListEl.querySelectorAll('.promote-post-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => promotePost(e.target.dataset.postId, e.target));
                    });
                    socialFeedListEl.querySelectorAll('.player-profile-link').forEach(btn => {
                        btn.addEventListener('click', (e) => showPlayerProfile(e.currentTarget.dataset.playerId));
                    });
                });
            }
            
            function listenForChatMessages() {
                const q = query(chatMessagesRef, orderBy("timestamp", "desc"), limit(50));
                onSnapshot(q, (snapshot) => {
                    globalChatCache = [];
                    snapshot.forEach(doc => {
                        globalChatCache.unshift({ id: doc.id, ...doc.data() }); // unshift para a√±adir al principio
                    });
                    updateChatUI();
                });
            }

            function listenForMyPortfolio(userId) {
                const portfolioRef = collection(playersRef, userId, 'wallet');
                onSnapshot(query(portfolioRef, orderBy('lastAcquired', 'desc')), (snapshot) => { // Ordenar por 'lastAcquired'
                    portfolioListEl.innerHTML = '';
                    myPortfolioCache.clear();
                    
                    if (snapshot.empty) {
                        portfolioListEl.innerHTML = '<p class="text-gray-400">A√∫n no tienes monedas.</p>';
                        return;
                    }
                    
                    const portfolioCoins = [];
                    snapshot.forEach(doc => {
                        const coin = doc.data();
                        if (coin.amount < 0.00000001) return;
                        portfolioCoins.push({ id: doc.id, ...coin });
                    });
                    
                    // Ordenar por 'lastAcquired' descendente (m√°s nuevo primero)
                    portfolioCoins.sort((a, b) => (b.lastAcquired?.toDate() || 0) - (a.lastAcquired?.toDate() || 0));

                    portfolioCoins.forEach(coin => {
                        myPortfolioCache.set(coin.id, coin);
                        
                        const coinData = allCoinsCache.get(coin.id);
                        const coinName = coinData ? `${coinData.name} (${coinData.symbol})` : 'Moneda Desconocida';
                        const currentValue = coinData ? coin.amount * coinData.currentPrice : 0;
                        
                        const itemEl = document.createElement('div');
                        // CORRECCI√ìN: A√±adir clase y data-attribute para updatePortfolioValues
                        itemEl.className = 'portfolio-item flex justify-between items-center bg-item-bg p-3 rounded-lg';
                        itemEl.dataset.coinId = coin.id; 
                        itemEl.innerHTML = `
                            <div>
                                <div class="font-semibold">${coinName}</div>
                                <!-- CORRECCI√ìN: A√±adir clase -->
                                <div class="portfolio-amount text-sm text-gray-400">${formatNumber(coin.amount)} tokens</div>
                            </div>
                            <div class="text-right">
                                <!-- CORRECCI√ìN: A√±adir clase -->
                                <div class="portfolio-value font-semibold">${formatCurrency(currentValue)}</div>
                                <div class="text-sm text-gray-400">Valor</div>
                            </div>
                        `;
                        portfolioListEl.appendChild(itemEl);
                    });
                });
            }

            function listenForMemecoins() {
                // Ordenar por 'createdAt' descendente (m√°s nuevo primero)
                onSnapshot(query(roomRef, orderBy('createdAt', 'desc')), (snapshot) => {
                    const newCache = new Map();
                    snapshot.forEach(doc => {
                        newCache.set(doc.id, { id: doc.id, ...doc.data() });
                    });
                    allCoinsCache = newCache; 
                    updateMemecoinListUI();
                });
            }

            // --- FUNCIONES DE ACTUALIZACI√ìN DE UI ---

            function updateMemecoinListUI() {
                memecoinListEl.innerHTML = '';
                
                const filterText = coinFilterInputEl.value.toLowerCase();
                let filteredCoins = Array.from(allCoinsCache.values()).filter(coin => 
                    coin.name.toLowerCase().includes(filterText) || 
                    coin.symbol.toLowerCase().includes(filterText)
                );
                
                // Ya est√°n ordenadas por 'createdAt' por el listener de Firestore
                // Si se desea otro orden (ej: MarketCap), se re-ordena aqu√≠.
                // filteredCoins.sort((a, b) => (b.marketCap || 0) - (a.marketCap || 0));
                
                if (filteredCoins.length === 0) {
                     memecoinListEl.innerHTML = `<p class="text-gray-400 text-center mt-10">${allCoinsCache.size === 0 ? 'No hay monedas. ¬°Lanza la primera!' : 'No se encontraron monedas.'}</p>`;
                    return;
                }

                filteredCoins.forEach(coin => {
                    const priceChange = coin.priceHistory.length > 1 ? (coin.currentPrice - coin.priceHistory[coin.priceHistory.length - 2]) / coin.priceHistory[coin.priceHistory.length - 2] : 0;
                    const changeColor = priceChange >= 0 ? 'text-green-500' : 'text-red-500';
                    const changeIcon = priceChange >= 0 ? '‚ñ≤' : '‚ñº';
                    const placeholderImg = `https://placehold.co/40x40/${coin.id.slice(0,6)}/FFFFFF?text=${coin.symbol}`;

                    const coinEl = document.createElement('button');
                    coinEl.className = `w-full text-left p-3 rounded-lg transition duration-200 ${selectedCoinId === coin.id ? 'bg-solana-purple/50' : 'bg-item-bg hover:bg-item-hover'}`;
                    coinEl.dataset.coinId = coin.id;
                    coinEl.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <img src="${coin.imageUrl || placeholderImg}" onerror="this.src='${placeholderImg}'" alt="${coin.name}" class="w-10 h-10 rounded-full bg-gray-700">
                                <div>
                                    <span class="text-lg font-bold">${coin.name} (${coin.symbol})</span>
                                    <span class="text-xs text-gray-400 block" title="${coin.creatorId}">Creador: ${allPlayersCache.get(coin.creatorId)?.username || '...' + coin.creatorId.slice(-6)}</span>
                                </div>
                                ${coin.isLive ? `<span class="animate-livePulse text-xs font-bold bg-red-600 text-white px-2 py-0.5 rounded-md ml-2">LIVE</span>` : ''}
                                ${coin.xUrl ? `
                                    <div class="x-popover-container ml-1">
                                        <i class="ph ph-x text-gray-400 hover:text-x-blue cursor-pointer text-base"></i>
                                        <div class="x-popover glassmorphism p-3 rounded-lg shadow-xl text-xs">
                                            <div class="flex items-center gap-2 mb-2">
                                                <img src="${coin.imageUrl || placeholderImg}" alt="${coin.name}" class="w-8 h-8 rounded-full">
                                                <div>
                                                    <p class="font-bold text-white">${coin.name} <i class="ph ph-check-circle-fill text-x-blue text-xs align-middle"></i></p>
                                                    <p class="text-gray-400">@${(coin.name || 'memecoin').replace(/\s/g, '_').slice(0,10)}_Official</p>
                                                </div>
                                            </div>
                                            <p class="text-gray-300 mb-2">¬°Sigue el hype en X!</p>
                                            <div class="flex justify-between text-gray-400 mb-2">
                                                <span><strong class="text-white">${formatNumber(coin.followers || 0)}</strong> Seguidores</span>
                                            </div>
                                            <a href="${coin.xUrl}" target="_blank" class="w-full inline-block bg-x-blue hover:bg-opacity-80 text-white font-bold py-1.5 px-2 rounded-md transition duration-200 text-center">Ver perfil en X</a>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="text-right">
                                <span class="text-lg font-mono">${formatPrice(coin.currentPrice)}</span>
                                <span class="text-sm font-semibold ${changeColor}">${changeIcon} ${formatNumber(priceChange * 100)}%</span>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-3 sm:grid-cols-5 gap-2 mt-3 text-xs text-center">
                            <div>
                                <span class="text-gray-400 block">MC</span>
                                <span class="font-semibold">${formatCurrency(coin.marketCap || 0)}</span>
                            </div>
                            <div>
                                <span class="text-gray-400 block">Liquidez</span>
                                <span class="font-semibold">${formatCurrency(coin.sSolPool || 0)}</span>
                            </div>
                             <div>
                                <span class="text-gray-400 block">Volumen</span>
                                <span class="font-semibold">${formatCurrency(coin.volume || 0)}</span>
                            </div>
                             <div>
                                <span class="text-gray-400 block">Holders</span>
                                <span class="font-semibold">${formatNumber(coin.holderCount || 0)}</span>
                            </div>
                            <div>
                                <span class="text-gray-400 block">Seguidores</span>
                                <span class="font-semibold">${formatNumber(coin.followers || 0)}</span>
                            </div>
                        </div>
                    `;
                    coinEl.addEventListener('click', () => selectCoin(coin.id));
                    memecoinListEl.appendChild(coinEl);

                    if (coin.id === selectedCoinId) {
                        updateChart(coin);
                        updateSelectedCoinPrice(coin.currentPrice);
                        modalCoinNameEl.textContent = `${coin.name} (${coin.symbol})`;
                        modalContractIdEl.textContent = `ID de Contrato: ...${coin.contractId.slice(-6)}`;
                        modalLiveBadgeEl.classList.toggle('hidden', !coin.isLive);
                        viewLiveBtnEl.classList.toggle('hidden', !coin.isLive);
                    }
                });
                
                updatePortfolioValues();
            }

            coinFilterInputEl.addEventListener('input', updateMemecoinListUI);
            
            function updatePortfolioValues() {
                // El listener de myPortfolioCache ya se encarga de re-renderizar
                // Esta funci√≥n solo se llama desde updateMemecoinListUI para forzar
                // la actualizaci√≥n de valores si los precios cambian.
                
                // Re-iterar sobre el cach√© existente para actualizar valores
                portfolioListEl.querySelectorAll('.portfolio-item').forEach(itemEl => {
                     const coinId = itemEl.dataset.coinId;
                     const coin = myPortfolioCache.get(coinId);
                     const coinData = allCoinsCache.get(coinId);
                     
                     if (coin && coinData) {
                         const currentValue = coin.amount * coinData.currentPrice;
                         itemEl.querySelector('.portfolio-value').textContent = formatCurrency(currentValue);
                         itemEl.querySelector('.portfolio-amount').textContent = `${formatNumber(coin.amount)} tokens`;
                     }
                });
            }
            
            function updateMyAssetsUI() {
                myAssetsListEl.innerHTML = '';
                let hasAssets = false;
                
                // Lujo
                myAssetsCache.forEach((count, item) => {
                    hasAssets = true;
                    const itemMap = { lambo: 'üèéÔ∏è', mansion: 'üè∞', yate: 'üõ•Ô∏è', jet: 'üõ©Ô∏è' };
                    const nameMap = { lambo: 'Lambo', mansion: 'Mansi√≥n', yate: 'Yate', jet: 'Jet Privado' };
                    const itemEl = document.createElement('div');
                    itemEl.className = 'bg-item-bg p-3 rounded-lg text-center';
                    itemEl.innerHTML = `
                        <span class="text-2xl">${itemMap[item] || 'üì¶'}</span>
                        <div class="text-sm font-semibold">${nameMap[item] || item} (x${count})</div>
                    `;
                    myAssetsListEl.appendChild(itemEl);
                });
                
                // Oficina
                myOfficeItemsCache.forEach((count, item) => {
                     hasAssets = true;
                    const itemMap = { pc: 'üíª', monitor: 'üñ•Ô∏è', silla: 'ü™ë' };
                    const nameMap = { pc: 'PC Gamer', monitor: 'Monitor', silla: 'Silla' };
                    const itemEl = document.createElement('div');
                    itemEl.className = 'bg-item-bg p-3 rounded-lg text-center';
                    itemEl.innerHTML = `
                        <span class="text-2xl">${itemMap[item] || 'üì¶'}</span>
                        <div class="text-sm font-semibold">${nameMap[item] || item} (x${count})</div>
                    `;
                    myAssetsListEl.appendChild(itemEl);
                });
                
                if (!hasAssets) {
                    myAssetsListEl.innerHTML = '<p class="text-gray-400 text-sm">A√∫n no tienes activos.</p>';
                }
            }
            
            function updateMyOfficeUI() {
                myOfficeLayoutEl.innerHTML = '';
                let hasItems = false;
                 myOfficeItemsCache.forEach((count, item) => {
                    hasItems = true;
                    const itemMap = { pc: 'üíª', monitor: 'üñ•Ô∏è', silla: 'ü™ë' };
                    const nameMap = { pc: 'PC Gamer', monitor: 'Monitor', silla: 'Silla' };
                    for (let i = 0; i < count; i++) {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'text-center p-2';
                        itemEl.innerHTML = `
                            <span class="text-6xl">${itemMap[item] || 'üì¶'}</span>
                            <div class="text-xs font-semibold">${nameMap[item] || item}</div>
                        `;
                        myOfficeLayoutEl.appendChild(itemEl);
                    }
                 });
                 
                 officePlaceholderEl.classList.toggle('hidden', hasItems);
            }
            
            function updateChatUI() {
                chatMessagesListEl.innerHTML = '';
                if (globalChatCache.length === 0) {
                     chatMessagesListEl.innerHTML = '<p class="text-gray-400 text-center">No hay mensajes. ¬°S√© el primero!</p>';
                     return;
                }
                
                globalChatCache.forEach(msg => {
                    const player = allPlayersCache.get(msg.userId) || { username: msg.username, avatarUrl: msg.avatarUrl };
                    const isMe = msg.userId === currentUserId;
                    
                    const msgEl = document.createElement('div');
                    msgEl.className = `flex gap-2 ${isMe ? 'flex-row-reverse' : 'flex-row'}`;
                    
                    msgEl.innerHTML = `
                        <img src="${player.avatarUrl || 'https://via.placeholder.com/32/374151/FFFFFF?text=P'}" alt="avatar" class="w-8 h-8 rounded-full mt-1 flex-shrink-0">
                        <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'}">
                            <span class="text-xs text-gray-400 ${isMe ? 'mr-2' : 'ml-2'}">${player.username}</span>
                            <div class="p-3 rounded-lg ${isMe ? 'bg-solana-purple' : 'bg-item-hover'}">
                                <p class="text-sm">${msg.text}</p>
                            </div>
                        </div>
                    `;
                    chatMessagesListEl.appendChild(msgEl);
                });
                
                // Auto-scroll al fondo
                chatMessagesListEl.scrollTop = chatMessagesListEl.scrollHeight;
            }
            
            // --- L√ìGICA DE GR√ÅFICA (CHART.JS) ---

            function createChartGradient(ctx, color) {
                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                if (color === 'green') {
                    gradient.addColorStop(0, 'rgba(20, 241, 149, 0.5)'); // solana-green
                } else {
                    gradient.addColorStop(0, 'rgba(239, 68, 68, 0.5)'); // red-500
                }
                gradient.addColorStop(1, 'rgba(31, 41, 55, 0)'); // item-bg (transparente)
                return gradient;
            }

            function initChart() {
                // Registrar el plugin de anotaciones
                // CORRECCI√ìN: Usar ChartAnnotation si est√° disponible globalmente
                if (typeof ChartAnnotation !== 'undefined') {
                    Chart.register(ChartAnnotation);
                } else {
                    console.warn("ChartAnnotation plugin no encontrado. Las l√≠neas de compra/venta no funcionar√°n.");
                }
                
                const ctx = document.getElementById('coin-chart-modal').getContext('2d');
                chartGradient = createChartGradient(ctx, 'green'); // Gradiente por defecto
                
                memecoinChart = new Chart(ctx, {
                    type: 'line', 
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'Precio',
                                data: [],
                                borderColor: '#14F195',
                                borderWidth: 2,
                                pointRadius: 0,
                                tension: 0.3,
                                fill: true, // <-- Gr√°fica rellenada
                                backgroundColor: chartGradient, // <-- Gradiente
                                yAxisID: 'yPrice', 
                            },
                            {
                                label: 'Volumen',
                                data: [],
                                backgroundColor: 'rgba(153, 69, 255, 0.4)', 
                                type: 'bar', 
                                yAxisID: 'yVolume', 
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            yPrice: {
                                type: 'linear',
                                position: 'left',
                                ticks: { color: '#9CA3AF', callback: (value) => formatPrice(value) },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            },
                            yVolume: {
                                type: 'linear',
                                position: 'right', 
                                ticks: { display: false }, 
                                grid: { display: false }, 
                                beginAtZero: true
                            },
                            x: {
                                ticks: { display: false },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: { 
                                enabled: true, mode: 'index', intersect: false,
                                callbacks: {
                                    label: (context) => {
                                        if (context.datasetIndex === 0) return `Precio: ${formatPrice(context.parsed.y)}`;
                                        if (context.datasetIndex === 1) return `Volumen: ${formatCurrency(context.parsed.y)}`;
                                        return '';
                                    }
                                }
                            },
                            // Plugin de anotaciones (inicialmente vac√≠o)
                            annotation: {
                                annotations: {}
                            }
                        }
                    }
                });
            }
            
            function updateChart(coinData) {
                if (!memecoinChart) return;
                
                const history = coinData.priceHistory.slice(-50); 
                const volumeHistory = (coinData.volumeHistory || []).slice(-50);
                
                // Actualizar color de la gr√°fica (verde o rojo)
                let newColor = '#14F195';
                let newGradientColor = 'green';
                if (history.length > 1 && history[history.length - 1] < history[history.length - 2]) {
                    newColor = '#EF4444'; // red-500
                    newGradientColor = 'red';
                }
                
                memecoinChart.data.datasets[0].borderColor = newColor;
                memecoinChart.data.datasets[0].backgroundColor = createChartGradient(memecoinChart.ctx, newGradientColor);
                
                memecoinChart.data.labels = history.map((_, i) => i + 1);
                memecoinChart.data.datasets[0].data = history; 
                memecoinChart.data.datasets[1].data = volumeHistory; 
                
                // Actualizar anotaciones de compra/venta
                updateChartAnnotations(coinData.id);
                
                memecoinChart.update('none'); 
            }
            
            function updateChartAnnotations(coinId) {
                if (!memecoinChart || !coinId || typeof ChartAnnotation === 'undefined') return; // Verificar si el plugin est√° cargado
                
                const portfolioItem = myPortfolioCache.get(coinId);
                const tradeHistory = portfolioItem?.tradeHistory || [];
                const annotations = {};
                
                // Promedio de Compra
                const buyTrades = tradeHistory.filter(t => t.type === 'buy' && t.price);
                if (buyTrades.length > 0) {
                    const totalCost = buyTrades.reduce((sum, t) => sum + (t.amountSsol || 0), 0);
                    const totalTokens = buyTrades.reduce((sum, t) => sum + (t.amountToken || 0), 0);
                    const avgBuyPrice = totalCost / totalTokens;
                    
                    if (isFinite(avgBuyPrice) && avgBuyPrice > 0) {
                        annotations['avgBuyLine'] = {
                            type: 'line',
                            yMin: avgBuyPrice,
                            yMax: avgBuyPrice,
                            borderColor: 'rgb(34, 197, 94)', // green-500
                            borderWidth: 2,
                            borderDash: [6, 6],
                            label: {
                                content: `Compra Prom: ${formatPrice(avgBuyPrice)}`,
                                enabled: true,
                                position: 'start',
                                backgroundColor: 'rgba(34, 197, 94, 0.7)',
                                font: { size: 10 },
                                xPadding: 4,
                                yPadding: 4,
                                borderRadius: 4,
                            }
                        };
                    }
                }

                // √öltima Venta
                const lastSellTrade = tradeHistory.filter(t => t.type === 'sell' && t.price).pop();
                if (lastSellTrade) {
                     annotations['lastSellLine'] = {
                        type: 'line',
                        yMin: lastSellTrade.price,
                        yMax: lastSellTrade.price,
                        borderColor: 'rgb(239, 68, 68)', // red-500
                        borderWidth: 2,
                        borderDash: [6, 6],
                        label: {
                            content: `√ölt Venta: ${formatPrice(lastSellTrade.price)}`,
                            enabled: true,
                            position: 'end',
                            backgroundColor: 'rgba(239, 68, 68, 0.7)',
                            font: { size: 10 },
                            xPadding: 4,
                            yPadding: 4,
                            borderRadius: 4,
                        }
                    };
                }

                memecoinChart.options.plugins.annotation.annotations = annotations;
            }


            function updateSelectedCoinPrice(price) {
                modalCoinPriceEl.textContent = `${formatPrice(price)}`;
            }

            // --- ACCIONES DEL JUGADOR ---

            function selectCoin(coinId) {
                selectedCoinId = coinId;
                const coinData = allCoinsCache.get(coinId);
                
                if (!coinData) return;
                
                modalCoinNameEl.textContent = `${coinData.name} (${coinData.symbol})`;
                modalContractIdEl.textContent = `ID de Contrato: ...${coinData.contractId.slice(-6)}`;
                updateSelectedCoinPrice(coinData.currentPrice);
                updateChart(coinData);
                showModal(chartModalEl);
                
                modalLiveBadgeEl.classList.toggle('hidden', !coinData.isLive);
                viewLiveBtnEl.classList.toggle('hidden', !coinData.isLive);
                
                Array.from(memecoinListEl.children).forEach(child => {
                    child.classList.toggle('bg-solana-purple/50', child.dataset.coinId === coinId);
                    child.classList.toggle('bg-item-bg', child.dataset.coinId !== coinId);
                });
            }
            
            // Formulario de Crear Moneda
            createCoinFormEl.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = coinNameEl.value.trim();
                const symbol = coinSymbolEl.value.trim().toUpperCase();
                const imageUrl = coinImageUrlEl.value.trim();
                const xUrl = coinXUrlEl.value.trim();
                const initialSsol = parseFloat(coinInitialSsolEl.value);
                const initialTokens = parseFloat(coinInitialTokensEl.value);
                
                if (!name || !symbol || isNaN(initialSsol) || isNaN(initialTokens) || initialSsol <= 0 || initialTokens <= 0) {
                    showMessage("Por favor, completa todos los campos de liquidez con valores v√°lidos.");
                    return;
                }

                const launchCost = 0.01;
                const totalCost = launchCost + initialSsol;

                try {
                    await runTransaction(db, async (transaction) => {
                        const playerRef = doc(playersRef, currentUserId);
                        // CORRECCI√ìN TRANSACCI√ìN: Leer ANTES de escribir
                        const playerDoc = await transaction.get(playerRef);

                        if (!playerDoc.exists()) throw new Error("No se encontr√≥ tu jugador.");
                        
                        const currentBalance = playerDoc.data().sSOL_balance;
                        if (currentBalance < totalCost) {
                            throw new Error(`Fondos insuficientes. Necesitas ${formatNumber(totalCost)} sSOL (0.01 de fee + ${formatNumber(initialSsol)} de liquidez).`);
                        }
                        
                        // --- INICIO ESCRITURAS ---
                        transaction.update(playerRef, { sSOL_balance: currentBalance - totalCost });
                        
                        const newCoinRef = doc(roomRef); 
                        const price = initialSsol / initialTokens;
                        const creationTime = serverTimestamp(); // Usar para 'createdAt' y 'lastAcquired'
                        
                        transaction.set(newCoinRef, {
                            name: name,
                            symbol: symbol,
                            creatorId: currentUserId,
                            imageUrl: imageUrl || `https://placehold.co/40x40/${newCoinRef.id.slice(0,6)}/FFFFFF?text=${symbol}`,
                            xUrl: xUrl || '', 
                            contractId: newCoinRef.id, 
                            sSolPool: initialSsol, 
                            tokenPool: initialTokens,
                            currentPrice: price,
                            priceHistory: [price],
                            volumeHistory: [0], 
                            allTimeHigh: price, 
                            allTimeLow: price, 
                            createdAt: creationTime, // <-- Ordenar por esto
                            marketCap: initialSsol * 2, // Estimaci√≥n inicial
                            volume: 0,
                            holderCount: 1,
                            lastHolderCountChange: 1, 
                            creatorFeesSsol: 0, 
                            creatorFeesToken: 0, 
                            botSsolPool: 400, // Pool de sSOL del bot
                            botTokenPool: 0, // Pool de Tokens del bot
                            isLive: false,
                            liveViewers: 0,
                            followers: (playerDoc.data().socialFollowers || 0) + 1, // El creador se auto-sigue
                        });

                        // El creador recibe los tokens de liquidez iniciales
                        const walletRef = doc(playersRef, currentUserId, 'wallet', newCoinRef.id);
                        transaction.set(walletRef, {
                            amount: initialTokens,
                            tradeHistory: [],
                            lastAcquired: creationTime // <-- Ordenar por esto
                        });
                        // --- FIN ESCRITURAS ---
                    });
                    
                    hideModal(createCoinModalEl); 
                    showMessage(`¬°Moneda ${name} (${symbol}) lanzada con √©xito!`);
                    createCoinFormEl.reset(); 
                    showPage('page-portafolio'); // Navegar al portafolio

                } catch (error) {
                    console.error("Error al lanzar moneda:", error);
                    showMessage(error.message);
                }
            });

            // --- L√ìGICA DE BOTS (REACTIVA Y PROACTIVA) ---
            
            // Simula un trade de bot (compra o venta)
            function simulateBotTrade(coinData, playerAction, forceBuyProbability = null) {
                
                let { 
                    botSsolPool, botTokenPool, sSolPool, tokenPool, 
                    volume, priceHistory, volumeHistory, creatorId,
                    creatorFeesSsol, creatorFeesToken, marketCap, allTimeHigh, allTimeLow,
                    followers
                } = coinData;

                // El bot no tradea contra s√≠ mismo
                if (creatorId === 'bot') return {};
                
                // Determinar probabilidad de compra
                let buyProbability = 0.6; // Base
                if (playerAction === 'proactive' && forceBuyProbability !== null) {
                    buyProbability = forceBuyProbability;
                }
                
                const isBuy = (Math.random() < buyProbability);

                let ssolTraded = 0;
                let tokensReceived = 0;
                let ssolReceived = 0;
                let finalSsolPool = sSolPool;
                let finalTokenPool = tokenPool;
                let newCreatorFeesSsol = creatorFeesSsol || 0;
                let newCreatorFeesToken = creatorFeesToken || 0;
                let newFollowers = followers || 0;
                let creatorFollowsIncrement = 0; // Para seguir al creador
                
                // Calcular pools y fees (L√≥gica K constante)
                // (x * y = k)
                const k = sSolPool * tokenPool;

                if (isBuy) {
                    // Bot COMPRA tokens (gasta sSOL)
                    const ssolToSpend = (Math.pow(Math.random(), 2) * (botSsolPool * 0.1)); // Gasta hasta 10% de su pool
                    if (ssolToSpend < 0.00000001 || botSsolPool < ssolToSpend) return {};
                    
                    botSsolPool -= ssolToSpend;
                    ssolTraded = ssolToSpend; 
                    
                    // Calcular fees (0.3% total)
                    const totalFeeInSsol = ssolToSpend * TOTAL_FEE;
                    const ssolForTrade = ssolToSpend - totalFeeInSsol;
                    
                    // Calcular tokens recibidos
                    const newSsolPool = sSolPool + ssolForTrade;
                    finalTokenPool = k / newSsolPool;
                    tokensReceived = tokenPool - finalTokenPool;
                    
                    finalSsolPool = newSsolPool;
                    newCreatorFeesSsol += totalFeeInSsol; // Todas las fees (LP+Creator) van al creador
                    
                    botTokenPool += tokensReceived;
                    
                    newFollowers++; // Cada compra de bot a√±ade un seguidor
                    if (Math.random() < 0.3) { // 30% de probabilidad de seguir al creador
                        creatorFollowsIncrement = 1;
                    }
                    
                } else {
                    // Bot VENDE tokens (recibe sSOL)
                    // Vende en parciales peque√±os (max 10%)
                    const sellPercentage = (Math.pow(Math.random(), 2) * 0.1);
                    
                    const tokensToSell = botTokenPool * sellPercentage;
                    if (tokensToSell < 0.00000001) return {};

                    botTokenPool -= tokensToSell;
                    
                    // Calcular fees (0.3% total)
                    const totalFeeInTokens = tokensToSell * TOTAL_FEE;
                    const tokensForTrade = tokensToSell - totalFeeInTokens;

                    // Calcular sSOL recibido
                    const newTokenPool = tokenPool + tokensForTrade;
                    finalSsolPool = k / newTokenPool;
                    ssolReceived = sSolPool - finalSsolPool;
                    ssolTraded = ssolReceived; 

                    finalTokenPool = newTokenPool;
                    newCreatorFeesToken += totalFeeInTokens; // Todas las fees (LP+Creator) van al creador
                    
                    botSsolPool += ssolReceived;
                }

                // Recalcular estado de la moneda
                const newPrice = finalSsolPool / finalTokenPool;
                const newAllTimeHigh = Math.max(allTimeHigh || 0, newPrice);
                const newAllTimeLow = Math.min(allTimeLow || 999999, newPrice); 
                const newMarketCap = newPrice * (finalTokenPool + botTokenPool); // MC = Precio * (Tokens en LP + Tokens de Bot)
                const newHistory = [...priceHistory, newPrice].slice(-50);
                const newVolumeHistory = [...(volumeHistory || []), ssolTraded].slice(-50);
                const newVolume = volume + ssolTraded;

                const updates = {
                    sSolPool: finalSsolPool,
                    tokenPool: finalTokenPool,
                    botSsolPool: botSsolPool,
                    botTokenPool: botTokenPool,
                    currentPrice: newPrice,
                    priceHistory: newHistory,
                    volumeHistory: newVolumeHistory, 
                    volume: newVolume,
                    marketCap: newMarketCap,
                    creatorFeesSsol: newCreatorFeesSsol,
                    creatorFeesToken: newCreatorFeesToken,
                    allTimeHigh: newAllTimeHigh,
                    allTimeLow: newAllTimeLow,
                    creatorFollowsIncrement: creatorFollowsIncrement // Pasar el incremento
                };
                
                if (isBuy) updates.followers = newFollowers;
                
                return updates;
            }
            
            // Loop de Bots Proactivos (simula el mercado)
            async function proactiveBotLoop() {
                if (allCoinsCache.size > 0 && allPlayersCache.size > 0) {
                    
                    for (const [coinId, coin] of allCoinsCache.entries()) {
                        
                        // Probabilidad de que el bot haga un trade en esta moneda
                        let tradeProbability = 0.1; // Base
                        
                        // Probabilidad de que el trade sea una COMPRA
                        let buyProbability = 0.5; // Base
                        
                        const allTimeHigh = coin.allTimeHigh || coin.priceHistory[0] || 0;
                        const currentPrice = coin.currentPrice;

                        // L√≥gica de Hype
                        const priceHistory = coin.priceHistory || [];
                        let priceChange = 0;
                        if (priceHistory.length > 1) {
                            const prevPrice = priceHistory[priceHistory.length - 2];
                            if (prevPrice > 0) priceChange = (coin.currentPrice - prevPrice) / prevPrice;
                        }
                        
                        const creator = allPlayersCache.get(coin.creatorId);
                        const creatorFollowers = creator ? (creator.socialFollowers || 0) : 0;
                        const creatorFollowerScore = Math.min(1.0, creatorFollowers / 1000); // 1000 seguidores = 1.0 score
                        
                        const priceChangeScore = Math.min(1, priceChange / 0.1); 
                        const volumeRatio = (coin.sSolPool > 0) ? (coin.volume || 0) / coin.sSolPool : 0;
                        const volumeScore = Math.min(1, volumeRatio / 10);
                        const holderScore = Math.min(1, (coin.lastHolderCountChange || 0) / 5);
                        const liveScore = coin.isLive ? Math.min(1.0, (coin.liveViewers || 0) / 1000) : 0.0;
                        const followersScore = Math.min(1, (coin.followers || 0) / 1000); 

                        const totalHypeScore = (priceChangeScore + volumeScore + holderScore + (followersScore*1.5) + (liveScore * 2) + (creatorFollowerScore * 2)) / 7.5;
                        
                        tradeProbability = totalHypeScore * 0.5; // Hype alto = m√°s trades

                        if (priceChange > 0) buyProbability = 0.5 + (totalHypeScore * 0.4); // Si sube, m√°s compras
                        else buyProbability = 0.5 - ((1 - totalHypeScore) * 0.4); // Si baja, m√°s ventas
                        
                        
                        if (Math.random() < tradeProbability) {
                            const coinRef = doc(roomRef, coinId);
                            try {
                                await runTransaction(db, async (transaction) => {
                                    // CORRECCI√ìN TRANSACCI√ìN: Leer ANTES de escribir
                                    const coinDoc = await transaction.get(coinRef);
                                    if (!coinDoc.exists()) return;
                                    
                                    const coinData = coinDoc.data();
                                    const botUpdates = simulateBotTrade(coinData, 'proactive', buyProbability); 
                                    
                                    if (Object.keys(botUpdates).length > 0) {
                                        
                                        let creatorRef = null;
                                        let creatorDoc = null;
                                        let randomPlayerRef = null;
                                        let randomPlayerDoc = null;

                                        // Leer ANTES si es necesario seguir
                                        if (botUpdates.creatorFollowsIncrement > 0) {
                                            creatorRef = doc(playersRef, coinData.creatorId);
                                            creatorDoc = await transaction.get(creatorRef);
                                        }
                                        if (Math.random() < 0.1) { // 10% de probabilidad de seguir jugador aleatorio
                                            const randomPlayerId = Array.from(allPlayersCache.keys())[Math.floor(Math.random() * allPlayersCache.size)];
                                            if (randomPlayerId && randomPlayerId !== coinData.creatorId) {
                                                randomPlayerRef = doc(playersRef, randomPlayerId);
                                                randomPlayerDoc = await transaction.get(randomPlayerRef);
                                            }
                                        }

                                        // --- INICIO ESCRITURAS ---
                                        // Incrementar seguidores del creador si el bot decide seguir y el creador existe
                                        if (botUpdates.creatorFollowsIncrement > 0 && creatorDoc && creatorDoc.exists()) {
                                            transaction.update(creatorRef, {
                                                socialFollowers: increment(botUpdates.creatorFollowsIncrement)
                                            });
                                        }
                                        delete botUpdates.creatorFollowsIncrement;
                                        
                                        // Incrementar seguidores de un jugador aleatorio
                                        if (randomPlayerRef && randomPlayerDoc && randomPlayerDoc.exists()) {
                                            transaction.update(randomPlayerRef, { socialFollowers: increment(1) });
                                        }

                                        botUpdates.lastHolderCountChange = 0; // Resetear el contador de holders
                                        transaction.update(coinRef, botUpdates);
                                        // --- FIN ESCRITURAS ---
                                    }
                                });
                            } catch (e) {
                                console.warn("Fallo la transacci√≥n proactiva del bot:", e.message);
                            }
                        }
                    }
                }
                setTimeout(proactiveBotLoop, 5000); // Ejecutar cada 5 segundos
            }

            // --- L√ìGICA DE COMPRA/VENTA (CON IMPACTO DE PRECIO) ---

            // Calcula el impacto de una COMPRA (ssolIn)
            function calculateBuyImpact(ssolIn, sSolPool, tokenPool) {
                const k = sSolPool * tokenPool;
                
                // ssolIn se divide en fee y trade
                const totalFeeInSsol = ssolIn * TOTAL_FEE;
                const ssolForTrade = ssolIn - totalFeeInSsol;
                
                // El pool de sSOL aumenta
                const newSsolPool = sSolPool + ssolForTrade;
                // El pool de tokens disminuye para mantener K
                const newTokenPool = k / newSsolPool;
                
                const tokensOut = tokenPool - newTokenPool;
                
                // El precio despu√©s de tu compra
                const newPrice = newSsolPool / newTokenPool;
                
                return {
                    tokensOut: tokensOut, // Tokens que recibe el jugador
                    newSsolPool: newSsolPool,
                    newTokenPool: newTokenPool,
                    newPrice: newPrice,
                    feesCollectedSsol: totalFeeInSsol, // Fees para el creador
                    ssolTraded: ssolIn // Volumen
                };
            }

            // Calcula el impacto de una VENTA (tokensIn)
            function calculateSellImpact(tokensIn, sSolPool, tokenPool) {
                const k = sSolPool * tokenPool;
                
                // tokensIn se divide en fee y trade
                const totalFeeInTokens = tokensIn * TOTAL_FEE;
                const tokensForTrade = tokensIn - totalFeeInTokens;
                
                // El pool de tokens aumenta
                const newTokenPool = tokenPool + tokensForTrade;
                // El pool de sSOL disminuye para mantener K
                const newSsolPool = k / newTokenPool;
                
                const ssolOut = sSolPool - newSsolPool;
                
                // El precio despu√©s de tu venta
                const newPrice = newSsolPool / newTokenPool;
                
                return {
                    ssolOut: ssolOut, // sSOL que recibe el jugador
                    newSsolPool: newSsolPool,
                    newTokenPool: newTokenPool,
                    newPrice: newPrice,
                    feesCollectedToken: totalFeeInTokens, // Fees para el creador
                    ssolTraded: ssolOut // Volumen (en sSOL)
                };
            }


            // Formulario de Compra
            buyFormEl.addEventListener('submit', async (e) => {
                e.preventDefault();
                const ssolToSpend = parseFloat(buyAmountEl.value);
                if (!selectedCoinId || isNaN(ssolToSpend) || ssolToSpend <= 0) return showMessage("Ingresa un monto v√°lido.");
                
                let tradeResult; // Declara fuera para el mensaje
                try {
                    await runTransaction(db, async (transaction) => {
                        const playerRef = doc(playersRef, currentUserId);
                        const coinRef = doc(roomRef, selectedCoinId);
                        const walletRef = doc(playersRef, currentUserId, 'wallet', selectedCoinId);
                        // CORRECCI√ìN TRANSACCI√ìN: Leer creador ANTES si es necesario
                        let creatorRef = null; 
                        let creatorDoc = null; 

                        // --- INICIO LECTURAS ---
                        const [playerDoc, coinDoc, walletDoc] = await Promise.all([
                            transaction.get(playerRef), 
                            transaction.get(coinRef), 
                            transaction.get(walletRef) 
                        ]);
                        
                        if (!playerDoc.exists() || !coinDoc.exists()) throw new Error("Datos no encontrados.");
                        
                        let playerData = playerDoc.data();
                        let coinData = coinDoc.data();
                        
                        if (playerData.sSOL_balance < ssolToSpend) throw new Error("sSOL insuficiente.");
                        
                        // Determinar si es la primera compra para leer creador
                        const currentTokens = walletDoc.exists() ? walletDoc.data().amount : 0;
                        let creatorFollowsIncrement = 0;
                        if (currentTokens < 0.00000001) { // Primera compra
                            creatorFollowsIncrement = 1;
                            creatorRef = doc(playersRef, coinData.creatorId);
                            creatorDoc = await transaction.get(creatorRef); // Leer creador ahora
                        }
                        // --- FIN LECTURAS ---

                        // 1. Simular trade de bot (reactivo)
                        const botUpdates = simulateBotTrade(coinData, 'reactive_buy');
                        coinData = { ...coinData, ...botUpdates };
                        
                        // 2. Calcular el impacto de PRECIO del JUGADOR
                        tradeResult = calculateBuyImpact(ssolToSpend, coinData.sSolPool, coinData.tokenPool);
                        
                        if (tradeResult.tokensOut <= 0) throw new Error("Error en el c√°lculo del trade.");

                        // 3. Preparar actualizaciones (esto no escribe a√∫n)
                        const newPrice = tradeResult.newPrice;
                        const newAllTimeHigh = Math.max(coinData.allTimeHigh || 0, newPrice); 
                        const newAllTimeLow = Math.min(coinData.allTimeLow || 999999, newPrice);
                        const newMarketCap = newPrice * (tradeResult.newTokenPool + coinData.botTokenPool);
                        const newHistory = [...coinData.priceHistory, newPrice].slice(-50);
                        const newVolumeHistory = [...(coinData.volumeHistory || []), tradeResult.ssolTraded].slice(-50);
                        const newVolume = coinData.volume + tradeResult.ssolTraded;
                        const newCreatorFeesSsol = (coinData.creatorFeesSsol || 0) + tradeResult.feesCollectedSsol;

                        let newHolderCount = coinData.holderCount;
                        let holderChange = 0;
                        let newFollowers = coinData.followers || 0;
                        
                        if (creatorFollowsIncrement > 0) { // Si era primera compra
                            newHolderCount++;
                            holderChange = 1; 
                            newFollowers++; 
                        }
                        const newLastHolderCountChange = (coinData.lastHolderCountChange || 0) + holderChange;
                        
                        const playerTradeHistory = walletDoc.exists() ? walletDoc.data().tradeHistory || [] : [];
                        const updatedTradeHistory = [...playerTradeHistory, { 
                            type: 'buy', price: newPrice, amountSsol: ssolToSpend, amountToken: tradeResult.tokensOut, timestamp: new Date()
                        }].slice(-50); 

                        // 4. Ejecutar ESCRITURAS
                        
                        // Actualizar Jugador
                        transaction.update(playerRef, { sSOL_balance: playerData.sSOL_balance - ssolToSpend });
                        
                        // Actualizar Billetera
                        transaction.set(walletRef, { 
                            amount: currentTokens + tradeResult.tokensOut, 
                            tradeHistory: updatedTradeHistory,
                            lastAcquired: serverTimestamp() 
                        }, { merge: true });
                        
                        // Incrementar seguidores del creador (si era primera compra y existe)
                        if (creatorFollowsIncrement > 0 && creatorDoc && creatorDoc.exists()) {
                            transaction.update(creatorRef, { socialFollowers: increment(creatorFollowsIncrement) });
                        }
                        
                        // CORRECCI√ìN TRANSACCI√ìN: Incrementar seguidores del creador (si el bot sigui√≥)
                        // Esta lectura se movi√≥ a proactiveBotLoop, pero la dejamos aqu√≠ por si acaso
                        // y la envolvemos en una comprobaci√≥n
                        if (botUpdates.creatorFollowsIncrement > 0) {
                            const botCreatorRef = doc(playersRef, coinData.creatorId);
                            // Leemos aqu√≠ DENTRO de la transacci√≥n porque botUpdates es calculado ahora
                            const botCreatorDoc = await transaction.get(botCreatorRef); 
                            if (botCreatorDoc.exists()) {
                                transaction.update(botCreatorRef, { socialFollowers: increment(botUpdates.creatorFollowsIncrement) });
                            }
                        }
                        delete botUpdates.creatorFollowsIncrement; // Eliminar para no afectar la escritura final
                        
                        // Actualizar Moneda
                        transaction.update(coinRef, {
                             ...botUpdates, // Aplicar updates del bot
                            sSolPool: tradeResult.newSsolPool, 
                            tokenPool: tradeResult.newTokenPool,
                            currentPrice: newPrice, 
                            priceHistory: newHistory,
                            volume: newVolume, 
                            volumeHistory: newVolumeHistory,
                            marketCap: newMarketCap, 
                            holderCount: newHolderCount,
                            lastHolderCountChange: newLastHolderCountChange,
                            creatorFeesSsol: newCreatorFeesSsol,
                            allTimeHigh: newAllTimeHigh, 
                            allTimeLow: newAllTimeLow,
                            followers: newFollowers
                        });
                        // --- FIN ESCRITURAS ---
                    });
                    
                    showMessage(`¬°Compraste ${formatNumber(tradeResult.tokensOut)} ${allCoinsCache.get(selectedCoinId).symbol}!`);
                    buyAmountEl.value = '';

                } catch (error) {
                    console.error("Error al comprar:", error);
                    showMessage(error.message);
                }
            });
            
            // Formulario de Venta
            sellFormEl.addEventListener('submit', async (e) => {
                e.preventDefault();
                const tokensToSellInput = parseDecimalInput(sellAmountEl.value);
                
                if (!selectedCoinId || isNaN(tokensToSellInput) || tokensToSellInput <= 0) return showMessage("Ingresa un monto v√°lido.");

                let ssolReceived = 0; // Para el mensaje de √©xito
                try {
                    await runTransaction(db, async (transaction) => {
                        const playerRef = doc(playersRef, currentUserId);
                        const coinRef = doc(roomRef, selectedCoinId);
                        const walletRef = doc(playersRef, currentUserId, 'wallet', selectedCoinId);
                        // CORRECCI√ìN TRANSACCI√ìN: Referencia al creador (para fees del bot)
                        let botCreatorRef = null;
                        let botCreatorDoc = null; 

                        // --- INICIO LECTURAS ---
                        const [playerDoc, coinDoc, walletDoc] = await Promise.all([
                            transaction.get(playerRef), 
                            transaction.get(coinRef), 
                            transaction.get(walletRef)
                        ]);

                        if (!playerDoc.exists() || !coinDoc.exists()) throw new Error("Datos no encontrados.");
                        
                        const walletData = walletDoc.exists() ? walletDoc.data() : { amount: 0 };
                        if (!walletDoc.exists() || walletData.amount < (tokensToSellInput - 0.000001)) {
                            throw new Error(`No tienes suficientes tokens. Tienes: ${formatNumber(walletData.amount)}`);
                        }
                        
                        const finalTokensToSell = Math.min(tokensToSellInput, walletData.amount);
                        let playerData = playerDoc.data();
                        let coinData = coinDoc.data();

                        // 1. Simular trade de bot (reactivo) y leer creador si es necesario
                        const botUpdates = simulateBotTrade(coinData, 'reactive_sell');
                        if (botUpdates.creatorFollowsIncrement > 0) {
                            botCreatorRef = doc(playersRef, coinData.creatorId);
                            botCreatorDoc = await transaction.get(botCreatorRef);
                        }
                        coinData = { ...coinData, ...botUpdates }; // Aplicar updates despu√©s de la lectura
                        
                        // 2. Calcular el impacto de PRECIO del JUGADOR
                        const tradeResult = calculateSellImpact(finalTokensToSell, coinData.sSolPool, coinData.tokenPool);
                        
                        ssolReceived = tradeResult.ssolOut; // Guardar para el mensaje
                        if (ssolReceived <= 0) throw new Error("Liquidez demasiado baja para vender.");
                        
                        // 3. Preparar actualizaciones (no escribe a√∫n)
                        const newPrice = tradeResult.newPrice;
                        const newAllTimeHigh = Math.max(coinData.allTimeHigh || 0, newPrice);
                        const newAllTimeLow = Math.min(coinData.allTimeLow || 999999, newPrice); 
                        const newMarketCap = newPrice * (tradeResult.newTokenPool + coinData.botTokenPool);
                        const newHistory = [...coinData.priceHistory, newPrice].slice(-50);
                        const newVolumeHistory = [...(coinData.volumeHistory || []), tradeResult.ssolTraded].slice(-50);
                        const newVolume = coinData.volume + tradeResult.ssolTraded;
                        const newCreatorFeesToken = (coinData.creatorFeesToken || 0) + tradeResult.feesCollectedToken;

                        let newHolderCount = coinData.holderCount;
                        let holderChange = 0;
                        const currentTokens = walletData.amount;
                        const newAmountInWallet = currentTokens - finalTokensToSell;
                        if (newAmountInWallet < 0.00000001 && currentTokens >= 0.00000001) { 
                            newHolderCount--;
                            holderChange = -1; 
                        }
                        const newLastHolderCountChange = (coinData.lastHolderCountChange || 0) + holderChange;

                        const playerTradeHistory = walletData.tradeHistory || [];
                        const updatedTradeHistory = [...playerTradeHistory, { 
                            type: 'sell', price: newPrice, amountSsol: ssolReceived, amountToken: finalTokensToSell, timestamp: new Date()
                        }].slice(-50);
                        
                        // 4. Ejecutar ESCRITURAS
                        
                        // Actualizar Jugador
                        transaction.update(playerRef, { sSOL_balance: playerData.sSOL_balance + ssolReceived });
                        
                        // Actualizar Billetera
                        transaction.set(walletRef, { 
                            amount: newAmountInWallet, 
                            tradeHistory: updatedTradeHistory,
                            lastAcquired: serverTimestamp() 
                        }, { merge: true });
                        
                        // Incrementar seguidores del creador (si el bot sigui√≥ y existe)
                        if (botUpdates.creatorFollowsIncrement > 0 && botCreatorDoc && botCreatorDoc.exists()) {
                            transaction.update(botCreatorRef, { socialFollowers: increment(botUpdates.creatorFollowsIncrement) });
                        }
                        delete botUpdates.creatorFollowsIncrement; // No escribirlo en la moneda
                        
                        // Actualizar Moneda
                        transaction.update(coinRef, {
                             ...botUpdates, 
                            sSolPool: tradeResult.newSsolPool, 
                            tokenPool: tradeResult.newTokenPool,
                            currentPrice: newPrice, 
                            priceHistory: newHistory,
                            volume: newVolume, 
                            volumeHistory: newVolumeHistory,
                            marketCap: newMarketCap, 
                            holderCount: newHolderCount,
                            lastHolderCountChange: newLastHolderCountChange,
                            creatorFeesToken: newCreatorFeesToken,
                            allTimeHigh: newAllTimeHigh, 
                            allTimeLow: newAllTimeLow
                        });
                         // --- FIN ESCRITURAS ---
                    });
                    
                    showMessage(`¬°Vendiste ${formatNumber(tokensToSellInput)} ${allCoinsCache.get(selectedCoinId).symbol} por ${formatNumber(ssolReceived)} sSOL!`);
                    sellAmountEl.value = '';

                } catch (error) {
                    console.error("Error al vender:", error);
                    showMessage(error.message);
                }
            });
            
            document.querySelectorAll('.sell-percent-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const percent = parseFloat(btn.dataset.percent);
                    const coin = myPortfolioCache.get(selectedCoinId);
                    if (coin) {
                        // CORRECCI√ìN: Redondear a 2 decimales para evitar errores
                        sellAmountEl.value = (coin.amount * percent).toFixed(2);
                    } else {
                        showMessage("No tienes esta moneda.");
                        sellAmountEl.value = '0';
                    }
                });
            });
            
            // --- NUEVAS FUNCIONES: P2P, PANEL DE CREADOR, TIENDA, SOCIALFI, CHAT ---
            
            sendSsolFormEl.addEventListener('submit', async (e) => {
                e.preventDefault();
                const amountToSend = parseFloat(sendSsolAmountEl.value);
                if (!targetPlayerId || isNaN(amountToSend) || amountToSend <= 0) return showMessage("Monto inv√°lido.");
                
                try {
                    await runTransaction(db, async (transaction) => {
                        const senderRef = doc(playersRef, currentUserId);
                        const receiverRef = doc(playersRef, targetPlayerId);
                        // CORRECCI√ìN TRANSACCI√ìN: Leer ANTES
                        const [senderDoc, receiverDoc] = await Promise.all([ 
                            transaction.get(senderRef), 
                            transaction.get(receiverRef) 
                        ]);
                        if (!senderDoc.exists() || !receiverDoc.exists()) throw new Error("Datos no encontrados.");
                        const senderData = senderDoc.data();
                        if (senderData.sSOL_balance < amountToSend) throw new Error("sSOL insuficiente.");
                        
                        // --- INICIO ESCRITURAS ---
                        transaction.update(senderRef, { sSOL_balance: increment(-amountToSend) });
                        transaction.update(receiverRef, { sSOL_balance: increment(amountToSend) });
                         // --- FIN ESCRITURAS ---
                    });
                    
                    showMessage(`¬°Enviaste ${formatNumber(amountToSend)} sSOL a ${allPlayersCache.get(targetPlayerId)?.username || '...'}!`);
                    hideModal(sendSsolModalEl);
                    sendSsolFormEl.reset();
                    
                } catch (error) {
                    console.error("Error al enviar sSOL:", error);
                    showMessage(error.message);
                }
            });
            
            function showCreatorDashboard() {
                creatorCoinsListEl.innerHTML = '';
                let hasCoins = false;
                
                // Ordenar monedas por fecha de creaci√≥n (m√°s nuevas primero)
                const myCoins = Array.from(allCoinsCache.values())
                    .filter(coin => coin.creatorId === currentUserId)
                    .sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));

                myCoins.forEach(coin => {
                    hasCoins = true;
                    const itemEl = document.createElement('div');
                    itemEl.className = 'bg-item-hover p-3 rounded-lg';
                    itemEl.innerHTML = `
                        <div class="flex justify-between items-center mb-3">
                            <span class="font-semibold text-lg">${coin.name} (${coin.symbol})</span>
                            <button data-coin-id="${coin.id}" class="go-live-btn ${coin.isLive ? 'bg-gray-600' : 'bg-red-600 hover:bg-red-700'} text-white font-bold py-2 px-3 rounded-md text-sm transition">
                                ${coin.isLive ? 'EN VIVO' : 'Ir en Vivo'}
                            </button>
                        </div>
                        <div class="bg-gray-700/50 p-3 rounded-lg">
                            <h4 class="font-semibold mb-2">Comisiones (Fees) Ganadas</h4>
                            <div class="text-sm text-gray-300">sSOL: <span id="fee-ssol-${coin.id}">${formatNumber(coin.creatorFeesSsol)}</span></div>
                            <div class="text-sm text-gray-300">${coin.symbol}: <span id="fee-token-${coin.id}">${formatNumber(coin.creatorFeesToken)}</span></div>
                            <button data-coin-id="${coin.id}" class="claim-fee-btn w-full mt-2 bg-solana-green text-gray-900 font-bold py-2 px-3 rounded-md text-sm hover:bg-opacity-80 transition">Reclamar Fees</button>
                        </div>
                    `;
                    creatorCoinsListEl.appendChild(itemEl);
                });
                
                if (!hasCoins) creatorCoinsListEl.innerHTML = '<p class="text-gray-400 text-center">No has creado ninguna moneda.</p>';
                
                creatorCoinsListEl.querySelectorAll('.claim-fee-btn').forEach(btn => btn.addEventListener('click', (e) => claimFees(e.target.dataset.coinId, e.target)));
                creatorCoinsListEl.querySelectorAll('.go-live-btn').forEach(btn => btn.addEventListener('click', (e) => toggleLive(e.target.dataset.coinId, e.target)));
                
                showModal(creatorDashboardModalEl);
            }
            
            async function claimFees(coinId, btn) {
                const coin = allCoinsCache.get(coinId);
                if (!coin || (coin.creatorFeesSsol < 0.00000001 && coin.creatorFeesToken < 0.00000001)) return showMessage("No hay comisiones que reclamar.");
                
                btn.disabled = true; btn.textContent = '...';
                const ssolToClaim = coin.creatorFeesSsol; const tokensToClaim = coin.creatorFeesToken;
                
                try {
                    await runTransaction(db, async (transaction) => {
                        const coinRef = doc(roomRef, coinId);
                        const playerRef = doc(playersRef, currentUserId);
                        const walletRef = doc(playersRef, currentUserId, 'wallet', coinId);
                        // CORRECCI√ìN TRANSACCI√ìN: Leer ANTES
                        const [coinDoc, playerDoc, walletDoc] = await Promise.all([
                            transaction.get(coinRef), 
                            transaction.get(playerRef), 
                            transaction.get(walletRef)
                        ]);
                        if (!coinDoc.exists() || !playerDoc.exists()) throw new Error("Datos no encontrados.");
                        
                        // --- INICIO ESCRITURAS ---
                        const walletData = walletDoc.exists() ? walletDoc.data() : { amount: 0, tradeHistory: [] };
                        
                        transaction.update(coinRef, { creatorFeesSsol: 0, creatorFeesToken: 0 });
                        transaction.update(playerRef, { sSOL_balance: increment(ssolToClaim) });
                        transaction.set(walletRef, { 
                            amount: (walletData.amount || 0) + tokensToClaim,
                            lastAcquired: serverTimestamp() // Actualizar para ordenar
                        }, { merge: true });
                        // --- FIN ESCRITURAS ---
                    });
                    showMessage("¬°Comisiones reclamadas!");
                    btn.textContent = "Reclamado";
                } catch (e) {
                    showMessage(e.message);
                    btn.disabled = false; btn.textContent = "Reclamar";
                }
            }
            
            // toggleLive no necesita transacci√≥n porque solo escribe en un documento
            async function toggleLive(coinId, btn) {
                const coin = allCoinsCache.get(coinId);
                const newState = !coin.isLive;
                btn.disabled = true; btn.textContent = '...';
                
                try {
                    const coinRef = doc(roomRef, coinId);
                    const initialViewers = newState ? 50 + Math.floor(Math.random() * 50) : 0;
                    const initialFollowers = newState ? (coin.followers || 0) + 5 + Math.floor(Math.random() * 10) : coin.followers;
                    await updateDoc(coinRef, { isLive: newState, liveViewers: initialViewers, followers: initialFollowers });
                    
                    showMessage(newState ? "¬°Est√°s en vivo!" : "Directo finalizado.");
                    btn.textContent = newState ? "EN VIVO" : "Ir en Vivo";
                    btn.classList.toggle('bg-gray-600', newState); btn.classList.toggle('bg-red-600', !newState);
                    btn.disabled = false;
                } catch (e) { showMessage(e.message); btn.disabled = false; }
            }
            
            function showLiveStream() {
                if (!selectedCoinId) return;
                const coin = allCoinsCache.get(selectedCoinId); if (!coin) return;
                liveCoinNameEl.textContent = `LIVE: ${coin.name}`;
                liveViewersEl.textContent = formatNumber(coin.liveViewers || 0);
                showModal(liveStreamModalEl);
                
                const coinRef = doc(roomRef, selectedCoinId);
                onSnapshot(coinRef, (doc) => {
                    if (doc.exists() && doc.data().isLive) {
                        liveViewersEl.textContent = formatNumber(doc.data().liveViewers || 0);
                    } else {
                        hideModal(liveStreamModalEl);
                    }
                });
            }
            
            async function boostLiveStream(level) {
                if (!selectedCoinId) return;
                let boostCost = 0, viewerBonus = 0, followerBonus = 0;
                switch (level) {
                    case 'small':  boostCost = 0.1; viewerBonus = 100 + Math.floor(Math.random() * 100); followerBonus = 10 + Math.floor(Math.random() * 20); break;
                    case 'medium': boostCost = 1;   viewerBonus = 500 + Math.floor(Math.random() * 500); followerBonus = 50 + Math.floor(Math.random() * 50); break;
                    case 'large':  boostCost = 10;  viewerBonus = 2000 + Math.floor(Math.random() * 3000); followerBonus = 200 + Math.floor(Math.random() * 300); break;
                    default: return showMessage("Nivel de boost inv√°lido.");
                }
                
                const btn = document.querySelector(`.boost-live-btn[data-boost-level="${level}"]`);
                if (btn) { btn.disabled = true; btn.textContent = '...'; }
                
                try {
                    await runTransaction(db, async (transaction) => {
                        const playerRef = doc(playersRef, currentUserId); 
                        const coinRef = doc(roomRef, selectedCoinId);
                         // CORRECCI√ìN TRANSACCI√ìN: Leer ANTES
                        const [playerDoc, coinDoc] = await Promise.all([ 
                            transaction.get(playerRef), 
                            transaction.get(coinRef) 
                        ]);
                        if (!playerDoc.exists() || !coinDoc.exists()) throw new Error("Datos no encontrados.");
                        if (playerDoc.data().sSOL_balance < boostCost) throw new Error("sSOL insuficiente.");
                        
                        // --- INICIO ESCRITURAS ---
                        transaction.update(playerRef, { sSOL_balance: increment(-boostCost) });
                        transaction.update(coinRef, { 
                            liveViewers: increment(viewerBonus),
                            followers: increment(followerBonus)
                        });
                         // --- FIN ESCRITURAS ---
                    });
                    showMessage(`¬°Boost (${level}) aplicado!`);
                } catch (e) { showMessage(e.message); }
                if (btn) { btn.disabled = false; btn.textContent = `Boost (${boostCost} sSOL)`; }
            }
            
            // Botones de la Tienda (Lujo y Oficina)
            document.querySelectorAll('.buy-asset-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const item = e.target.dataset.item; 
                    const cost = parseFloat(e.target.dataset.cost);
                    const category = e.target.dataset.category; // 'luxury' o 'office'
                    
                    e.target.disabled = true; e.target.textContent = '...';
                    
                    try {
                        await runTransaction(db, async (transaction) => {
                            const playerRef = doc(playersRef, currentUserId);
                            // CORRECCI√ìN TRANSACCI√ìN: Leer ANTES
                            const playerDoc = await transaction.get(playerRef);
                            if (!playerDoc.exists()) throw new Error("No se encontr√≥ al jugador.");
                            if (playerDoc.data().sSOL_balance < cost) throw new Error("sSOL insuficiente.");
                            
                            // --- INICIO ESCRITURAS ---
                            let updateField = `assets.${item}`; // Lujo por defecto
                            if (category === 'office') {
                                updateField = `officeItems.${item}`; // Campo de Oficina
                            }
                            
                            transaction.update(playerRef, {
                                sSOL_balance: increment(-cost),
                                [updateField]: increment(1)
                            });
                             // --- FIN ESCRITURAS ---
                        });
                        showMessage(`¬°Felicidades! ¬°Compraste un ${item}!`);
                    } catch (e) { showMessage(e.message); }
                    e.target.disabled = false; e.target.textContent = 'Comprar';
                });
            });

            // editSocialProfileForm no necesita transacci√≥n (solo escribe en un doc)
            editSocialProfileFormEl.addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = socialUsernameInputEl.value.trim();
                const avatarUrl = socialAvatarInputEl.value.trim();
                if (!username) return showMessage("El nombre de usuario no puede estar vac√≠o.");

                try {
                    const playerRef = doc(playersRef, currentUserId);
                    await updateDoc(playerRef, {
                        username: username,
                        avatarUrl: avatarUrl || `https://placehold.co/60/374151/FFFFFF?text=${username.slice(0,1)}`
                    });
                    showMessage("Perfil actualizado.");
                    hideModal(myProfileModalEl);
                } catch (error) { showMessage("Error al actualizar perfil."); }
            });

            // createSocialPostForm no necesita transacci√≥n (solo crea un doc)
            createSocialPostFormEl.addEventListener('submit', async (e) => {
                e.preventDefault();
                const postText = socialPostTextEl.value.trim();
                if (!postText) return showMessage("El post no puede estar vac√≠o.");

                try {
                    const player = allPlayersCache.get(currentUserId);
                    await addDoc(socialPostsRef, {
                        userId: currentUserId,
                        username: player.username, 
                        avatarUrl: player.avatarUrl, 
                        text: postText,
                        createdAt: serverTimestamp(),
                        likes: 0,
                        boosted: false 
                    });
                    showMessage("Post publicado.");
                    hideModal(createSocialPostModalEl);
                    createSocialPostFormEl.reset();
                    showPage('page-social'); 
                } catch (error) { showMessage("Error al publicar post."); }
            });
            
             // sendChatMessageForm no necesita transacci√≥n (solo crea un doc)
            sendChatMessageFormEl.addEventListener('submit', async (e) => {
                e.preventDefault();
                const text = chatMessageInputEl.value.trim();
                if (!text) return;
                
                chatMessageInputEl.value = '';
                
                try {
                    const player = allPlayersCache.get(currentUserId);
                    await addDoc(chatMessagesRef, {
                        userId: currentUserId,
                        username: player.username,
                        avatarUrl: player.avatarUrl,
                        text: text,
                        timestamp: serverTimestamp()
                    });
                } catch (error) {
                    console.error("Error al enviar mensaje:", error);
                    chatMessageInputEl.value = text; // Devolver el texto si falla
                }
            });
            
            async function promotePost(postId, btn) {
                btn.disabled = true; btn.textContent = '...';
                try {
                    await runTransaction(db, async (transaction) => {
                        const playerRef = doc(playersRef, currentUserId);
                        const postRef = doc(socialPostsRef, postId);
                         // CORRECCI√ìN TRANSACCI√ìN: Leer ANTES
                        const playerDoc = await transaction.get(playerRef);
                        // No necesitamos leer el post, solo verificar el balance
                        
                        if (!playerDoc.exists()) throw new Error("No se encontr√≥ al jugador.");
                        if (playerDoc.data().sSOL_balance < PROMO_POST_COST) throw new Error(`sSOL insuficiente. Necesitas ${PROMO_POST_COST}.`);
                        
                        // --- INICIO ESCRITURAS ---
                        transaction.update(playerRef, { sSOL_balance: increment(-PROMO_POST_COST) });
                        transaction.update(postRef, { boosted: true });
                         // --- FIN ESCRITURAS ---
                    });
                    showMessage("¬°Post promocionado!");
                } catch (e) {
                    showMessage(e.message);
                    btn.disabled = false; btn.textContent = `Promocionar (0.2 sSOL)`;
                }
            }
            
            // showPlayerProfile no necesita transacci√≥n (solo lee)
            async function showPlayerProfile(playerId) {
                if (playerId === currentUserId) {
                    showMyProfileBtn.click();
                    return;
                }
                
                selectedProfilePlayerId = playerId;
                const player = allPlayersCache.get(playerId);
                if (!player) return showMessage("No se encontr√≥ al jugador.");
                
                playerProfileUsernameEl.textContent = player.username;
                playerProfileAvatarEl.src = player.avatarUrl || 'https://via.placeholder.com/60/374151/FFFFFF?text=P';
                playerProfileFollowersEl.textContent = formatNumber(player.socialFollowers || 0);
                
                updateFollowButton();
                
                playerProfilePostsEl.innerHTML = '<p class="text-gray-400 text-sm">Cargando posts...</p>';
                playerProfileCreatedCoinsEl.innerHTML = '<p class="text-gray-400 text-sm">Cargando monedas...</p>';
                showModal(playerProfileModalEl);
                
                // Cargar Monedas Creadas
                const createdCoins = Array.from(allCoinsCache.values())
                    .filter(coin => coin.creatorId === playerId)
                    .sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
                    
                playerProfileCreatedCoinsEl.innerHTML = '';
                if (createdCoins.length === 0) {
                    playerProfileCreatedCoinsEl.innerHTML = '<p class="text-gray-400 text-sm">Este jugador no ha creado monedas.</p>';
                } else {
                    createdCoins.forEach(coin => {
                        const coinEl = document.createElement('div');
                        coinEl.className = 'bg-item-hover p-2 rounded-lg text-sm flex gap-2 items-center';
                        coinEl.innerHTML = `
                            <img src="${coin.imageUrl || 'https://via.placeholder.com/24/374151/FFFFFF?text=C'}" alt="coin" class="w-6 h-6 rounded-full">
                            <span class="font-semibold">${coin.name} (${coin.symbol})</span>
                        `;
                        playerProfileCreatedCoinsEl.appendChild(coinEl);
                    });
                }
                
                // Cargar Posts
                const postsQuery = query(socialPostsRef, orderBy('createdAt', 'desc'), limit(10));
                const postsSnapshot = await getDocs(postsQuery);
                playerProfilePostsEl.innerHTML = '';
                let hasPosts = false;
                postsSnapshot.forEach(doc => {
                    if (doc.data().userId === playerId) {
                        hasPosts = true;
                        const post = doc.data();
                        const postEl = document.createElement('div');
                        postEl.className = 'bg-item-hover p-3 rounded-lg text-sm';
                        postEl.innerHTML = `
                            <p>${post.text}</p>
                            <p class="text-xs text-gray-500 mt-2">${new Date(post.createdAt.toDate()).toLocaleString()}</p>
                        `;
                        playerProfilePostsEl.appendChild(postEl);
                    }
                });
                if (!hasPosts) playerProfilePostsEl.innerHTML = '<p class="text-gray-400 text-sm">Este jugador no tiene posts.</p>';
            }
            
            function updateFollowButton() {
                if (myFollowsCache.has(selectedProfilePlayerId)) {
                    followPlayerBtn.textContent = "Dejar de Seguir";
                    followPlayerBtn.classList.remove('bg-x-blue');
                    followPlayerBtn.classList.add('bg-gray-600');
                } else {
                    followPlayerBtn.textContent = "Seguir";
                    followPlayerBtn.classList.add('bg-x-blue');
                    followPlayerBtn.classList.remove('bg-gray-600');
                }
            }
            
            followPlayerBtn.addEventListener('click', async () => {
                if (!selectedProfilePlayerId) return;
                
                followPlayerBtn.disabled = true;
                const isFollowing = myFollowsCache.has(selectedProfilePlayerId);
                
                try {
                    await runTransaction(db, async (transaction) => {
                        const myPlayerRef = doc(playersRef, currentUserId);
                        const targetPlayerRef = doc(playersRef, selectedProfilePlayerId);
                        
                         // CORRECCI√ìN TRANSACCI√ìN: Leer ANTES
                        const myPlayerDoc = await transaction.get(myPlayerRef);
                        // No necesitamos leer targetPlayerDoc aqu√≠ si solo usamos increment
                        
                        if (!myPlayerDoc.exists()) throw new Error("No se encontr√≥ tu perfil.");
                        
                        // --- INICIO ESCRITURAS ---
                        const currentFollows = myPlayerDoc.data().following || [];
                        
                        if (isFollowing) {
                            const newFollows = currentFollows.filter(id => id !== selectedProfilePlayerId);
                            transaction.update(myPlayerRef, { following: newFollows });
                            transaction.update(targetPlayerRef, { socialFollowers: increment(-1) });
                            myFollowsCache.delete(selectedProfilePlayerId); // Actualizar cach√© local
                        } else {
                            const newFollows = [...currentFollows, selectedProfilePlayerId];
                            transaction.update(myPlayerRef, { following: newFollows });
                            transaction.update(targetPlayerRef, { socialFollowers: increment(1) });
                            myFollowsCache.add(selectedProfilePlayerId); // Actualizar cach√© local
                        }
                         // --- FIN ESCRITURAS ---
                    });
                    
                    updateFollowButton();
                    // Actualizar UI localmente
                    const targetPlayer = allPlayersCache.get(selectedProfilePlayerId);
                    if (targetPlayer) {
                        const newFollowerCount = (targetPlayer.socialFollowers || 0) + (isFollowing ? -1 : 1);
                        playerProfileFollowersEl.textContent = formatNumber(newFollowerCount);
                        allPlayersCache.set(selectedProfilePlayerId, { ...targetPlayer, socialFollowers: newFollowerCount });
                    }

                } catch (e) {
                    showMessage("Error al seguir/dejar de seguir.");
                }
                followPlayerBtn.disabled = false;
            });

             // launchSocialFiCoin no necesita transacci√≥n (solo lee)
            launchSocialFiCoinBtn.addEventListener('click', () => {
                const player = allPlayersCache.get(currentUserId);
                if (player && (player.socialFollowers || 0) >= 50) {
                    coinNameEl.value = `${player.username || 'Mi'} Coin`;
                    coinSymbolEl.value = (player.username || 'ME').slice(0,5).toUpperCase();
                    coinImageUrlEl.value = player.avatarUrl || '';
                    hideModal(myProfileModalEl);
                    showModal(createCoinModalEl);
                } else {
                    showMessage("Necesitas al menos 50 seguidores.");
                }
            });
            
            // --- L√≥gica de PnL ---
             // showPnlModal no necesita transacci√≥n (solo lee)
            function showPnlModal(coinId) {
                if (!coinId) return;
                
                const coinData = allCoinsCache.get(coinId);
                const portfolioItem = myPortfolioCache.get(coinId);
                
                if (!coinData || !portfolioItem) {
                    return showMessage("No tienes historial de trades para esta moneda.");
                }

                const tradeHistory = portfolioItem.tradeHistory || [];
                const currentTokens = portfolioItem.amount || 0;
                
                let totalSsolInvested = 0;
                let totalTokensBought = 0;
                
                // Calcular inversi√≥n basada en historial
                tradeHistory.forEach(trade => {
                    if (trade.type === 'buy') {
                        totalSsolInvested += trade.amountSsol || 0;
                        totalTokensBought += trade.amountToken || 0;
                    } else if (trade.type === 'sell') {
                        // Reducir la inversi√≥n proporcionalmente
                        if (totalTokensBought > 0) {
                             const sellProportion = (trade.amountToken || 0) / totalTokensBought;
                             // Asegurarse de no reducir m√°s de lo invertido
                             totalSsolInvested = Math.max(0, totalSsolInvested - (totalSsolInvested * sellProportion));
                             totalTokensBought = Math.max(0, totalTokensBought - (trade.amountToken || 0));
                        }
                    }
                });

                // Asegurar que la inversi√≥n no sea negativa si se vendi√≥ todo
                if (currentTokens < 0.000001) {
                    totalSsolInvested = 0;
                }

                const avgBuyPrice = (totalTokensBought > 0 && totalSsolInvested > 0) ? totalSsolInvested / totalTokensBought : 0;
                const currentValueInSsol = currentTokens * coinData.currentPrice;
                
                // Calcular PnL basado en el costo base restante
                const pnlSsol = currentValueInSsol - totalSsolInvested;
                const pnlPercent = (totalSsolInvested > 0) ? (pnlSsol / totalSsolInvested) * 100 : (currentValueInSsol > 0 ? Infinity : 0); // Manejar caso de inversi√≥n cero
                
                // Actualizar UI del Modal
                document.getElementById('pnl-card-coin-symbol').textContent = coinData.symbol;
                
                const pnlPercentEl = document.getElementById('pnl-card-percentage');
                const pnlSsolEl = document.getElementById('pnl-card-ssol');
                const cardContentEl = document.getElementById('pnl-card-content');
                
                pnlPercentEl.textContent = `${pnlPercent >= 0 ? '+' : ''}${isFinite(pnlPercent) ? formatNumber(pnlPercent) : '‚àû'}%`;
                pnlSsolEl.textContent = `${pnlSsol >= 0 ? '+' : ''}${formatNumber(pnlSsol)} sSOL`;
                
                if (pnlSsol >= 0) {
                    pnlPercentEl.classList.remove('text-red-400');
                    pnlPercentEl.classList.add('text-green-400');
                    pnlSsolEl.classList.remove('text-red-400');
                    pnlSsolEl.classList.add('text-gray-200');
                    cardContentEl.classList.remove('pnl-card-gradient-loss');
                    cardContentEl.classList.add('pnl-card-gradient-win');
                } else {
                    pnlPercentEl.classList.remove('text-green-400');
                    pnlPercentEl.classList.add('text-red-400');
                    pnlSsolEl.classList.remove('text-gray-200');
                    pnlSsolEl.classList.add('text-red-400');
                    cardContentEl.classList.remove('pnl-card-gradient-win');
                    cardContentEl.classList.add('pnl-card-gradient-loss');
                }
                
                document.getElementById('pnl-card-invested').textContent = formatNumber(totalSsolInvested);
                document.getElementById('pnl-card-current-value').textContent = formatNumber(currentValueInSsol);
                document.getElementById('pnl-card-tokens').textContent = formatNumber(currentTokens);
                document.getElementById('pnl-card-avg-buy').textContent = formatPrice(avgBuyPrice);
                
                showModal(pnlCardModalEl);
            }


            // --- INICIAR EL JUEGO ---
            initAuth();
            initChart();
            
            setTimeout(proactiveBotLoop, 5000); // Iniciar el loop de bots
            
            showMessage("¬°Bienvenido! Nuevo Chat Global, Oficina y Tienda de Lujo. Firebase actualizado.");
        
        } // --- FIN: ENVOLTORIO MAIN ASYNC ---

        // Llamar a la funci√≥n principal para iniciar todo
        main().catch(err => {
            console.error("Error fatal al iniciar la aplicaci√≥n:", err);
            const messageModalEl = document.getElementById('message-modal');
            const messageTextEl = document.getElementById('message-text');
            if (messageTextEl && messageModalEl) {
                messageTextEl.textContent = "Error fatal al iniciar: " + err.message + ". Revisa la consola.";
                messageModalEl.classList.remove('hidden');
            }
        });

    </script>
</body>
</html>

