<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solana Memecoin Simulator</title>
    <!-- Cargar Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Cargar Chart.js (para las gr√°ficas) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Configuraci√≥n de Tailwind para modo oscuro -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'solana-green': '#14F195',
                        'solana-purple': '#9945FF',
                    },
                    keyframes: {
                        livePulse: {
                            '0%, 100%': { opacity: 1, boxShadow: '0 0 5px #F11414' },
                            '50%': { opacity: 0.6, boxShadow: '0 0 15px 5px #F11414' },
                        },
                        liveScreen: {
                            '0%, 100%': { backgroundColor: 'rgba(239, 68, 68, 0.2)' }, /* red-500/20 */
                            '50%': { backgroundColor: 'rgba(34, 197, 94, 0.2)' }, /* green-600/20 */
                        }
                    },
                    animation: {
                        livePulse: 'livePulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        liveScreen: 'liveScreen 1.5s ease-in-out infinite',
                    }
                }
            }
        }
    </script>
    <style>
        /* Estilo para la barra de scroll */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #2d3748; /* gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568; /* gray-600 */
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #718096; /* gray-500 */
        }
        .glassmorphism {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        /* Estilo para Modales */
        .modal {
            transition: opacity 0.25s ease, visibility 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans antialiased flex flex-col min-h-screen">

    <!-- Encabezado -->
    <header class="bg-gray-800 shadow-lg sticky top-0 z-30">
        <nav class="container mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-xl lg:text-2xl font-bold text-solana-green">
                üöÄ Solana Memecoin Sim
            </h1>
            <div class="flex items-center space-x-4">
                <div class="text-right">
                    <div class="text-sm text-gray-400">Balance</div>
                    <div id="ssol-balance" class="text-lg font-semibold text-solana-green">2.00 sSOL</div>
                </div>
            </div>
        </nav>
        <div id="player-id-banner" class="bg-solana-purple text-center py-1 px-4 text-xs font-mono">
            Cargando tu ID de jugador...
        </div>
    </header>

    <!-- Contenido Principal -->
    <main class="container mx-auto p-4 flex-grow flex flex-col lg:flex-row gap-4">

        <!-- Columna Izquierda: Controles y Portafolio -->
        <aside class="w-full lg:w-1/3 flex flex-col gap-4">
            
            <!-- Botones de Acci√≥n -->
            <div class="glassmorphism rounded-lg shadow-xl p-4 grid grid-cols-2 gap-2">
                 <button id="show-create-modal-btn" class="w-full bg-solana-purple hover:bg-opacity-80 text-white font-bold py-3 px-4 rounded-md transition duration-200 text-sm">
                    ‚ú® Lanzar Moneda
                </button>
                <button id="show-creator-dashboard-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md transition duration-200 text-sm">
                    üíº Panel de Creador
                </button>
            </div>
            
            <!-- Tienda de Lujo -->
            <div class="glassmorphism rounded-lg shadow-xl p-4">
                <h2 class="text-xl font-semibold mb-3 border-b border-gray-700 pb-2">Tienda de Lujo</h2>
                <div class="grid grid-cols-2 gap-2">
                    <button id="buy-lambo-btn" data-item="lambo" data-cost="5" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 px-3 rounded-md transition duration-200 text-sm">
                        Comprar Lambo <br>(5 sSOL)
                    </button>
                    <button id="buy-mansion-btn" data-item="mansion" data-cost="20" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-3 rounded-md transition duration-200 text-sm">
                        Comprar Mansi√≥n <br>(20 sSOL)
                    </button>
                </div>
            </div>
            
            <!-- Mis Activos (Lujo) -->
            <div class="glassmorphism rounded-lg shadow-xl p-4">
                <h2 class="text-xl font-semibold mb-3 border-b border-gray-700 pb-2">Mis Activos</h2>
                <div id="my-assets-list" class="flex flex-wrap gap-2">
                    <p class="text-gray-400 text-sm">A√∫n no tienes activos de lujo.</p>
                </div>
            </div>


            <!-- Mi Portafolio -->
            <div class="glassmorphism rounded-lg shadow-xl p-4 flex-grow flex flex-col">
                <h2 class="text-xl font-semibold mb-3 border-b border-gray-700 pb-2">Mi Portafolio</h2>
                <div id="portfolio-list" class="flex-grow overflow-y-auto h-48 lg:h-auto space-y-2 pr-2">
                    <p class="text-gray-400">A√∫n no tienes monedas.</p>
                </div>
            </div>

            <!-- Trades Recientes -->
            <div class="glassmorphism rounded-lg shadow-xl p-4 flex-grow flex flex-col">
                <h2 class="text-xl font-semibold mb-3 border-b border-gray-700 pb-2">Trades Recientes</h2>
                <div id="top-trades-list" class="flex-grow overflow-y-auto h-48 lg:h-auto space-y-2 pr-2">
                    <p class="text-gray-400">Esperando trades...</p>
                </div>
            </div>

            <!-- Jugadores en la Sala -->
            <div class="glassmorphism rounded-lg shadow-xl p-4 flex-grow flex flex-col">
                <h2 class="text-xl font-semibold mb-3 border-b border-gray-700 pb-2">Jugadores en la Sala</h2>
                <div id="players-list" class="flex-grow overflow-y-auto h-48 lg:h-auto space-y-2 pr-2">
                    <p class="text-gray-400">Cargando jugadores...</p>
                </div>
            </div>
        </aside>

        <!-- Columna Derecha: Lista de Monedas -->
        <section class="w-full lg:w-2/3 glassmorphism rounded-lg shadow-xl p-4 flex flex-col">
            <h2 class="text-xl font-semibold mb-3 border-b border-gray-700 pb-2">Mercado de Memecoins</h2>
            <div id="memecoin-list" class="flex-grow overflow-y-auto space-y-2 pr-2 h-96 lg:h-[80vh]">
                <p class="text-gray-400">No hay monedas. ¬°Lanza la primera!</p>
            </div>
        </section>

    </main>

    <!-- Modal para Mensajes Simples -->
    <div id="message-modal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden opacity-0 visibility-hidden">
        <div class="modal-content glassmorphism p-6 rounded-lg shadow-2xl max-w-sm mx-auto text-center transform scale-95">
            <p id="message-text" class="text-lg mb-4">Mensaje</p>
            <button id="close-message-btn" class="bg-solana-purple hover:bg-opacity-80 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                Cerrar
            </button>
        </div>
    </div>
    
    <!-- Modal para Crear Moneda -->
    <div id="create-coin-modal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-40 hidden opacity-0 visibility-hidden p-4">
        <div class="modal-content glassmorphism p-6 rounded-lg shadow-2xl max-w-md w-full text-center transform scale-95 overflow-y-auto max-h-full">
            <div class="flex justify-between items-center mb-3 border-b border-gray-700 pb-2">
                <h2 class="text-xl font-semibold">Lanzar Nueva Memecoin</h2>
                <button id="close-create-modal-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <form id="create-coin-form" class="space-y-3 text-left">
                <div>
                    <label for="coin-name" class="block text-sm font-medium text-gray-300">Nombre (Ej: DogeWifHat)</label>
                    <input type="text" id="coin-name" required class="w-full mt-1 px-3 py-2 bg-gray-800 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-solana-purple" maxlength="20">
                </div>
                <div>
                    <label for="coin-symbol" class="block text-sm font-medium text-gray-300">S√≠mbolo (Ej: WIF)</label>
                    <input type="text" id="coin-symbol" required class="w-full mt-1 px-3 py-2 bg-gray-800 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-solana-purple" maxlength="5" autocapitalize="characters">
                </div>
                <div>
                    <label for="coin-image-url" class="block text-sm font-medium text-gray-300">URL de Imagen</glabel>
                    <input type="url" id="coin-image-url" placeholder="https://..." class="w-full mt-1 px-3 py-2 bg-gray-800 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-solana-purple">
                </div>
                <div class="grid grid-cols-2 gap-2">
                     <div>
                        <label for="coin-initial-ssol" class="block text-sm font-medium text-gray-300">sSOL Inicial (Liq.)</label>
                        <input type="number" id="coin-initial-ssol" step="0.01" min="0.01" required placeholder="0.1" class="w-full mt-1 px-3 py-2 bg-gray-800 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-solana-purple">
                    </div>
                     <div>
                        <label for="coin-initial-tokens" class="block text-sm font-medium text-gray-300">Tokens (Liq.)</label>
                        <input type="number" id="coin-initial-tokens" step="1000" min="1000" required placeholder="1000000" class="w-full mt-1 px-3 py-2 bg-gray-800 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-solana-purple">
                    </div>
                </div>
                <button type="submit" class="w-full bg-solana-purple hover:bg-opacity-80 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                    Lanzar (Costo: 0.01 sSOL + Liq.)
                </button>
            </form>
        </div>
    </div>
    
    <!-- Modal para Gr√°fica y Trading -->
    <div id="chart-modal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-40 hidden opacity-0 visibility-hidden p-4">
        <div class="modal-content glassmorphism p-6 rounded-lg shadow-2xl max-w-3xl w-full text-center transform scale-95 overflow-y-auto max-h-full">
            
            <div class="flex justify-between items-center mb-3 border-b border-gray-700 pb-2">
                 <div class="flex items-center gap-2">
                     <h2 id="modal-coin-name" class="text-2xl font-bold text-solana-green"></h2>
                     <span id="modal-live-badge" class="hidden animate-livePulse text-xs font-bold bg-red-600 text-white px-2 py-0.5 rounded-md">LIVE</span>
                 </div>
                <button id="close-chart-modal-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>

            <p id="modal-coin-price" class="text-xl font-mono text-center text-gray-300 mb-4">$0.00</p>
            
            <!-- Canvas para la gr√°fica -->
            <div class="relative h-48 md:h-72 mb-4">
                <canvas id="coin-chart-modal"></canvas>
            </div>
            
            <!-- Bot√≥n para ver "Live" -->
            <button id="view-live-btn" class="hidden w-full mb-4 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                Ver Directo
            </button>

            <!-- Formularios de Compra/Venta -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Comprar -->
                <form id="buy-form-modal" class="space-y-2 glassmorphism p-4 rounded-lg">
                    <label for="buy-amount-ssol-modal" class="block text-sm font-medium text-gray-300">Gastar (sSOL) - Fee 0.3%</label>
                    <input type="number" id="buy-amount-ssol-modal" step="0.01" min="0.01" placeholder="0.1" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-solana-green" required>
                    <button type="submit" class="w-full bg-solana-green hover:bg-opacity-80 text-gray-900 font-bold py-2 px-4 rounded-md transition duration-200">
                        Comprar
                    </button>
                </form>
                
                <!-- Vender -->
                <form id="sell-form-modal" class="space-y-2 glassmorphism p-4 rounded-lg">
                    <label for="sell-amount-token-modal" class="block text-sm font-medium text-gray-300">Vender (Tokens) - Fee 0.3%</label>
                    <input type="number" id="sell-amount-token-modal" step="1" min="1" placeholder="1000" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500" required>
                    <!-- Botones de Venta R√°pida -->
                    <div class="grid grid-cols-3 gap-2 text-xs">
                        <button type="button" class="sell-percent-btn bg-gray-700 hover:bg-gray-600 py-1 rounded" data-percent="0.10">10%</button>
                        <button type="button" class="sell-percent-btn bg-gray-700 hover:bg-gray-600 py-1 rounded" data-percent="0.50">50%</button>
                        <button type="button" class="sell-percent-btn bg-gray-700 hover:bg-gray-600 py-1 rounded" data-percent="1.00">100%</button>
                    </div>
                    <button type="submit" class="w-full bg-red-600 hover:bg-opacity-80 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                        Vender
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Modal para Panel de Creador -->
    <div id="creator-dashboard-modal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-40 hidden opacity-0 visibility-hidden p-4">
        <div class="modal-content glassmorphism p-6 rounded-lg shadow-2xl max-w-4xl w-full text-center transform scale-95 overflow-y-auto max-h-full">
            <div class="flex justify-between items-center mb-3 border-b border-gray-700 pb-2">
                <h2 class="text-xl font-semibold">Panel de Creador</h2>
                <button id="close-creator-dashboard-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="creator-coins-list" class="space-y-4 text-left">
                <p class="text-gray-400 text-center">No has creado ninguna moneda.</p>
            </div>
        </div>
    </div>
    
    <!-- Modal para Enviar sSOL (P2P) -->
    <div id="send-ssol-modal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-40 hidden opacity-0 visibility-hidden p-4">
        <div class="modal-content glassmorphism p-6 rounded-lg shadow-2xl max-w-md w-full text-center transform scale-95">
            <div class="flex justify-between items-center mb-3 border-b border-gray-700 pb-2">
                <h2 class="text-xl font-semibold">Enviar sSOL</h2>
                <button id="close-send-ssol-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <form id="send-ssol-form" class="space-y-3 text-left">
                <p class="text-sm">Enviar a: <strong id="send-ssol-target-name" class="font-mono text-solana-green">...</strong></p>
                <div>
                    <label for="send-ssol-amount" class="block text-sm font-medium text-gray-300">Monto (sSOL)</label>
                    <input type="number" id="send-ssol-amount" step="0.01" min="0.01" required placeholder="0.1" class="w-full mt-1 px-3 py-2 bg-gray-800 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-solana-purple">
                </div>
                <button type="submit" class="w-full bg-solana-purple hover:bg-opacity-80 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                    Confirmar Env√≠o
                </button>
            </form>
        </div>
    </div>
    
    <!-- Modal para "Live Stream" -->
    <div id="live-stream-modal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden opacity-0 visibility-hidden p-4">
        <div class="modal-content glassmorphism p-6 rounded-lg shadow-2xl max-w-2xl w-full text-center transform scale-95">
            <div class="flex justify-between items-center mb-3 border-b border-gray-700 pb-2">
                <h2 id="live-coin-name" class="text-xl font-semibold text-red-500 animate-pulse">LIVE: ...</h2>
                <button id="close-live-stream-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <!-- Pantalla simulada -->
            <div class="w-full h-64 bg-black rounded-lg mb-4 animate-liveScreen border-2 border-gray-700 flex items-center justify-center">
                <span class="text-3xl font-bold text-gray-500">SIMULACI√ìN DE LIVE</span>
            </div>
            <div class="flex justify-between items-center mb-3">
                <div class="text-lg">Espectadores: <span id="live-viewers" class="font-bold text-solana-green">...</span></div>
                <button id="boost-live-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                    Pagar Boost (0.1 sSOL)
                </button>
            </div>
        </div>
    </div>


    <!-- Scripts de Firebase y L√≥gica del Juego -->
    <script type="module">
        // Importar funciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            collection, 
            onSnapshot, 
            runTransaction, 
            serverTimestamp,
            query,
            updateDoc,
            orderBy,
            limit,
            increment,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- INICIO: ENVOLTORIO MAIN ASYNC ---
        async function main() {
        
            // --- CONFIGURACI√ìN DE FIREBASE (TU PROYECTO) ---
            const appId = 'speed-of-glory'; 
            const firebaseConfig = {
              apiKey: "AIzaSyAKOG8qGf3lwZpZrqyMeUSuUHRpltBExHg",
              authDomain: "speed-of-glory.firebaseapp.com",
              databaseURL: "https://speed-of-glory-default-rtdb.firebaseio.com",
              projectId: "speed-of-glory",
              storageBucket: "speed-of-glory.firebasestorage.app",
              messagingSenderId: "824426979090",
              appId: "1:824426979090:web:dd3cb392e667e5e0e91dcb",
              measurementId: "G-NY69W2S5KT"
            };
            
            const app = initializeApp(firebaseConfig);
            // --- FIN DE LA CONFIGURACI√ìN ---
            
            const db = getFirestore(app);
            const auth = getAuth(app);
            
            // --- REFERENCIAS AL DOM (MODALES) ---
            const messageModalEl = document.getElementById('message-modal');
            const messageTextEl = document.getElementById('message-text');
            const closeMessageBtn = document.getElementById('close-message-btn');
            
            const createCoinModalEl = document.getElementById('create-coin-modal');
            const showCreateModalBtn = document.getElementById('show-create-modal-btn');
            const closeCreateModalBtn = document.getElementById('close-create-modal-btn');

            const chartModalEl = document.getElementById('chart-modal');
            const closeChartModalBtn = document.getElementById('close-chart-modal-btn');
            const modalCoinNameEl = document.getElementById('modal-coin-name');
            const modalCoinPriceEl = document.getElementById('modal-coin-price');
            const modalLiveBadgeEl = document.getElementById('modal-live-badge');
            const viewLiveBtnEl = document.getElementById('view-live-btn');
            
            const creatorDashboardModalEl = document.getElementById('creator-dashboard-modal');
            const showCreatorDashboardBtn = document.getElementById('show-creator-dashboard-btn');
            const closeCreatorDashboardBtn = document.getElementById('close-creator-dashboard-btn');
            const creatorCoinsListEl = document.getElementById('creator-coins-list');
            
            const sendSsolModalEl = document.getElementById('send-ssol-modal');
            const closeSendSsolBtn = document.getElementById('close-send-ssol-btn');
            const sendSsolTargetNameEl = document.getElementById('send-ssol-target-name');
            const sendSsolFormEl = document.getElementById('send-ssol-form');
            const sendSsolAmountEl = document.getElementById('send-ssol-amount');
            
            const liveStreamModalEl = document.getElementById('live-stream-modal');
            const closeLiveStreamBtn = document.getElementById('close-live-stream-btn');
            const liveCoinNameEl = document.getElementById('live-coin-name');
            const liveViewersEl = document.getElementById('live-viewers');
            const boostLiveBtnEl = document.getElementById('boost-live-btn');
            
            // --- FUNCIONES DE MODAL ---
            function showModal(modalEl) {
                modalEl.classList.remove('hidden');
                setTimeout(() => {
                    modalEl.classList.remove('opacity-0', 'visibility-hidden');
                    modalEl.querySelector('.modal-content').classList.remove('scale-95');
                }, 10);
            }

            function hideModal(modalEl) {
                modalEl.classList.add('opacity-0');
                modalEl.querySelector('.modal-content').classList.add('scale-95');
                setTimeout(() => {
                    modalEl.classList.add('hidden', 'visibility-hidden');
                }, 250);
            }

            function showMessage(text) {
                messageTextEl.textContent = text;
                showModal(messageModalEl);
            }
            
            closeMessageBtn.addEventListener('click', () => hideModal(messageModalEl));
            showCreateModalBtn.addEventListener('click', () => showModal(createCoinModalEl));
            closeCreateModalBtn.addEventListener('click', () => hideModal(createCoinModalEl));
            closeChartModalBtn.addEventListener('click', () => {
                hideModal(chartModalEl);
                selectedCoinId = null; 
                const coinElements = memecoinListEl.querySelectorAll('button');
                coinElements.forEach(child => {
                    child.classList.remove('bg-solana-purple/50');
                    child.classList.add('bg-gray-800');
                });
            });
            showCreatorDashboardBtn.addEventListener('click', () => showCreatorDashboard());
            closeCreatorDashboardBtn.addEventListener('click', () => hideModal(creatorDashboardModalEl));
            closeSendSsolBtn.addEventListener('click', () => hideModal(sendSsolModalEl));
            closeLiveStreamBtn.addEventListener('click', () => hideModal(liveStreamModalEl));
            viewLiveBtnEl.addEventListener('click', () => showLiveStream());
            boostLiveBtnEl.addEventListener('click', () => boostLiveStream());


            // --- VARIABLES GLOBALES DEL JUEGO ---
            let currentUserId = null;
            let selectedCoinId = null;
            let targetPlayerId = null; // Para P2P
            let memecoinChart = null;
            let allCoinsCache = new Map(); 
            let myPortfolioCache = new Map(); 
            let myAssetsCache = new Map(); // Para items de lujo
            
            // --- COMISIONES ---
            const LP_FEE = 0.0025; // 0.25% para el pool
            const CREATOR_FEE = 0.0005; // 0.05% para el creador
            
            // Referencias de Firestore
            const roomRef = collection(db, 'artifacts', appId, 'public', 'data', 'game_rooms', 'global_room', 'data');
            const playersRef = collection(db, 'artifacts', appId, 'public', 'data', 'game_rooms', 'global_room', 'players');
            const tradesRef = collection(db, 'artifacts', appId, 'public', 'data', 'game_rooms', 'global_room', 'trades');
            const luxuryStoreRef = doc(db, 'artifacts', appId, 'public', 'data', 'game_rooms', 'global_room', 'store', 'luxury');


            // --- REFERENCIAS AL DOM (JUEGO) ---
            const ssolBalanceEl = document.getElementById('ssol-balance');
            const playerIdBannerEl = document.getElementById('player-id-banner');
            const playersListEl = document.getElementById('players-list');
            const portfolioListEl = document.getElementById('portfolio-list');
            const topTradesListEl = document.getElementById('top-trades-list'); 
            const memecoinListEl = document.getElementById('memecoin-list');
            const myAssetsListEl = document.getElementById('my-assets-list');

            // Formularios (dentro de modales)
            const createCoinFormEl = document.getElementById('create-coin-form');
            const coinNameEl = document.getElementById('coin-name');
            const coinSymbolEl = document.getElementById('coin-symbol');
            const coinImageUrlEl = document.getElementById('coin-image-url');
            const coinInitialSsolEl = document.getElementById('coin-initial-ssol');
            const coinInitialTokensEl = document.getElementById('coin-initial-tokens');
            
            const buyFormEl = document.getElementById('buy-form-modal');
            const sellFormEl = document.getElementById('sell-form-modal');
            const buyAmountEl = document.getElementById('buy-amount-ssol-modal');
            const sellAmountEl = document.getElementById('sell-amount-token-modal');

            // --- FUNCIONES DE UTILIDAD ---
            function formatPrice(value) {
                return new Intl.NumberFormat('en-US', { 
                    style: 'currency', 
                    currency: 'USD',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 10
                }).format(value);
            }

            function formatCurrency(value) {
                 return new Intl.NumberFormat('en-US', { 
                    style: 'currency', 
                    currency: 'USD',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(value);
            }
            
            function formatNumber(value) {
                return new Intl.NumberFormat('en-US', { maximumFractionDigits: 2 }).format(value);
            }

            // --- L√ìGICA DE AUTENTICACI√ìN Y JUEGO ---
            
            async function initAuth() {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        playerIdBannerEl.textContent = `Tu ID de Jugador: ${currentUserId}`;
                        await joinGame(user.uid);
                    } else {
                        try {
                            await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Error de autenticaci√≥n:", error);
                            showMessage("Error al conectar con el servidor. Por favor, recarga.");
                        }
                    }
                });
            }
            
            async function joinGame(userId) {
                const playerRef = doc(playersRef, userId);
                const playerDoc = await getDoc(playerRef);

                if (!playerDoc.exists()) {
                    await setDoc(playerRef, {
                        userId: userId,
                        sSOL_balance: 2, 
                        joinedAt: serverTimestamp(),
                        assets: {} // Inicializar activos de lujo
                    });
                }
                
                listenForPlayerBalance(userId);
                listenForPlayers();
                listenForMemecoins();
                listenForMyPortfolio(userId);
                listenForTopTrades(); 
            }
            
            // --- LISTENERS DE FIRESTORE (TIEMPO REAL) ---

            function listenForPlayerBalance(userId) {
                const playerRef = doc(playersRef, userId);
                onSnapshot(playerRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        ssolBalanceEl.textContent = `${formatNumber(data.sSOL_balance)} sSOL`;
                        // Actualizar mis activos de lujo
                        myAssetsCache = new Map(Object.entries(data.assets || {}));
                        updateMyAssetsUI();
                    }
                });
            }

            function listenForPlayers() {
                onSnapshot(query(playersRef), (snapshot) => {
                    playersListEl.innerHTML = ''; 
                    if (snapshot.empty) {
                        playersListEl.innerHTML = '<p class="text-gray-400">Est√°s solo aqu√≠...</p>';
                        return;
                    }
                    snapshot.forEach(doc => {
                        const player = doc.data();
                        const isMe = player.userId === currentUserId;
                        const playerEl = document.createElement(isMe ? 'div' : 'button'); // Es un bot√≥n si no soy yo
                        playerEl.className = `flex w-full justify-between items-center p-2 rounded ${isMe ? 'bg-solana-purple/30' : 'bg-gray-800 hover:bg-gray-700 transition'}`;
                        playerEl.innerHTML = `
                            <span class="font-mono text-xs truncate ${isMe ? 'text-solana-green' : ''}" title="${player.userId}">
                                ${isMe ? 'Tu (...' + player.userId.slice(-6) + ')' : '...' + player.userId.slice(-6)}
                            </span>
                            <span class="text-sm font-semibold">${formatNumber(player.sSOL_balance)} sSOL</span>
                        `;
                        
                        if (!isMe) {
                            playerEl.addEventListener('click', () => {
                                targetPlayerId = player.userId;
                                sendSsolTargetNameEl.textContent = `...${player.userId.slice(-6)}`;
                                showModal(sendSsolModalEl);
                            });
                        }
                        
                        playersListEl.appendChild(playerEl);
                    });
                });
            }
            
            function listenForTopTrades() {
                const q = query(tradesRef, orderBy("timestamp", "desc"), limit(15));
                onSnapshot(q, (snapshot) => {
                    topTradesListEl.innerHTML = '';
                    if (snapshot.empty) {
                        topTradesListEl.innerHTML = '<p class="text-gray-400">Esperando trades...</p>';
                        return;
                    }
                    snapshot.forEach(doc => {
                        const trade = doc.data();
                        const isBuy = trade.type === 'buy';
                        const color = isBuy ? 'text-green-500' : 'text-red-500';
                        const tradeEl = document.createElement('div');
                        tradeEl.className = `flex justify-between items-center text-xs ${trade.isWash ? 'bg-gray-800/50' : 'bg-gray-800'} p-2 rounded`;
                        tradeEl.innerHTML = `
                            <div>
                                <span class="font-bold ${color}">${isBuy ? 'COMPRA' : 'VENTA'} ${trade.isWash ? '(WASH)' : ''}</span>
                                <span class="font-semibold text-white ml-1">${trade.coinSymbol}</span>
                            </div>
                            <div class="text-right font-mono">
                                <div>${formatNumber(trade.amountSsol)} sSOL</div>
                                <div class="text-gray-400">${formatNumber(trade.amountToken)} tkn</div>
                            </div>
                        `;
                        topTradesListEl.appendChild(tradeEl);
                    });
                });
            }

            function listenForMyPortfolio(userId) {
                const portfolioRef = collection(playersRef, userId, 'wallet');
                onSnapshot(query(portfolioRef), (snapshot) => {
                    portfolioListEl.innerHTML = '';
                    myPortfolioCache.clear();
                    
                    if (snapshot.empty) {
                        portfolioListEl.innerHTML = '<p class="text-gray-400">A√∫n no tienes monedas.</p>';
                        return;
                    }

                    snapshot.forEach(doc => {
                        const coin = doc.data();
                        if (coin.amount < 0.01) return; 
                        
                        myPortfolioCache.set(doc.id, coin);
                        
                        const coinData = allCoinsCache.get(doc.id);
                        const coinName = coinData ? `${coinData.name} (${coinData.symbol})` : 'Moneda Desconocida';
                        const currentValue = coinData ? coin.amount * coinData.currentPrice : 0;
                        
                        const itemEl = document.createElement('div');
                        itemEl.className = 'flex justify-between items-center bg-gray-800 p-2 rounded';
                        itemEl.innerHTML = `
                            <div>
                                <div class="font-semibold">${coinName}</div>
                                <div class="text-sm text-gray-400">${formatNumber(coin.amount)} tokens</div>
                            </div>
                            <div class="text-right">
                                <div class="font-semibold">${formatCurrency(currentValue)}</div>
                                <div class="text-sm text-gray-400">Valor</div>
                            </div>
                        `;
                        portfolioListEl.appendChild(itemEl);
                    });
                });
            }

            function listenForMemecoins() {
                onSnapshot(query(roomRef), (snapshot) => {
                    memecoinListEl.innerHTML = '';
                    
                    if (snapshot.empty) {
                        memecoinListEl.innerHTML = '<p class="text-gray-400">No hay monedas. ¬°Lanza la primera!</p>';
                        allCoinsCache.clear(); 
                        return;
                    }
                    
                    const newCache = new Map();
                    const coins = [];
                    snapshot.forEach(doc => {
                        const coinData = { id: doc.id, ...doc.data() };
                        coins.push(coinData);
                        newCache.set(doc.id, coinData);
                    });
                    
                    allCoinsCache = newCache; 

                    coins.sort((a, b) => (b.marketCap || 0) - (a.marketCap || 0));

                    coins.forEach(coin => {
                        const priceChange = coin.priceHistory.length > 1 ? (coin.currentPrice - coin.priceHistory[coin.priceHistory.length - 2]) / coin.priceHistory[coin.priceHistory.length - 2] : 0;
                        const changeColor = priceChange >= 0 ? 'text-green-500' : 'text-red-500';
                        const changeIcon = priceChange >= 0 ? '‚ñ≤' : '‚ñº';
                        const placeholderImg = `https://placehold.co/40x40/${coin.id.slice(0,6)}/FFFFFF?text=${coin.symbol}`;

                        const coinEl = document.createElement('button');
                        coinEl.className = `w-full text-left p-3 rounded-lg transition duration-200 ${selectedCoinId === coin.id ? 'bg-solana-purple/50' : 'bg-gray-800 hover:bg-gray-700'}`;
                        coinEl.dataset.coinId = coin.id;
                        coinEl.innerHTML = `
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-3">
                                    <img src="${coin.imageUrl || placeholderImg}" onerror="this.src='${placeholderImg}'" alt="${coin.name}" class="w-10 h-10 rounded-full bg-gray-700">
                                    <div>
                                        <span class="text-lg font-bold">${coin.name} (${coin.symbol})</span>
                                        <span class="text-xs text-gray-400 block" title="${coin.creatorId}">Creador: ...${coin.creatorId.slice(-6)}</span>
                                    </div>
                                    ${coin.isLive ? `<span class="animate-livePulse text-xs font-bold bg-red-600 text-white px-2 py-0.5 rounded-md ml-2">LIVE</span>` : ''}
                                </div>
                                <div class="text-right">
                                    <span class="text-lg font-mono">${formatPrice(coin.currentPrice)}</span>
                                    <span class="text-sm font-semibold ${changeColor}">${changeIcon} ${formatNumber(priceChange * 100)}%</span>
                                </div>
                            </div>
                            
                            <!-- Stats Principales -->
                            <div class="grid grid-cols-3 sm:grid-cols-5 gap-2 mt-3 text-xs text-center">
                                <div>
                                    <span class="text-gray-400 block">MC</span>
                                    <span class="font-semibold">${formatCurrency(coin.marketCap || 0)}</span>
                                </div>
                                <div>
                                    <span class="text-gray-400 block">Liquidez</span>
                                    <span class="font-semibold">${formatCurrency(coin.sSolPool || 0)}</span>
                                </div>
                                 <div>
                                    <span class="text-gray-400 block">Volumen</span>
                                    <span class="font-semibold">${formatCurrency(coin.volume || 0)}</span>
                                </div>
                                 <div>
                                    <span class="text-gray-400 block">Holders</span>
                                    <span class="font-semibold">${formatNumber(coin.holderCount || 0)}</span>
                                </div>
                                <div>
                                    <span class="text-gray-400 block">Seguidores</span>
                                    <span class="font-semibold">${formatNumber(coin.followers || 0)}</span>
                                </div>
                            </div>
                            
                            <!-- Stats Secundarias (Nuevas) -->
                            <div class="grid grid-cols-3 gap-2 mt-2 text-xs text-center pt-2 border-t border-gray-700/50">
                                <div>
                                    <span class="text-gray-400 block">Fondos Bots</span>
                                    <span class="font-semibold">${formatNumber(coin.botTokenPool || 0)}</span>
                                </div>
                                <div>
                                    <span class="text-gray-400 block">Precio M√°x.</span>
                                    <span class="font-semibold text-green-400">${formatPrice(coin.allTimeHigh || 0)}</span>
                                </div>
                                 <div>
                                    <span class="text-gray-400 block">Precio M√≠n.</span>
                                    <span class="font-semibold text-red-400">${formatPrice(coin.allTimeLow || 0)}</span>
                                </div>
                            </div>

                            <div class="mt-2 pt-2 border-t border-gray-700 text-xs text-gray-400">
                                <span class="font-semibold text-gray-300">Comisiones Creador:</span> 
                                <span>${formatNumber(coin.creatorFeesSsol || 0)} sSOL</span> | 
                                <span>${formatNumber(coin.creatorFeesToken || 0)} ${coin.symbol}</span>
                            </div>
                        `;
                        coinEl.addEventListener('click', () => selectCoin(coin.id));
                        memecoinListEl.appendChild(coinEl);

                        if (coin.id === selectedCoinId) {
                            updateChart(coin);
                            updateSelectedCoinPrice(coin.currentPrice);
                            modalCoinNameEl.textContent = `${coin.name} (${coin.symbol})`;
                            // Mostrar/ocultar bot√≥n de Live y badge
                            modalLiveBadgeEl.classList.toggle('hidden', !coin.isLive);
                            viewLiveBtnEl.classList.toggle('hidden', !coin.isLive);
                        }
                    });
                    
                    updatePortfolioValues();
                });
            }
            
            function updatePortfolioValues() {
                portfolioListEl.innerHTML = '';
                if (myPortfolioCache.size === 0) {
                     portfolioListEl.innerHTML = '<p class="text-gray-400">A√∫n no tienes monedas.</p>';
                     return;
                }
                
                myPortfolioCache.forEach((coin, coinId) => {
                    const coinData = allCoinsCache.get(coinId);
                    const coinName = coinData ? `${coinData.name} (${coinData.symbol})` : 'Moneda Desconocida';
                    const currentValue = coinData ? coin.amount * coinData.currentPrice : 0;
                    
                    const itemEl = document.createElement('div');
                    itemEl.className = 'flex justify-between items-center bg-gray-800 p-2 rounded';
                    itemEl.innerHTML = `
                        <div>
                            <div class="font-semibold">${coinName}</div>
                            <div class="text-sm text-gray-400">${formatNumber(coin.amount)} tokens</div>
                        </div>
                        <div class="text-right">
                            <div class="font-semibold">${formatCurrency(currentValue)}</div>
                            <div class="text-sm text-gray-400">Valor</div>
                        </div>
                    `;
                    portfolioListEl.appendChild(itemEl);
                });
            }
            
            function updateMyAssetsUI() {
                myAssetsListEl.innerHTML = '';
                if (myAssetsCache.size === 0) {
                    myAssetsListEl.innerHTML = '<p class="text-gray-400 text-sm">A√∫n no tienes activos de lujo.</p>';
                    return;
                }
                
                myAssetsCache.forEach((count, item) => {
                    const emoji = item === 'lambo' ? 'üèéÔ∏è' : 'üè∞';
                    const name = item === 'lambo' ? 'Lambo' : 'Mansi√≥n';
                    const itemEl = document.createElement('div');
                    itemEl.className = 'bg-gray-800 p-2 rounded-lg text-center';
                    itemEl.innerHTML = `
                        <span class="text-2xl">${emoji}</span>
                        <div class="text-sm font-semibold">${name} (x${count})</div>
                    `;
                    myAssetsListEl.appendChild(itemEl);
                });
            }
            
            // --- L√ìGICA DE GR√ÅFICA (CHART.JS) ---

            function initChart() {
                const ctx = document.getElementById('coin-chart-modal').getContext('2d');
                
                memecoinChart = new Chart(ctx, {
                    type: 'line', 
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'Precio',
                                data: [],
                                borderColor: '#14F195',
                                borderWidth: 2,
                                pointRadius: 0,
                                tension: 0.3,
                                fill: false,
                                yAxisID: 'yPrice', 
                            },
                            {
                                label: 'Volumen',
                                data: [],
                                backgroundColor: 'rgba(153, 69, 255, 0.4)', 
                                type: 'bar', 
                                yAxisID: 'yVolume', 
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            yPrice: {
                                type: 'linear',
                                position: 'left',
                                ticks: { 
                                    color: '#9CA3AF',
                                    callback: (value) => formatPrice(value)
                                },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            },
                            yVolume: {
                                type: 'linear',
                                position: 'right', 
                                ticks: { display: false }, 
                                grid: { display: false }, 
                                beginAtZero: true
                            },
                            x: {
                                ticks: { display: false },
                                grid: { display: false }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: { 
                                enabled: true,
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: (context) => {
                                        if (context.datasetIndex === 0) {
                                            return `Precio: ${formatPrice(context.parsed.y)}`;
                                        }
                                        if (context.datasetIndex === 1) {
                                            return `Volumen: ${formatCurrency(context.parsed.y)}`;
                                        }
                                        return '';
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            function updateChart(coinData) {
                if (!memecoinChart) return;
                
                const history = coinData.priceHistory.slice(-50); 
                const volumeHistory = (coinData.volumeHistory || []).slice(-50);
                
                memecoinChart.data.labels = history.map((_, i) => i + 1);
                memecoinChart.data.datasets[0].data = history; 
                memecoinChart.data.datasets[1].data = volumeHistory; 
                
                memecoinChart.update('none'); 
            }

            function updateSelectedCoinPrice(price) {
                modalCoinPriceEl.textContent = `${formatPrice(price)}`;
            }

            // --- ACCIONES DEL JUGADOR ---

            function selectCoin(coinId) {
                selectedCoinId = coinId;
                const coinData = allCoinsCache.get(coinId);
                
                if (!coinData) return;
                
                modalCoinNameEl.textContent = `${coinData.name} (${coinData.symbol})`;
                updateSelectedCoinPrice(coinData.currentPrice);
                updateChart(coinData);
                showModal(chartModalEl);
                
                // Mostrar/ocultar bot√≥n de Live y badge
                modalLiveBadgeEl.classList.toggle('hidden', !coinData.isLive);
                viewLiveBtnEl.classList.toggle('hidden', !coinData.isLive);
                
                Array.from(memecoinListEl.children).forEach(child => {
                    child.classList.toggle('bg-solana-purple/50', child.dataset.coinId === coinId);
                    child.classList.toggle('bg-gray-800', child.dataset.coinId !== coinId);
                });
            }
            
            // Formulario de Crear Moneda
            createCoinFormEl.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = coinNameEl.value.trim();
                const symbol = coinSymbolEl.value.trim().toUpperCase();
                const imageUrl = coinImageUrlEl.value.trim();
                const initialSsol = parseFloat(coinInitialSsolEl.value);
                const initialTokens = parseFloat(coinInitialTokensEl.value);
                
                if (!name || !symbol || isNaN(initialSsol) || isNaN(initialTokens) || initialSsol <= 0 || initialTokens <= 0) {
                    showMessage("Por favor, completa todos los campos de liquidez con valores v√°lidos.");
                    return;
                }

                const launchCost = 0.01;
                const totalCost = launchCost + initialSsol;

                try {
                    await runTransaction(db, async (transaction) => {
                        const playerRef = doc(playersRef, currentUserId);
                        const playerDoc = await transaction.get(playerRef);

                        if (!playerDoc.exists()) {
                            throw new Error("No se encontr√≥ tu jugador.");
                        }
                        
                        const currentBalance = playerDoc.data().sSOL_balance;
                        if (currentBalance < totalCost) {
                            throw new Error(`Fondos insuficientes. Necesitas ${formatNumber(totalCost)} sSOL (0.01 de fee + ${formatNumber(initialSsol)} de liquidez).`);
                        }
                        
                        transaction.update(playerRef, {
                            sSOL_balance: currentBalance - totalCost
                        });
                        
                        const newCoinRef = doc(roomRef); 
                        const price = initialSsol / initialTokens;
                        
                        transaction.set(newCoinRef, {
                            name: name,
                            symbol: symbol,
                            creatorId: currentUserId,
                            imageUrl: imageUrl || `https://placehold.co/40x40/${newCoinRef.id.slice(0,6)}/FFFFFF?text=${symbol}`,
                            sSolPool: initialSsol, 
                            tokenPool: initialTokens,
                            currentPrice: price,
                            priceHistory: [price],
                            volumeHistory: [0], 
                            allTimeHigh: price, 
                            allTimeLow: price, 
                            createdAt: serverTimestamp(),
                            marketCap: initialSsol * 2, 
                            volume: 0,
                            holderCount: 1,
                            lastHolderCountChange: 1, 
                            creatorFeesSsol: 0, 
                            creatorFeesToken: 0, 
                            botSsolPool: 400, 
                            botTokenPool: 0,
                            // Nuevas funciones
                            isLive: false,
                            liveViewers: 0,
                            followers: 1,
                            washTradeBudget: 0
                        });

                        const walletRef = doc(playersRef, currentUserId, 'wallet', newCoinRef.id);
                        transaction.set(walletRef, {
                            amount: initialTokens
                        });
                    });
                    
                    hideModal(createCoinModalEl); 
                    showMessage(`¬°Moneda ${name} (${symbol}) lanzada con √©xito!`);
                    createCoinFormEl.reset(); 

                } catch (error) {
                    console.error("Error al lanzar moneda:", error);
                    showMessage(error.message);
                }
            });

            // --- L√ìGICA DE BOTS (REACTIVA Y PROACTIVA) ---
            
            function simulateBotTrade(coinData, playerAction, forceBuyProbability = null, isWash = false) {
                
                let { 
                    botSsolPool, botTokenPool, sSolPool, tokenPool, 
                    volume, priceHistory, volumeHistory, creatorId,
                    creatorFeesSsol, creatorFeesToken, marketCap, allTimeHigh, allTimeLow,
                    followers
                } = coinData;

                if (creatorId === 'bot') return {};
                
                let buyProbability = 0.6; 
                if (playerAction === 'proactive' && forceBuyProbability !== null) {
                    buyProbability = forceBuyProbability;
                }
                
                // Los bots de Wash Trading intentan alternar
                const isBuy = isWash ? (sSolPool < tokenPool) : (Math.random() < buyProbability);

                let ssolTraded = 0;
                let ssolFee = 0;
                let tokenFee = 0;
                let ssolForTrade = 0;
                let tokensForTrade = 0;
                let tokensReceived = 0;
                let ssolReceived = 0;
                let finalSsolPool = sSolPool;
                let finalTokenPool = tokenPool;
                let newCreatorFeesSsol = creatorFeesSsol || 0;
                let newCreatorFeesToken = creatorFeesToken || 0;
                let tradeRef = null; 
                let newFollowers = followers || 0;

                if (isBuy) { // BOT COMPRA
                    const ssolToSpend = isWash ? (coinData.washTradeBudget * 0.1) : (Math.pow(Math.random(), 2) * (botSsolPool * 0.1));
                    if (ssolToSpend < 0.01 || botSsolPool < ssolToSpend) return {};
                    
                    botSsolPool -= ssolToSpend;
                    ssolTraded = ssolToSpend; 
                    
                    const creatorFee = ssolToSpend * CREATOR_FEE;
                    const lpFee = ssolToSpend * LP_FEE;
                    ssolForTrade = ssolToSpend - creatorFee - lpFee;
                    
                    const k = sSolPool * tokenPool;
                    const newSsolPool_k = sSolPool + ssolForTrade + lpFee;
                    finalTokenPool = k / newSsolPool_k;
                    tokensReceived = tokenPool - finalTokenPool;
                    
                    finalSsolPool = newSsolPool_k;
                    newCreatorFeesSsol += creatorFee;
                    
                    botTokenPool += tokensReceived;
                    if (isWash) coinData.washTradeBudget -= ssolToSpend; // Reducir presupuesto si es wash
                    
                    tradeRef = { type: 'buy', coinSymbol: coinData.symbol, amountSsol: ssolToSpend, amountToken: tokensReceived, price: coinData.currentPrice, timestamp: serverTimestamp(), isWash: isWash };
                    newFollowers++; // Nuevo seguidor en la primera compra
                    
                } else { // BOT VENDE
                    const isRugpull = ((playerAction === 'sell' || playerAction === 'proactive') && Math.random() < 0.1);
                    const sellPercentage = isWash ? 0.1 : (isRugpull ? 0.5 : (Math.pow(Math.random(), 2) * 0.1));
                    
                    const tokensToSell = botTokenPool * sellPercentage;
                    if (tokensToSell < 1) return {};

                    botTokenPool -= tokensToSell;
                    
                    const creatorFee = tokensToSell * CREATOR_FEE;
                    const lpFee = tokensToSell * LP_FEE;
                    tokensForTrade = tokensToSell - creatorFee - lpFee;

                    const k = sSolPool * tokenPool;
                    const newTokenPool_k = tokenPool + tokensForTrade + lpFee;
                    finalSsolPool = k / newTokenPool_k;
                    ssolReceived = sSolPool - finalSsolPool;
                    ssolTraded = ssolReceived; 

                    finalTokenPool = newTokenPool_k;
                    newCreatorFeesToken += creatorFee;
                    
                    botSsolPool += ssolReceived;
                    if (isWash) coinData.washTradeBudget += ssolReceived; // Devolver al presupuesto si es wash
                    
                    tradeRef = { type: 'sell', coinSymbol: coinData.symbol, amountSsol: ssolReceived, amountToken: tokensToSell, price: coinData.currentPrice, timestamp: serverTimestamp(), isWash: isWash };

                    if (isRugpull && !isWash) {
                        console.warn(`¬°BOT RUGPULL SIMULADO! Vendi√≥ ${formatNumber(tokensToSell)} tokens.`);
                    }
                }

                const newPrice = finalSsolPool / finalTokenPool;
                const newAllTimeHigh = Math.max(allTimeHigh || 0, newPrice);
                const newAllTimeLow = Math.min(allTimeLow || 999999, newPrice); 
                const newMarketCap = newPrice * (finalTokenPool + botTokenPool);
                const newHistory = [...priceHistory, newPrice].slice(-50);
                const newVolumeHistory = [...(volumeHistory || []), ssolTraded].slice(-50); 
                const newVolume = volume + ssolTraded;

                const updates = {
                    sSolPool: finalSsolPool,
                    tokenPool: finalTokenPool,
                    botSsolPool: botSsolPool,
                    botTokenPool: botTokenPool,
                    currentPrice: newPrice,
                    priceHistory: newHistory,
                    volumeHistory: newVolumeHistory, 
                    volume: newVolume,
                    marketCap: newMarketCap,
                    creatorFeesSsol: newCreatorFeesSsol,
                    creatorFeesToken: newCreatorFeesToken,
                    tradeLog: tradeRef, 
                    allTimeHigh: newAllTimeHigh,
                    allTimeLow: newAllTimeLow
                };
                
                if (isBuy) updates.followers = newFollowers;
                if (isWash) updates.washTradeBudget = coinData.washTradeBudget;
                
                return updates;
            }
            
            // Bucle para Bots de "Wash Trading" (Volumen)
            async function washTradeBotLoop() {
                if (allCoinsCache.size === 0) {
                    setTimeout(washTradeBotLoop, 3000); // Reintentar
                    return;
                }

                const batch = writeBatch(db);
                let batchHasWrites = false;

                for (const [coinId, coin] of allCoinsCache.entries()) {
                    if (coin.washTradeBudget && coin.washTradeBudget > 0.01) {
                        const coinRef = doc(roomRef, coinId);
                        
                        // Simular el trade
                        const botUpdates = simulateBotTrade(coin, 'proactive', null, true); // true = isWash
                        
                        if (Object.keys(botUpdates).length > 0) {
                            if (botUpdates.tradeLog) {
                                const newTradeRef = doc(tradesRef);
                                batch.set(newTradeRef, botUpdates.tradeLog);
                                delete botUpdates.tradeLog; 
                            }
                            
                            batch.update(coinRef, botUpdates);
                            batchHasWrites = true;
                        }
                    }
                }
                
                if (batchHasWrites) {
                    try {
                        await batch.commit();
                    } catch (e) {
                        console.warn("Fallo el batch de Wash Trade (conflicto normal):", e.message);
                    }
                }

                setTimeout(washTradeBotLoop, 3000); // Cada 3 segundos
            }


            async function proactiveBotLoop() {
                if (allCoinsCache.size > 0) {
                    
                    for (const [coinId, coin] of allCoinsCache.entries()) {
                        
                        const allTimeHigh = coin.allTimeHigh || coin.priceHistory[0] || 0;
                        const currentPrice = coin.currentPrice;
                        let buyProbability = 0.5; 
                        let tradeProbability = 0.0; 

                        if (allTimeHigh > 0 && (currentPrice / allTimeHigh) < 0.2) {
                            tradeProbability = 0.1; 
                            buyProbability = 0.05; 
                        } else {
                            // --- L√ìGICA DE HYPE ---
                            const priceHistory = coin.priceHistory || [];
                            let priceChange = 0;
                            if (priceHistory.length > 1) {
                                const prevPrice = priceHistory[priceHistory.length - 2];
                                if (prevPrice > 0) {
                                    priceChange = (coin.currentPrice - prevPrice) / prevPrice;
                                }
                            }
                            
                            const priceChangeScore = Math.max(0, Math.min(1, priceChange / 0.1)); 
                            const volumeRatio = (coin.sSolPool > 0) ? (coin.volume || 0) / coin.sSolPool : 0;
                            const volumeScore = Math.max(0, Math.min(1, volumeRatio / 10));
                            const holderScore = Math.max(0, Math.min(1, (coin.lastHolderCountChange || 0) / 5));
                            const followersScore = Math.max(0, Math.min(1, (coin.followers || 0) / 100)); // Hype por seguidores
                            const liveScore = coin.isLive ? 1.0 : 0.0; // Hype por "Live"
                            
                            const totalHypeScore = (priceChangeScore + volumeScore + holderScore + followersScore + liveScore) / 5;
                            tradeProbability = totalHypeScore * 0.5; 

                            if (priceChange > 0) {
                                buyProbability = 0.5 + (totalHypeScore * 0.4); 
                            } else {
                                buyProbability = 0.5 - ((1 - totalHypeScore) * 0.4); 
                            }
                        }
                        
                        if (Math.random() < tradeProbability) {
                            
                            const coinRef = doc(roomRef, coinId);
                            try {
                                await runTransaction(db, async (transaction) => {
                                    const coinDoc = await transaction.get(coinRef);
                                    if (!coinDoc.exists()) return;
                                    
                                    const coinData = coinDoc.data();
                                    const botUpdates = simulateBotTrade(coinData, 'proactive', buyProbability); 
                                    
                                    if (Object.keys(botUpdates).length > 0) {
                                        if (botUpdates.tradeLog) {
                                            const newTradeRef = doc(tradesRef);
                                            transaction.set(newTradeRef, botUpdates.tradeLog);
                                            delete botUpdates.tradeLog; 
                                        }
                                        botUpdates.lastHolderCountChange = 0; 
                                        
                                        transaction.update(coinRef, botUpdates);
                                    }
                                });
                            } catch (e) {
                                console.warn("Fallo la transacci√≥n proactiva del bot (conflicto normal):", e.message);
                            }
                        }
                    }
                }
                
                setTimeout(proactiveBotLoop, 5000);
            }

            // Formulario de Compra
            buyFormEl.addEventListener('submit', async (e) => {
                e.preventDefault();
                const ssolToSpend = parseFloat(buyAmountEl.value);
                
                if (!selectedCoinId || isNaN(ssolToSpend) || ssolToSpend <= 0) {
                    showMessage("Ingresa un monto v√°lido.");
                    return;
                }
                
                let tokensReceived = 0; 
                
                try {
                    await runTransaction(db, async (transaction) => {
                        const playerRef = doc(playersRef, currentUserId);
                        const coinRef = doc(roomRef, selectedCoinId);
                        const walletRef = doc(playersRef, currentUserId, 'wallet', selectedCoinId);
                        
                        const [playerDoc, coinDoc, walletDoc] = await Promise.all([
                            transaction.get(playerRef),
                            transaction.get(coinRef),
                            transaction.get(walletRef)
                        ]);
                        
                        if (!playerDoc.exists() || !coinDoc.exists()) {
                            throw new Error("No se encontraron datos del jugador o la moneda.");
                        }
                        
                        let playerData = playerDoc.data();
                        let coinData = coinDoc.data();
                        
                        if (playerData.sSOL_balance < ssolToSpend) {
                            throw new Error("sSOL insuficiente.");
                        }
                        
                        const botUpdates = simulateBotTrade(coinData, 'reactive_buy');
                        coinData = { ...coinData, ...botUpdates };
                        
                        const ssolTraded = ssolToSpend; 
                        const creatorFee = ssolToSpend * CREATOR_FEE;
                        const lpFee = ssolToSpend * LP_FEE;
                        const ssolForTrade = ssolToSpend - creatorFee - lpFee;

                        const k = coinData.sSolPool * coinData.tokenPool;
                        const newSsolPool_k = coinData.sSolPool + ssolForTrade + lpFee;
                        const newTokenPool = k / newSsolPool_k;
                        tokensReceived = coinData.tokenPool - newTokenPool; 
                        
                        const finalSsolPool = newSsolPool_k;
                        
                        const newPrice = finalSsolPool / newTokenPool;
                        const newAllTimeHigh = Math.max(coinData.allTimeHigh || 0, newPrice); 
                        const newAllTimeLow = Math.min(coinData.allTimeLow || 999999, newPrice);
                        const newMarketCap = newPrice * (newTokenPool + coinData.botTokenPool);
                        const newHistory = [...coinData.priceHistory, newPrice].slice(-50);
                        const newVolumeHistory = [...(coinData.volumeHistory || []), ssolTraded].slice(-50);
                        const newVolume = coinData.volume + ssolTraded;
                        const newCreatorFeesSsol = (coinData.creatorFeesSsol || 0) + creatorFee;

                        let newHolderCount = coinData.holderCount;
                        let holderChange = 0;
                        let newFollowers = coinData.followers || 0;
                        const currentTokens = walletDoc.exists() ? walletDoc.data().amount : 0;
                        if (currentTokens < 0.01) { 
                            newHolderCount++;
                            holderChange = 1; 
                            newFollowers++; // Nuevo seguidor (jugador real)
                        }
                        const newLastHolderCountChange = (coinData.lastHolderCountChange || 0) + holderChange;
                        
                        transaction.update(playerRef, {
                            sSOL_balance: playerData.sSOL_balance - ssolToSpend
                        });
                        
                        transaction.set(walletRef, {
                            amount: currentTokens + tokensReceived
                        }, { merge: true });
                        
                        if (botUpdates.tradeLog) {
                            const newTradeRef = doc(tradesRef);
                            transaction.set(newTradeRef, botUpdates.tradeLog);
                            delete botUpdates.tradeLog;
                        }
                        
                        const playerTradeRef = doc(tradesRef);
                        transaction.set(playerTradeRef, { type: 'buy', coinSymbol: coinData.symbol, amountSsol: ssolToSpend, amountToken: tokensReceived, price: coinData.currentPrice, timestamp: serverTimestamp(), isWash: false });

                        transaction.update(coinRef, {
                            ...botUpdates, 
                            sSolPool: finalSsolPool, 
                            tokenPool: newTokenPool,
                            currentPrice: newPrice,
                            priceHistory: newHistory,
                            volume: newVolume,
                            volumeHistory: newVolumeHistory,
                            marketCap: newMarketCap,
                            holderCount: newHolderCount,
                            lastHolderCountChange: newLastHolderCountChange,
                            creatorFeesSsol: newCreatorFeesSsol,
                            allTimeHigh: newAllTimeHigh,
                            allTimeLow: newAllTimeLow,
                            followers: newFollowers
                        });
                    });
                    
                    showMessage(`¬°Compraste ${formatNumber(tokensReceived)} ${allCoinsCache.get(selectedCoinId).symbol}!`);
                    buyAmountEl.value = '';

                } catch (error) {
                    console.error("Error al comprar:", error);
                    showMessage(error.message);
                }
            });
            
            // Formulario de Venta
            sellFormEl.addEventListener('submit', async (e) => {
                e.preventDefault();
                const tokensToSell = parseFloat(sellAmountEl.value);
                
                if (!selectedCoinId || isNaN(tokensToSell) || tokensToSell <= 0) {
                    showMessage("Ingresa un monto v√°lido.");
                    return;
                }

                try {
                    await runTransaction(db, async (transaction) => {
                        const playerRef = doc(playersRef, currentUserId);
                        const coinRef = doc(roomRef, selectedCoinId);
                        const walletRef = doc(playersRef, currentUserId, 'wallet', selectedCoinId);

                        const [playerDoc, coinDoc, walletDoc] = await Promise.all([
                            transaction.get(playerRef),
                            transaction.get(coinRef),
                            transaction.get(walletRef)
                        ]);

                        if (!playerDoc.exists() || !coinDoc.exists()) {
                            throw new Error("No se encontraron datos del jugador o la moneda.");
                        }
                        
                        if (!walletDoc.exists() || walletDoc.data().amount < tokensToSell) {
                            throw new Error("No tienes suficientes tokens para vender.");
                        }

                        let playerData = playerDoc.data();
                        let coinData = coinDoc.data();
                        const walletData = walletDoc.data();

                        const botUpdates = simulateBotTrade(coinData, 'reactive_sell');
                        coinData = { ...coinData, ...botUpdates };
                        
                        const creatorFee = tokensToSell * CREATOR_FEE;
                        const lpFee = tokensToSell * LP_FEE;
                        const tokensForTrade = tokensToSell - creatorFee - lpFee;

                        const k = coinData.sSolPool * coinData.tokenPool;
                        const newTokenPool_k = coinData.tokenPool + tokensForTrade + lpFee;
                        const newSsolPool = k / newTokenPool_k;
                        const ssolReceived = coinData.sSolPool - newSsolPool;
                        
                        const finalTokenPool = newTokenPool_k;
                        const ssolTraded = ssolReceived; 

                        if (ssolReceived < 0.00001) {
                            throw new Error("La liquidez es demasiado baja para esta venta.");
                        }
                        
                        const newPrice = newSsolPool / finalTokenPool; 
                        const newAllTimeHigh = Math.max(coinData.allTimeHigh || 0, newPrice);
                        const newAllTimeLow = Math.min(coinData.allTimeLow || 999999, newPrice); 
                        const newMarketCap = newPrice * (finalTokenPool + coinData.botTokenPool);
                        const newHistory = [...coinData.priceHistory, newPrice].slice(-50);
                        const newVolumeHistory = [...(coinData.volumeHistory || []), ssolTraded].slice(-50);
                        const newVolume = coinData.volume + ssolTraded;
                        const newCreatorFeesToken = (coinData.creatorFeesToken || 0) + creatorFee;

                        let newHolderCount = coinData.holderCount;
                        let holderChange = 0;
                        const currentTokens = walletData.amount;
                        const newAmountInWallet = currentTokens - tokensToSell;
                        if (newAmountInWallet < 0.01 && currentTokens >= 0.01) { 
                            newHolderCount--;
                            holderChange = -1; 
                        }
                        const newLastHolderCountChange = (coinData.lastHolderCountChange || 0) + holderChange;
                        
                        transaction.update(playerRef, {
                            sSOL_balance: playerData.sSOL_balance + ssolReceived
                        });
                        
                        transaction.set(walletRef, {
                            amount: newAmountInWallet
                        }, { merge: true });
                        
                        if (botUpdates.tradeLog) {
                            const newTradeRef = doc(tradesRef);
                            transaction.set(newTradeRef, botUpdates.tradeLog);
                            delete botUpdates.tradeLog;
                        }
                        
                        const playerTradeRef = doc(tradesRef);
                        transaction.set(playerTradeRef, { type: 'sell', coinSymbol: coinData.symbol, amountSsol: ssolReceived, amountToken: tokensToSell, price: coinData.currentPrice, timestamp: serverTimestamp(), isWash: false });

                        transaction.update(coinRef, {
                             ...botUpdates, 
                            sSolPool: newSsolPool,
                            tokenPool: finalTokenPool,
                            currentPrice: newPrice,
                            priceHistory: newHistory,
                            volume: newVolume,
                            volumeHistory: newVolumeHistory,
                            marketCap: newMarketCap,
                            holderCount: newHolderCount,
                            lastHolderCountChange: newLastHolderCountChange,
                            creatorFeesToken: newCreatorFeesToken,
                            allTimeHigh: newAllTimeHigh,
                            allTimeLow: newAllTimeLow
                        });
                    });
                    
                    showMessage(`¬°Vendiste ${formatNumber(tokensToSell)} ${allCoinsCache.get(selectedCoinId).symbol}!`);
                    sellAmountEl.value = '';

                } catch (error) {
                    console.error("Error al vender:", error);
                    showMessage(error.message);
                }
            });
            
            // Listeners para botones de Venta R√°pida
            document.querySelectorAll('.sell-percent-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const percent = parseFloat(btn.dataset.percent);
                    const coin = myPortfolioCache.get(selectedCoinId);
                    if (coin) {
                        const amountToSell = coin.amount * percent;
                        sellAmountEl.value = amountToSell.toFixed(2);
                    } else {
                        showMessage("No tienes esta moneda en tu portafolio.");
                        sellAmountEl.value = '0';
                    }
                });
            });
            
            // --- NUEVAS FUNCIONES: P2P, PANEL DE CREADOR, TIENDA ---
            
            // Formulario de Enviar sSOL (P2P)
            sendSsolFormEl.addEventListener('submit', async (e) => {
                e.preventDefault();
                const amountToSend = parseFloat(sendSsolAmountEl.value);
                
                if (!targetPlayerId || isNaN(amountToSend) || amountToSend <= 0) {
                    showMessage("Monto inv√°lido.");
                    return;
                }
                
                try {
                    await runTransaction(db, async (transaction) => {
                        const senderRef = doc(playersRef, currentUserId);
                        const receiverRef = doc(playersRef, targetPlayerId);
                        
                        const [senderDoc, receiverDoc] = await Promise.all([
                            transaction.get(senderRef),
                            transaction.get(receiverRef)
                        ]);
                        
                        if (!senderDoc.exists() || !receiverDoc.exists()) {
                            throw new Error("No se encontr√≥ al remitente o destinatario.");
                        }
                        
                        const senderData = senderDoc.data();
                        if (senderData.sSOL_balance < amountToSend) {
                            throw new Error("sSOL insuficiente para enviar.");
                        }
                        
                        const receiverData = receiverDoc.data();
                        
                        // Actualizar balances
                        transaction.update(senderRef, {
                            sSOL_balance: senderData.sSOL_balance - amountToSend
                        });
                        transaction.update(receiverRef, {
                            sSOL_balance: receiverData.sSOL_balance + amountToSend
                        });
                    });
                    
                    showMessage(`¬°Enviaste ${formatNumber(amountToSend)} sSOL a ...${targetPlayerId.slice(-6)}!`);
                    hideModal(sendSsolModalEl);
                    sendSsolFormEl.reset();
                    
                } catch (error) {
                    console.error("Error al enviar sSOL:", error);
                    showMessage(error.message);
                }
            });
            
            // Mostrar Panel de Creador
            function showCreatorDashboard() {
                creatorCoinsListEl.innerHTML = '';
                let hasCoins = false;
                
                allCoinsCache.forEach((coin, coinId) => {
                    if (coin.creatorId === currentUserId) {
                        hasCoins = true;
                        const itemEl = document.createElement('div');
                        itemEl.className = 'bg-gray-800 p-3 rounded-lg';
                        itemEl.innerHTML = `
                            <div class="flex justify-between items-center mb-3">
                                <span class="font-semibold text-lg">${coin.name} (${coin.symbol})</span>
                                <button data-coin-id="${coinId}" class="go-live-btn ${coin.isLive ? 'bg-gray-600' : 'bg-red-600 hover:bg-red-700'} text-white font-bold py-2 px-3 rounded-md text-sm transition">
                                    ${coin.isLive ? 'EN VIVO' : 'Ir en Vivo'}
                                </button>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <!-- Columna de Comisiones -->
                                <div class="bg-gray-700/50 p-3 rounded-lg">
                                    <h4 class="font-semibold mb-2">Comisiones Ganadas</h4>
                                    <div class="text-sm text-gray-300">
                                        sSOL: <span id="fee-ssol-${coinId}">${formatNumber(coin.creatorFeesSsol)}</span>
                                    </div>
                                    <div class="text-sm text-gray-300">
                                        ${coin.symbol}: <span id="fee-token-${coinId}">${formatNumber(coin.creatorFeesToken)}</span>
                                    </div>
                                    <button data-coin-id="${coinId}" class="claim-fee-btn w-full mt-2 bg-solana-green text-gray-900 font-bold py-2 px-3 rounded-md text-sm hover:bg-opacity-80 transition">
                                        Reclamar
                                    </button>
                                </div>
                                
                                <!-- Columna de Bots de Volumen -->
                                <div class="bg-gray-700/50 p-3 rounded-lg">
                                    <h4 class="font-semibold mb-2">Bots de Volumen</h4>
                                    <div class="text-sm text-gray-300 mb-2">
                                        Presupuesto: ${formatNumber(coin.washTradeBudget || 0)} sSOL
                                    </div>
                                    <form class="wash-trade-form flex gap-2" data-coin-id="${coinId}">
                                        <input type="number" step="0.1" min="0.1" placeholder="sSOL" class="w-full px-2 py-1 bg-gray-800 border border-gray-600 rounded-md text-sm">
                                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-md text-sm">
                                            A√±adir
                                        </button>
                                    </form>
                                </div>
                            </div>
                        `;
                        creatorCoinsListEl.appendChild(itemEl);
                    }
                });
                
                if (!hasCoins) {
                    creatorCoinsListEl.innerHTML = '<p class="text-gray-400 text-center">No has creado ninguna moneda.</p>';
                }
                
                // A√±adir listeners a los botones del panel
                creatorCoinsListEl.querySelectorAll('.claim-fee-btn').forEach(btn => btn.addEventListener('click', (e) => claimFees(e.target.dataset.coinId, e.target)));
                creatorCoinsListEl.querySelectorAll('.go-live-btn').forEach(btn => btn.addEventListener('click', (e) => toggleLive(e.target.dataset.coinId, e.target)));
                creatorCoinsListEl.querySelectorAll('.wash-trade-form').forEach(form => form.addEventListener('submit', (e) => addWashTradeBudget(e, e.target.dataset.coinId)));
                
                showModal(creatorDashboardModalEl);
            }
            
            // L√≥gica para Reclamar Comisiones
            async function claimFees(coinId, btn) {
                const coin = allCoinsCache.get(coinId);
                if (!coin || (coin.creatorFeesSsol < 0.0001 && coin.creatorFeesToken < 0.0001)) {
                    throw new Error("No hay comisiones que reclamar.");
                }
                
                btn.disabled = true;
                btn.textContent = '...';
                
                const ssolToClaim = coin.creatorFeesSsol;
                const tokensToClaim = coin.creatorFeesToken;
                
                try {
                    await runTransaction(db, async (transaction) => {
                        const coinRef = doc(roomRef, coinId);
                        const playerRef = doc(playersRef, currentUserId);
                        const walletRef = doc(playersRef, currentUserId, 'wallet', coinId);
                        
                        const [coinDoc, playerDoc, walletDoc] = await Promise.all([
                            transaction.get(coinRef),
                            transaction.get(playerRef),
                            transaction.get(walletRef)
                        ]);
                        
                        if (!coinDoc.exists() || !playerDoc.exists()) throw new Error("No se encontraron datos.");
                        
                        const coinData = coinDoc.data();
                        const playerData = playerDoc.data();
                        const walletData = walletDoc.exists() ? walletDoc.data() : { amount: 0 };
                        
                        if (coinData.creatorFeesSsol < ssolToClaim || coinData.creatorFeesToken < tokensToClaim) {
                             throw new Error("Conflicto de transacci√≥n, intenta de nuevo.");
                        }
                        
                        transaction.update(coinRef, { creatorFeesSsol: 0, creatorFeesToken: 0 });
                        transaction.update(playerRef, { sSOL_balance: playerData.sSOL_balance + ssolToClaim });
                        transaction.set(walletRef, { amount: walletData.amount + tokensToClaim }, { merge: true });
                    });
                    
                    showMessage("¬°Comisiones reclamadas!");
                    document.getElementById(`fee-ssol-${coinId}`).textContent = "0";
                    document.getElementById(`fee-token-${coinId}`).textContent = "0";
                    btn.textContent = "Reclamado";

                } catch (e) {
                    showMessage(e.message);
                    btn.disabled = false;
                    btn.textContent = "Reclamar";
                }
            }
            
            // L√≥gica para "Go Live"
            async function toggleLive(coinId, btn) {
                const coin = allCoinsCache.get(coinId);
                const newState = !coin.isLive;
                
                btn.disabled = true;
                btn.textContent = '...';
                
                try {
                    const coinRef = doc(roomRef, coinId);
                    await updateDoc(coinRef, {
                        isLive: newState,
                        liveViewers: newState ? 50 + Math.floor(Math.random() * 50) : 0 // Viewers iniciales
                    });
                    showMessage(newState ? "¬°Est√°s en vivo!" : "Directo finalizado.");
                    btn.textContent = newState ? "EN VIVO" : "Ir en Vivo";
                    btn.classList.toggle('bg-gray-600', newState);
                    btn.classList.toggle('bg-red-600', !newState);
                    btn.disabled = false;
                } catch (e) {
                    showMessage(e.message);
                    btn.disabled = false;
                }
            }
            
            // L√≥gica para "Wash Trade" (Bots de Volumen)
            async function addWashTradeBudget(e, coinId) {
                e.preventDefault();
                const form = e.target;
                const input = form.querySelector('input');
                const btn = form.querySelector('button');
                const amount = parseFloat(input.value);
                
                if (isNaN(amount) || amount <= 0) {
                    showMessage("Monto inv√°lido.");
                    return;
                }
                
                btn.disabled = true;
                btn.textContent = '...';
                
                try {
                    await runTransaction(db, async (transaction) => {
                        const playerRef = doc(playersRef, currentUserId);
                        const coinRef = doc(roomRef, coinId);
                        
                        const [playerDoc, coinDoc] = await Promise.all([
                            transaction.get(playerRef),
                            transaction.get(coinRef)
                        ]);
                        
                        if (!playerDoc.exists() || !coinDoc.exists()) throw new Error("Datos no encontrados.");
                        
                        const playerData = playerDoc.data();
                        if (playerData.sSOL_balance < amount) throw new Error("sSOL insuficiente.");
                        
                        const coinData = coinDoc.data();
                        
                        transaction.update(playerRef, { sSOL_balance: playerData.sSOL_balance - amount });
                        transaction.update(coinRef, { washTradeBudget: (coinData.washTradeBudget || 0) + amount });
                    });
                    
                    showMessage(`¬°${formatNumber(amount)} sSOL a√±adidos al bot de volumen!`);
                    input.value = '';
                    
                } catch (e) {
                    showMessage(e.message);
                }
                
                btn.disabled = false;
                btn.textContent = 'A√±adir';
            }
            
            // L√≥gica de "Live Stream"
            function showLiveStream() {
                if (!selectedCoinId) return;
                const coin = allCoinsCache.get(selectedCoinId);
                if (!coin) return;
                
                liveCoinNameEl.textContent = `LIVE: ${coin.name}`;
                liveViewersEl.textContent = formatNumber(coin.liveViewers || 0);
                showModal(liveStreamModalEl);
                
                // Actualizar viewers (simulaci√≥n)
                const coinRef = doc(roomRef, selectedCoinId);
                onSnapshot(coinRef, (doc) => {
                    if (doc.exists() && doc.data().isLive) {
                        liveViewersEl.textContent = formatNumber(doc.data().liveViewers || 0);
                    } else {
                        hideModal(liveStreamModalEl);
                    }
                });
            }
            
            async function boostLiveStream() {
                if (!selectedCoinId) return;
                const boostCost = 0.1;
                
                boostLiveBtnEl.disabled = true;
                boostLiveBtnEl.textContent = '...';
                
                try {
                    await runTransaction(db, async (transaction) => {
                        const playerRef = doc(playersRef, currentUserId);
                        const coinRef = doc(roomRef, selectedCoinId);
                        
                        const [playerDoc, coinDoc] = await Promise.all([
                            transaction.get(playerRef),
                            transaction.get(coinRef)
                        ]);
                        
                        if (!playerDoc.exists() || !coinDoc.exists()) throw new Error("Datos no encontrados.");
                        
                        const playerData = playerDoc.data();
                        if (playerData.sSOL_balance < boostCost) throw new Error("sSOL insuficiente para el boost.");
                        
                        const newViewers = (coinDoc.data().liveViewers || 0) + 100 + Math.floor(Math.random() * 200);
                        
                        transaction.update(playerRef, { sSOL_balance: playerData.sSOL_balance - boostCost });
                        transaction.update(coinRef, { liveViewers: newViewers });
                    });
                    
                    showMessage("¬°Boost aplicado! M√°s viewers est√°n entrando.");
                    
                } catch (e) {
                    showMessage(e.message);
                }
                
                boostLiveBtnEl.disabled = false;
                boostLiveBtnEl.textContent = 'Pagar Boost (0.1 sSOL)';
            }
            
            // L√≥gica de Tienda de Lujo
            document.querySelectorAll('#buy-lambo-btn, #buy-mansion-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const item = e.target.dataset.item;
                    const cost = parseFloat(e.target.dataset.cost);
                    
                    e.target.disabled = true;
                    e.target.textContent = '...';
                    
                    try {
                        await runTransaction(db, async (transaction) => {
                            const playerRef = doc(playersRef, currentUserId);
                            const playerDoc = await transaction.get(playerRef);
                            if (!playerDoc.exists()) throw new Error("No se encontr√≥ al jugador.");
                            
                            const playerData = playerDoc.data();
                            if (playerData.sSOL_balance < cost) throw new Error("sSOL insuficiente.");
                            
                            const newBalance = playerData.sSOL_balance - cost;
                            const currentItemCount = playerData.assets && playerData.assets[item] ? playerData.assets[item] : 0;
                            
                            // Usar notaci√≥n de puntos para actualizar un campo de mapa
                            transaction.update(playerRef, {
                                sSOL_balance: newBalance,
                                [`assets.${item}`]: currentItemCount + 1
                            });
                        });
                        
                        showMessage(`¬°Felicidades! ¬°Compraste un ${item === 'lambo' ? 'Lambo' : 'Mansi√≥n'}!`);
                        
                    } catch (e) {
                        showMessage(e.message);
                    }
                    
                    e.target.disabled = false;
                    e.target.innerHTML = e.target.dataset.item === 'lambo' ? 'Comprar Lambo <br>(5 sSOL)' : 'Comprar Mansi√≥n <br>(20 sSOL)';
                });
            });


            // --- INICIAR EL JUEGO ---
            initAuth();
            initChart();
            
            setTimeout(proactiveBotLoop, 5000); 
            setTimeout(washTradeBotLoop, 3000); // Iniciar el bucle de bots de volumen
            
            showMessage("¬°Bienvenido! Nuevas funciones: Live, Boost, Bots de Volumen y Tienda de Lujo.");
        
        } // --- FIN: ENVOLTORIO MAIN ASYNC ---

        // Llamar a la funci√≥n principal para iniciar todo
        main().catch(err => {
            console.error("Error fatal al iniciar la aplicaci√≥n:", err);
            const messageModalEl = document.getElementById('message-modal');
            const messageTextEl = document.getElementById('message-text');
            if (messageTextEl && messageModalEl) {
                messageTextEl.textContent = "Error fatal al iniciar. Revisa la consola.";
                messageModalEl.classList.remove('hidden');
            }
        });

    </script>
</body>
</html>

