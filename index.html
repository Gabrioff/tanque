<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Solana Memecoin Simulator</title>
    <!-- Cargar Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Cargar Chart.js (para las gr√°ficas) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Cargar anotaciones de Chart.js (para las l√≠neas de compra/venta) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/3.0.1/chartjs-plugin-annotation.min.js"></script>
    <!-- Iconos Phosphor (para el icono de X y la UI) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Configuraci√≥n de Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'solana-green': '#14F195',
                        'solana-purple': '#9945FF',
                        'x-blue': '#1DA1F2', // Color de Twitter/X
                        'page-bg': '#111827', // gray-900
                        'item-bg': '#1F2937', // gray-800
                        'item-hover': '#374151', // gray-700
                    },
                    keyframes: {
                        livePulse: {
                            '0%, 100%': { opacity: 1, boxShadow: '0 0 5px #F11414' },
                            '50%': { opacity: 0.6, boxShadow: '0 0 15px 5px #F11414' },
                        },
                        liveScreen: {
                            '0%, 100%': { backgroundColor: 'rgba(239, 68, 68, 0.2)' },
                            '50%': { backgroundColor: 'rgba(34, 197, 94, 0.2)' },
                        },
                        shimmer: {
                            '0%': { backgroundPosition: '-1000px 0' },
                            '100%': { backgroundPosition: '1000px 0' },
                        },
                    },
                    animation: {
                        livePulse: 'livePulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        liveScreen: 'liveScreen 1.5s ease-in-out infinite',
                        shimmer: 'shimmer 1.5s infinite linear',
                    }
                }
            }
        }
    </script>
    <style>
        /* Estilo para la barra de scroll */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #374151; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #718096; }

        .glassmorphism {
            background: rgba(31, 41, 55, 0.7); /* item-bg con transparencia */
            backdrop-filter: blur(10px);
            border: 1px solid rgba(55, 65, 81, 0.5); /* item-hover con transparencia */
        }

        .modal { transition: opacity 0.25s ease, visibility 0.25s ease; }
        .modal-content { transition: transform 0.25s ease; }

        /* Estilo para Popover de X */
        .x-popover-container { position: relative; display: inline-block; }
        .x-popover {
            position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%) translateY(-10px);
            z-index: 100; opacity: 0; visibility: hidden; transition: all 0.2s ease;
            width: 250px; pointer-events: none;
        }
        .x-popover-container:hover .x-popover { opacity: 1; visibility: visible; pointer-events: auto; transform: translateX(-50%) translateY(0); }

        /* Estilo para la barra de navegaci√≥n inferior */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 40;
            background: rgba(31, 41, 55, 0.9); /* item-bg con blur */
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(55, 65, 81, 0.5);
        }
        .nav-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            flex-grow: 1; padding: 8px 0; color: #9CA3AF; /* gray-400 */
            transition: color 0.2s ease;
            width: 0; /* Asegura que flex-grow distribuya el espacio */
        }
        .nav-btn.active { color: #14F195; /* solana-green */ }
        .nav-btn i { font-size: 24px; }
        .nav-btn span { font-size: 10px; margin-top: 2px; }

        /* Contenedor principal de la p√°gina con padding para la barra de navegaci√≥n */
        .page-container {
            padding-bottom: 60px; /* Altura de la barra de navegaci√≥n */
            flex-grow: 1;
        }
        .page {
            padding: 1rem; /* p-4 */
            display: none; /* Oculto por defecto */
        }
        .page.active {
            display: block; /* Visible */
        }

        /* Estilo para el Chat Global */
        #chat-messages {
            scroll-behavior: smooth;
        }
        /* Ocultar scrollbar de mensajes pero mantener scroll */
        #chat-messages::-webkit-scrollbar { display: none; }
        #chat-messages { -ms-overflow-style: none; scrollbar-width: none; }

        /* Estilos para la Oficina */
        #office-layout {
            position: relative;
            width: 100%;
            max-width: 600px; /* Ancho m√°ximo de la oficina */
            height: 400px; /* Altura fija */
            background: url('https://placehold.co/600x400/1F2937/374151?text=Tu+Oficina') center center / cover no-repeat;
            border-radius: 0.5rem;
            border: 2px solid #374151;
            margin: auto;
        }
        .office-item {
            position: absolute;
            font-size: 3rem; /* Tama√±o de los emojis */
            user-select: none;
        }

        /* Estilo para la Tarjeta PnL (Fondo oscuro) */
        #pnl-card-content {
            background-color: #1F2937; /* item-bg */
        }
        .pnl-value-positive { color: #22C55E; } /* green-500 */
        .pnl-value-negative { color: #EF4444; } /* red-500 */

    </style>
</head>
<body class="bg-page-bg text-white font-sans antialiased flex flex-col min-h-screen">

    <!-- Encabezado Fijo -->
    <header class="bg-item-bg shadow-lg sticky top-0 z-30">
        <nav class="container mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-xl lg:text-2xl font-bold text-solana-green">
                üöÄ Solana Memecoin Sim
            </h1>
            <div class="flex items-center space-x-4">
                <button id="show-create-modal-btn" class="bg-solana-purple hover:bg-opacity-80 text-white font-bold p-2 rounded-full transition duration-200">
                    <i class="ph ph-plus text-xl"></i>
                </button>
                <div class="text-right">
                    <div class="text-sm text-gray-400">Balance</div>
                    <div id="ssol-balance" class="text-lg font-semibold text-solana-green">2.00 sSOL</div>
                </div>
            </div>
        </nav>
        <div id="player-id-banner" class="bg-solana-purple text-center py-1 px-4 text-xs font-mono">
            Cargando tu ID de jugador...
        </div>
    </header>

    <!-- Contenedor Principal de P√°ginas -->
    <main class="container mx-auto page-container">

        <!-- P√ÅGINA 1: MERCADO (Home) -->
        <section id="page-mercado" class="page active">
            <div class="mb-3">
                <input type="text" id="coin-filter-input" placeholder="Filtrar por nombre o s√≠mbolo..." class="w-full px-3 py-2 bg-item-bg border border-item-hover rounded-md focus:outline-none focus:ring-2 focus:ring-solana-purple">
            </div>
            <div id="memecoin-list" class="flex-grow overflow-y-auto space-y-2 pr-2">
                <p class="text-gray-400">No hay monedas. ¬°Lanza la primera!</p>
            </div>
        </section>

        <!-- P√ÅGINA 2: PORTAFOLIO -->
        <section id="page-portafolio" class="page">
            <h2 class="text-xl font-semibold mb-3 border-b border-gray-700 pb-2">Mi Portafolio</h2>
            <div id="portfolio-list" class="space-y-2 pr-2 mb-6">
                <p class="text-gray-400">A√∫n no tienes monedas.</p>
            </div>
        </section>

        <!-- P√ÅGINA 3: FEED SOCIAL -->
        <section id="page-social" class="page">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Feed Social</h2>
                <div>
                    <button id="show-my-profile-btn" class="bg-item-hover hover:bg-gray-600 text-white font-bold py-2 px-3 rounded-md transition duration-200 text-sm mr-2">
                        Mi Perfil
                    </button>
                    <button id="create-social-post-btn" class="bg-solana-purple hover:bg-opacity-80 text-white font-bold py-2 px-3 rounded-md transition duration-200 text-sm">
                        Crear Post
                    </button>
                </div>
            </div>
            <div id="social-feed-list" class="space-y-3">
                <p class="text-gray-400">Cargando feed...</p>
            </div>
        </section>

        <!-- P√ÅGINA 4: TIENDA -->
        <section id="page-tienda" class="page">
            <h2 class="text-xl font-semibold mb-3 border-b border-gray-700 pb-2">Tienda de Lujo</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <!-- Art√≠culos de Lujo -->
                <div class="glassmorphism rounded-lg shadow-xl p-4 flex flex-col items-center text-center">
                    <span class="text-6xl mb-2">üèéÔ∏è</span>
                    <h3 class="text-2xl font-bold mb-1">Lambo</h3>
                    <p class="text-lg font-semibold text-solana-green mb-3">5.00 sSOL</p>
                    <button data-item="lambo" data-cost="5" data-category="assets" class="buy-asset-btn w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 px-3 rounded-md transition duration-200 text-sm">
                        Comprar
                    </button>
                </div>
                <div class="glassmorphism rounded-lg shadow-xl p-4 flex flex-col items-center text-center">
                    <span class="text-6xl mb-2">üè∞</span>
                    <h3 class="text-2xl font-bold mb-1">Mansi√≥n</h3>
                    <p class="text-lg font-semibold text-solana-green mb-3">20.00 sSOL</p>
                    <button data-item="mansion" data-cost="20" data-category="assets" class="buy-asset-btn w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-3 rounded-md transition duration-200 text-sm">
                        Comprar
                    </button>
                </div>
                 <div class="glassmorphism rounded-lg shadow-xl p-4 flex flex-col items-center text-center">
                    <span class="text-6xl mb-2">üõ•Ô∏è</span>
                    <h3 class="text-2xl font-bold mb-1">Yate</h3>
                    <p class="text-lg font-semibold text-solana-green mb-3">50.00 sSOL</p>
                    <button data-item="yate" data-cost="50" data-category="assets" class="buy-asset-btn w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 rounded-md transition duration-200 text-sm">
                        Comprar
                    </button>
                </div>
                <div class="glassmorphism rounded-lg shadow-xl p-4 flex flex-col items-center text-center">
                    <span class="text-6xl mb-2">‚úàÔ∏è</span>
                    <h3 class="text-2xl font-bold mb-1">Jet Privado</h3>
                    <p class="text-lg font-semibold text-solana-green mb-3">100.00 sSOL</p>
                    <button data-item="jet" data-cost="100" data-category="assets" class="buy-asset-btn w-full bg-gray-300 hover:bg-gray-400 text-gray-900 font-bold py-2 px-3 rounded-md transition duration-200 text-sm">
                        Comprar
                    </button>
                </div>
            </div>

            <h2 class="text-xl font-semibold mb-3 border-b border-gray-700 pb-2">Tienda de Oficina</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Art√≠culos de Oficina -->
                <div class="glassmorphism rounded-lg shadow-xl p-4 flex flex-col items-center text-center">
                    <span class="text-6xl mb-2">üñ•Ô∏è</span>
                    <h3 class="text-2xl font-bold mb-1">PC Gamer</h3>
                    <p class="text-lg font-semibold text-solana-green mb-3">3.00 sSOL</p>
                    <button data-item="pc" data-cost="3" data-category="office" data-emoji="üñ•Ô∏è" data-pos="bottom: 20%; left: 15%;" class="buy-asset-btn w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-3 rounded-md transition duration-200 text-sm">
                        Comprar
                    </button>
                </div>
                <div class="glassmorphism rounded-lg shadow-xl p-4 flex flex-col items-center text-center">
                    <span class="text-6xl mb-2">üì∫</span>
                    <h3 class="text-2xl font-bold mb-1">Monitor Curvo</h3>
                    <p class="text-lg font-semibold text-solana-green mb-3">1.50 sSOL</p>
                    <button data-item="monitor" data-cost="1.5" data-category="office" data-emoji="üì∫" data-pos="bottom: 22%; left: 40%;" class="buy-asset-btn w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-3 rounded-md transition duration-200 text-sm">
                        Comprar
                    </button>
                </div>
                <div class="glassmorphism rounded-lg shadow-xl p-4 flex flex-col items-center text-center">
                    <span class="text-6xl mb-2">ü™ë</span>
                    <h3 class="text-2xl font-bold mb-1">Silla Ergon√≥mica</h3>
                    <p class="text-lg font-semibold text-solana-green mb-3">1.00 sSOL</p>
                    <button data-item="silla" data-cost="1" data-category="office" data-emoji="ü™ë" data-pos="bottom: 10%; left: 65%;" class="buy-asset-btn w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-2 px-3 rounded-md transition duration-200 text-sm">
                        Comprar
                    </button>
                </div>
            </div>
        </section>

        <!-- P√ÅGINA 5: JUGADORES -->
        <section id="page-jugadores" class="page">
            <h2 class="text-xl font-semibold mb-3 border-b border-gray-700 pb-2">Jugadores en la Sala</h2>
            <div id="players-list" class="overflow-y-auto space-y-2 pr-2">
                <p class="text-gray-400">Cargando jugadores...</p>
            </div>
        </section>

        <!-- P√ÅGINA 6: OFICINA -->
        <section id="page-oficina" class="page">
            <h2 class="text-xl font-semibold mb-3 border-b border-gray-700 pb-2">Mi Oficina</h2>
            <div id="office-layout" class="shadow-inner mb-4">
                <!-- Los art√≠culos de la oficina se a√±adir√°n aqu√≠ con JS -->
            </div>
            <h3 class="text-lg font-semibold mb-2">Mis Activos de Oficina</h3>
            <div id="my-office-assets-list" class="flex flex-wrap gap-2">
                <p class="text-gray-400 text-sm">A√∫n no tienes art√≠culos de oficina.</p>
            </div>

            <h3 class="text-lg font-semibold mb-2 mt-6">Mis Activos de Lujo</h3>
            <div id="my-luxury-assets-list" class="flex flex-wrap gap-2">
                <p class="text-gray-400 text-sm">A√∫n no tienes activos de lujo.</p>
            </div>
        </section>

        <!-- P√ÅGINA 7: CHAT GLOBAL -->
        <section id="page-chat" class="page flex flex-col h-full" style="padding: 0.5rem; max-height: calc(100vh - 120px); /* Altura total menos header y nav */">
            <h2 class="text-xl font-semibold mb-3 border-b border-gray-700 pb-2 px-2">Chat Global</h2>
            <!-- Contenedor de mensajes -->
            <div id="chat-messages" class="flex-grow overflow-y-auto space-y-3 p-2 bg-item-bg/50 rounded-lg">
                <p class="text-gray-400 text-center text-sm">Cargando mensajes...</p>
            </div>
            <!-- Formulario de env√≠o -->
            <form id="chat-form" class="flex gap-2 mt-3 p-2">
                <input type="text" id="chat-input" placeholder="Escribe un mensaje..." class="flex-grow px-3 py-2 bg-item-bg border border-item-hover rounded-md focus:outline-none focus:ring-2 focus:ring-solana-purple" required>
                <button type="submit" class="bg-solana-purple hover:bg-opacity-80 text-white font-bold p-2 rounded-md transition duration-200">
                    <i class="ph ph-paper-plane-tilt text-xl"></i>
                </button>
            </form>
        </section>


    </main>

    <!-- Barra de Navegaci√≥n Inferior -->
    <nav class="bottom-nav flex shadow-lg">
        <button class="nav-btn active" data-page="page-mercado" title="Mercado">
            <i class="ph ph-chart-line-up"></i>
            <span class="hidden sm:inline">Mercado</span>
        </button>
        <button class="nav-btn" data-page="page-portafolio" title="Portafolio">
            <i class="ph ph-wallet"></i>
            <span class="hidden sm:inline">Portafolio</span>
        </button>
        <button class="nav-btn" data-page="page-social" title="Feed Social">
            <i class="ph ph-user-sound"></i>
            <span class="hidden sm:inline">Feed</span>
        </button>
        <button class="nav-btn" data-page="page-chat" title="Chat Global">
            <i class="ph ph-chats-circle"></i>
            <span class="hidden sm:inline">Chat</span>
        </button>
        <button class="nav-btn" data-page="page-tienda" title="Tienda">
            <i class="ph ph-storefront"></i>
            <span class="hidden sm:inline">Tienda</span>
        </button>
        <button class="nav-btn" data-page="page-oficina" title="Mi Oficina">
            <i class="ph ph-desktop-tower"></i>
            <span class="hidden sm:inline">Oficina</span>
        </button>
        <button class="nav-btn" data-page="page-jugadores" title="Jugadores">
            <i class="ph ph-users"></i>
            <span class="hidden sm:inline">Jugadores</span>
        </button>
    </nav>


    <!-- MODALES (siguen existiendo, pero se llaman desde las p√°ginas) -->

    <!-- Modal para Mensajes Simples -->
    <div id="message-modal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden opacity-0 visibility-hidden">
        <div class="modal-content glassmorphism p-6 rounded-lg shadow-2xl max-w-sm mx-auto text-center transform scale-95">
            <p id="message-text" class="text-lg mb-4">Mensaje</p>
            <button id="close-message-btn" class="bg-solana-purple hover:bg-opacity-80 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                Cerrar
            </button>
        </div>
    </div>

    <!-- Modal para Crear Moneda -->
    <div id="create-coin-modal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden opacity-0 visibility-hidden p-4">
        <div class="modal-content glassmorphism p-6 rounded-lg shadow-2xl max-w-md w-full text-center transform scale-95 overflow-y-auto max-h-full">
            <div class="flex justify-between items-center mb-3 border-b border-gray-700 pb-2">
                <h2 class="text-xl font-semibold">Lanzar Nueva Memecoin</h2>
                <button id="close-create-modal-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <form id="create-coin-form" class="space-y-3 text-left">
                <!-- ... (campos de crear moneda sin cambios) ... -->
                <div>
                    <label for="coin-name" class="block text-sm font-medium text-gray-300">Nombre (Ej: DogeWifHat)</label>
                    <input type="text" id="coin-name" required class="w-full mt-1 px-3 py-2 bg-gray-900 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-solana-purple" maxlength="20">
                </div>
                <div>
                    <label for="coin-symbol" class="block text-sm font-medium text-gray-300">S√≠mbolo (Ej: WIF)</label>
                    <input type="text" id="coin-symbol" required class="w-full mt-1 px-3 py-2 bg-gray-900 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-solana-purple" maxlength="5" autocapitalize="characters">
                </div>
                <div>
                    <label for="coin-image-url" class="block text-sm font-medium text-gray-300">URL de Imagen</label>
                    <input type="url" id="coin-image-url" placeholder="https://..." class="w-full mt-1 px-3 py-2 bg-gray-900 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-solana-purple">
                </div>
                <div>
                    <label for="coin-x-url" class="block text-sm font-medium text-gray-300">URL de X (Twitter)</label>
                    <input type="url" id="coin-x-url" placeholder="https://x.com/yourcoin" class="w-full mt-1 px-3 py-2 bg-gray-900 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-x-blue">
                </div>
                <div class="grid grid-cols-2 gap-2">
                     <div>
                        <label for="coin-initial-ssol" class="block text-sm font-medium text-gray-300">sSOL Inicial (Liq.)</label>
                        <input type="number" id="coin-initial-ssol" step="0.01" min="0.01" required placeholder="0.1" class="w-full mt-1 px-3 py-2 bg-gray-900 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-solana-purple">
                    </div>
                     <div>
                        <label for="coin-initial-tokens" class="block text-sm font-medium text-gray-300">Tokens (Liq.)</label>
                        <input type="number" id="coin-initial-tokens" step="1000" min="1000" required placeholder="1000000" class="w-full mt-1 px-3 py-2 bg-gray-900 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-solana-purple">
                    </div>
                </div>
                <button type="submit" class="w-full bg-solana-purple hover:bg-opacity-80 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                    Lanzar (Costo: 0.01 sSOL + Liq.)
                </button>
            </form>
        </div>
    </div>

    <!-- Modal para Gr√°fica y Trading -->
    <div id="chart-modal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden opacity-0 visibility-hidden p-4">
        <div class="modal-content glassmorphism p-6 rounded-lg shadow-2xl max-w-3xl w-full text-center transform scale-95 overflow-y-auto max-h-full">
            <!-- ... (contenido del modal de gr√°fica) ... -->
            <div class="flex justify-between items-center mb-3 border-b border-gray-700 pb-2">
                 <div class="flex items-center gap-2">
                     <h2 id="modal-coin-name" class="text-2xl font-bold text-solana-green"></h2>
                     <span id="modal-live-badge" class="hidden animate-livePulse text-xs font-bold bg-red-600 text-white px-2 py-0.5 rounded-md">LIVE</span>
                 </div>
                <button id="close-chart-modal-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>

            <p id="modal-coin-price" class="text-xl font-mono text-center text-gray-300 mb-4">$0.00</p>
            <p id="modal-contract-id" class="text-sm font-mono text-center text-gray-500 mb-4">ID de Contrato: ...</p>

            <div class="relative h-48 md:h-72 mb-4">
                <canvas id="coin-chart-modal"></canvas>
            </div>

            <div class="flex gap-2 mb-4 w-full justify-center">
                <button id="view-live-btn" class="hidden w-1/2 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                    Ver Directo
                </button>
                <button id="show-pnl-modal-btn" class="w-1/2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                    Ver PnL
                </button>
            </div>


            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <form id="buy-form-modal" class="space-y-2 glassmorphism p-4 rounded-lg">
                    <label for="buy-amount-ssol-modal" class="block text-sm font-medium text-gray-300">Gastar (sSOL) - Fee 0.3%</label>
                    <input type="text" id="buy-amount-ssol-modal" inputmode="decimal" placeholder="0.1" class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-solana-green" required>
                    <button type="submit" class="w-full bg-solana-green hover:bg-opacity-80 text-gray-900 font-bold py-2 px-4 rounded-md transition duration-200">
                        Comprar
                    </button>
                </form>

                <form id="sell-form-modal" class="space-y-2 glassmorphism p-4 rounded-lg">
                    <label for="sell-amount-token-modal" class="block text-sm font-medium text-gray-300">Vender (Tokens) - Fee 0.3%</label>
                    <input type="text" id="sell-amount-token-modal" inputmode="decimal" placeholder="1000" class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500" required>
                    <div class="grid grid-cols-3 gap-2 text-xs">
                        <button type="button" class="sell-percent-btn bg-gray-700 hover:bg-gray-600 py-1 rounded" data-percent="0.10">10%</button>
                        <button type="button" class="sell-percent-btn bg-gray-700 hover:bg-gray-600 py-1 rounded" data-percent="0.50">50%</button>
                        <button type="button" class="sell-percent-btn bg-gray-700 hover:bg-gray-600 py-1 rounded" data-percent="1.00">100%</button>
                    </div>
                    <button type="submit" class="w-full bg-red-600 hover:bg-opacity-80 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                        Vender
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para Panel de Creador -->
    <div id="creator-dashboard-modal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden opacity-0 visibility-hidden p-4">
        <div class="modal-content glassmorphism p-6 rounded-lg shadow-2xl max-w-4xl w-full text-center transform scale-95 overflow-y-auto max-h-full">
            <!-- ... (contenido del panel de creador) ... -->
            <div class="flex justify-between items-center mb-3 border-b border-gray-700 pb-2">
                <h2 class="text-xl font-semibold">Panel de Creador</h2>
                <button id="close-creator-dashboard-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="creator-coins-list" class="space-y-4 text-left">
                <p class="text-gray-400 text-center">No has creado ninguna moneda.</p>
            </div>
        </div>
    </div>

    <!-- Modal para Enviar sSOL (P2P) -->
    <div id="send-ssol-modal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden opacity-0 visibility-hidden p-4">
        <div class="modal-content glassmorphism p-6 rounded-lg shadow-2xl max-w-md w-full text-center transform scale-95">
            <!-- ... (contenido de enviar sSOL) ... -->
            <div class="flex justify-between items-center mb-3 border-b border-gray-700 pb-2">
                <h2 class="text-xl font-semibold">Enviar sSOL</h2>
                <button id="close-send-ssol-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <form id="send-ssol-form" class="space-y-3 text-left">
                <p class="text-sm">Enviar a: <strong id="send-ssol-target-name" class="font-mono text-solana-green">...</strong></p>
                <div>
                    <label for="send-ssol-amount" class="block text-sm font-medium text-gray-300">Monto (sSOL)</label>
                    <input type="number" id="send-ssol-amount" step="0.01" min="0.01" required placeholder="0.1" class="w-full mt-1 px-3 py-2 bg-gray-900 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-solana-purple">
                </div>
                <button type="submit" class="w-full bg-solana-purple hover:bg-opacity-80 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                    Confirmar Env√≠o
                </button>
            </form>
        </div>
    </div>

    <!-- Modal para "Live Stream" -->
    <div id="live-stream-modal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden opacity-0 visibility-hidden p-4">
        <div class="modal-content glassmorphism p-6 rounded-lg shadow-2xl max-w-2xl w-full text-center transform scale-95">
            <!-- ... (contenido de live stream) ... -->
            <div class="flex justify-between items-center mb-3 border-b border-gray-700 pb-2">
                <h2 id="live-coin-name" class="text-xl font-semibold text-red-500 animate-pulse">LIVE: ...</h2>
                <button id="close-live-stream-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="w-full h-64 bg-black rounded-lg mb-4 animate-liveScreen border-2 border-gray-700 flex items-center justify-center">
                <span class="text-3xl font-bold text-gray-500">SIMULACI√ìN DE LIVE</span>
            </div>
            <div class="flex justify-between items-center mb-3">
                <div class="text-lg">Espectadores: <span id="live-viewers" class="font-bold text-solana-green">...</span></div>
                <div class="flex space-x-2">
                    <button id="boost-live-btn-small" data-boost-level="small" class="boost-live-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-md text-sm transition">
                        Boost (0.1 sSOL)
                    </button>
                    <button id="boost-live-btn-medium" data-boost-level="medium" class="boost-live-btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-md text-sm transition">
                        Boost (1 sSOL)
                    </button>
                    <button id="boost-live-btn-large" data-boost-level="large" class="boost-live-btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-3 rounded-md text-sm transition">
                        Boost (10 sSOL)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para MI PERFIL (antes Editar Perfil) -->
    <div id="my-profile-modal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden opacity-0 visibility-hidden p-4">
        <div class="modal-content glassmorphism p-6 rounded-lg shadow-2xl max-w-md w-full text-center transform scale-95 overflow-y-auto max-h-full">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-xl font-semibold">Mi Perfil</h2>
                <button id="close-my-profile-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>

            <!-- Formulario de Edici√≥n -->
            <form id="edit-social-profile-form" class="space-y-3 text-left mb-4">
                <div class="flex items-center gap-4">
                    <img id="social-avatar-preview" src="https://placehold.co/60/374151/FFFFFF?text=P" alt="Avatar" class="w-16 h-16 rounded-full border-2 border-solana-green">
                    <div class="flex-grow">
                        <label for="social-username-input" class="block text-sm font-medium text-gray-300">Nombre de Usuario</label>
                        <input type="text" id="social-username-input" required class="w-full mt-1 px-3 py-2 bg-gray-900 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-solana-purple" maxlength="15">
                    </div>
                </div>
                <div>
                    <label for="social-avatar-input" class="block text-sm font-medium text-gray-300">URL de Avatar</label>
                    <input type="url" id="social-avatar-input" placeholder="https://..." class="w-full mt-1 px-3 py-2 bg-gray-900 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-solana-purple">
                </div>
                <button type="submit" class="w-full bg-solana-purple hover:bg-opacity-80 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                    Guardar Perfil
                </button>
            </form>

            <div class="text-left border-t border-gray-700 pt-4">
                <h3 class="font-semibold text-md mb-2">Mis Posts</h3>
                <div id="my-social-posts" class="space-y-3 h-48 overflow-y-auto pr-2">
                    <p class="text-gray-400 text-sm">A√∫n no has hecho posts.</p>
                </div>
            </div>

            <button id="show-creator-dashboard-btn-from-profile" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-200 mt-4">
                üíº Panel de Creador
            </button>

            <button id="launch-socialfi-coin-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-md transition duration-200 mt-2 hidden">
                üíé Lanzar Moneda SocialFi (50+ Seguidores)
            </button>
        </div>
    </div>

    <!-- Modal para Crear Post Social -->
    <div id="create-social-post-modal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden opacity-0 visibility-hidden p-4">
        <div class="modal-content glassmorphism p-6 rounded-lg shadow-2xl max-w-md w-full text-center transform scale-95">
            <!-- ... (contenido de crear post) ... -->
            <div class="flex justify-between items-center mb-3 border-b border-gray-700 pb-2">
                <h2 class="text-xl font-semibold">Crear Nuevo Post</h2>
                <button id="close-create-social-post-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <form id="create-social-post-form" class="space-y-3 text-left">
                <div>
                    <label for="social-post-text" class="block text-sm font-medium text-gray-300">Texto del Post</label>
                    <textarea id="social-post-text" rows="4" required class="w-full mt-1 px-3 py-2 bg-gray-900 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-solana-purple" maxlength="280" placeholder="¬øQu√© est√°s pensando? Shillea tu moneda aqu√≠..."></textarea>
                </div>
                <button type="submit" class="w-full bg-solana-purple hover:bg-opacity-80 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                    Publicar Post
                </button>
            </form>
        </div>
    </div>

    <!-- Modal para Perfil de Otro Jugador -->
    <div id="player-profile-modal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden opacity-0 visibility-hidden p-4">
        <div class="modal-content glassmorphism p-6 rounded-lg shadow-2xl max-w-md w-full text-center transform scale-95 overflow-y-auto max-h-full">
            <div class="flex justify-between items-center mb-3">
                <h2 id="player-profile-username" class="text-xl font-semibold">Perfil del Jugador</h2>
                <button id="close-player-profile-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>

            <img id="player-profile-avatar" src="https://placehold.co/60/374151/FFFFFF?text=P" alt="Avatar" class="w-16 h-16 rounded-full mx-auto mb-2 border-2 border-solana-green">
            <p class="text-sm text-gray-400 mb-4">Seguidores: <span id="player-profile-followers">0</span></p>

            <button id="follow-player-btn" class="w-full bg-x-blue hover:bg-opacity-80 text-white font-bold py-2 px-4 rounded-md transition duration-200 mb-4">
                Seguir
            </button>

            <div class="text-left border-t border-gray-700 pt-4 mb-4">
                <h3 class="font-semibold text-md mb-2">Monedas Creadas</h3>
                <div id="player-profile-coins" class="space-y-2 h-24 overflow-y-auto pr-2">
                    <p class="text-gray-400 text-sm">Este jugador no ha creado monedas.</p>
                </div>
            </div>

            <div class="text-left border-t border-gray-700 pt-4">
                <h3 class="font-semibold text-md mb-2">Posts Recientes</h3>
                <div id="player-profile-posts" class="space-y-3 h-48 overflow-y-auto pr-2">
                    <p class="text-gray-400 text-sm">Este jugador no tiene posts.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para PnL (Fondo Oscuro) -->
    <div id="pnl-card-modal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden opacity-0 visibility-hidden p-4">
        <div class="modal-content p-0 rounded-lg shadow-2xl max-w-sm w-full text-center transform scale-95 overflow-hidden">
            <!-- Contenido de la tarjeta PnL -->
            <div id="pnl-card-content" class="p-6 rounded-lg text-white relative">
                <button id="close-pnl-card-btn" class="absolute top-2 right-3 text-gray-300 hover:text-white text-2xl">&times;</button>

                <div class="flex justify-between items-center mb-4">
                    <span class="text-xl font-bold">Mi PnL</span>
                    <span id="pnl-coin-symbol" class="text-lg font-bold bg-gray-700 px-3 py-1 rounded-full">...</span>
                </div>

                <div id="pnl-total-percent" class="text-4xl font-bold mb-1">+0.00%</div>
                <div id="pnl-total-ssol" class="text-2xl font-semibold mb-6">+0.00 sSOL</div>

                <div class="space-y-3 text-sm text-left">
                    <div class="flex justify-between border-b border-gray-700 pb-2">
                        <span class="text-gray-400">Total Invertido (sSOL)</span>
                        <span id="pnl-total-invested" class="font-mono">0.00</span>
                    </div>
                    <div class="flex justify-between border-b border-gray-700 pb-2">
                        <span class="text-gray-400">Total Realizado (sSOL)</span>
                        <span id="pnl-total-realized" class="font-mono">0.00</span>
                    </div>
                    <div class="flex justify-between border-b border-gray-700 pb-2">
                        <span class="text-gray-400">Valor Actual (sSOL)</span>
                        <span id="pnl-current-value" class="font-mono">0.00</span>
                    </div>
                    <div class="flex justify-between border-b border-gray-700 pb-2">
                        <span class="text-gray-400">Tokens Actuales</span>
                        <span id="pnl-current-tokens" class="font-mono">0.00</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Precio Prom. Compra</span>
                        <span id="pnl-avg-buy-price" class="font-mono">$0.00</span>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Scripts de Firebase y L√≥gica del Juego -->
    <script type="module">
        // Importar funciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            signInAnonymously,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import {
            getFirestore,
            doc,
            getDoc,
            setDoc,
            collection,
            onSnapshot,
            runTransaction,
            serverTimestamp,
            query,
            updateDoc,
            orderBy,
            limit,
            increment,
            writeBatch,
            collectionGroup,
            getDocs,
            addDoc // A√±adido para el Chat
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- INICIO: ENVOLTORIO MAIN ASYNC ---
        async function main() {

            // --- CONFIGURACI√ìN DE FIREBASE (TU PROYECTO) ---
            // Variable 'appId' usada para las rutas de Firestore. Actualizada para coincidir con tu projectId.
            const appId = 'tanques-e1a74'; // <-- Actualizado con tu projectId

            // Tu configuraci√≥n de Firebase proporcionada
            const firebaseConfig = {
              apiKey: "AIzaSyDk7UWd_A3-pAgeIiYP-bdAskuuk3wgtIE",
              authDomain: "tanques-e1a74.firebaseapp.com",
              projectId: "tanques-e1a74",
              storageBucket: "tanques-e1a74.firebasestorage.app",
              messagingSenderId: "1068481268886",
              appId: "1:1068481268886:web:62fc89493b3ab3f68f46b7",
              measurementId: "G-J63P0LFMQB"
            };

            const app = initializeApp(firebaseConfig);
            const analytics = getAnalytics(app);
            // --- FIN DE LA CONFIGURACI√ìN ---

            const db = getFirestore(app);
            const auth = getAuth(app);

            // --- REFERENCIAS AL DOM (MODALES) ---
            const messageModalEl = document.getElementById('message-modal');
            const messageTextEl = document.getElementById('message-text');
            const closeMessageBtn = document.getElementById('close-message-btn');

            const createCoinModalEl = document.getElementById('create-coin-modal');
            const showCreateModalBtn = document.getElementById('show-create-modal-btn');
            const closeCreateModalBtn = document.getElementById('close-create-modal-btn');

            const chartModalEl = document.getElementById('chart-modal');
            const closeChartModalBtn = document.getElementById('close-chart-modal-btn');
            const modalCoinNameEl = document.getElementById('modal-coin-name');
            const modalCoinPriceEl = document.getElementById('modal-coin-price');
            const modalLiveBadgeEl = document.getElementById('modal-live-badge');
            const viewLiveBtnEl = document.getElementById('view-live-btn');
            const modalContractIdEl = document.getElementById('modal-contract-id');
            const showPnlModalBtn = document.getElementById('show-pnl-modal-btn');

            const pnlCardModalEl = document.getElementById('pnl-card-modal');
            const closePnlCardBtn = document.getElementById('close-pnl-card-btn');
            const pnlCardContentEl = document.getElementById('pnl-card-content');
            const pnlCoinSymbolEl = document.getElementById('pnl-coin-symbol');
            const pnlTotalPercentEl = document.getElementById('pnl-total-percent');
            const pnlTotalSsolEl = document.getElementById('pnl-total-ssol');
            const pnlTotalInvestedEl = document.getElementById('pnl-total-invested');
            const pnlTotalRealizedEl = document.getElementById('pnl-total-realized');
            const pnlCurrentValueEl = document.getElementById('pnl-current-value');
            const pnlCurrentTokensEl = document.getElementById('pnl-current-tokens');
            const pnlAvgBuyPriceEl = document.getElementById('pnl-avg-buy-price');

            const creatorDashboardModalEl = document.getElementById('creator-dashboard-modal');
            const closeCreatorDashboardBtn = document.getElementById('close-creator-dashboard-btn');
            const creatorCoinsListEl = document.getElementById('creator-coins-list');

            const sendSsolModalEl = document.getElementById('send-ssol-modal');
            const closeSendSsolBtn = document.getElementById('close-send-ssol-btn');
            const sendSsolTargetNameEl = document.getElementById('send-ssol-target-name');
            const sendSsolFormEl = document.getElementById('send-ssol-form');
            const sendSsolAmountEl = document.getElementById('send-ssol-amount');

            const liveStreamModalEl = document.getElementById('live-stream-modal');
            const closeLiveStreamBtn = document.getElementById('close-live-stream-btn');
            const liveCoinNameEl = document.getElementById('live-coin-name');
            const liveViewersEl = document.getElementById('live-viewers');

            const myProfileModalEl = document.getElementById('my-profile-modal');
            const showMyProfileBtn = document.getElementById('show-my-profile-btn');
            const closeMyProfileBtn = document.getElementById('close-my-profile-btn');
            const editSocialProfileFormEl = document.getElementById('edit-social-profile-form');
            const socialUsernameInputEl = document.getElementById('social-username-input');
            const socialAvatarInputEl = document.getElementById('social-avatar-input');
            const socialAvatarPreviewEl = document.getElementById('social-avatar-preview');
            const mySocialPostsEl = document.getElementById('my-social-posts');
            const showCreatorDashboardBtnFromProfile = document.getElementById('show-creator-dashboard-btn-from-profile');
            const launchSocialFiCoinBtn = document.getElementById('launch-socialfi-coin-btn');

            const createSocialPostModalEl = document.getElementById('create-social-post-modal');
            const closeCreateSocialPostBtn = document.getElementById('close-create-social-post-btn');
            const createSocialPostBtn = document.getElementById('create-social-post-btn');
            const createSocialPostFormEl = document.getElementById('create-social-post-form');
            const socialPostTextEl = document.getElementById('social-post-text');

            const playerProfileModalEl = document.getElementById('player-profile-modal');
            const closePlayerProfileBtn = document.getElementById('close-player-profile-btn');
            const playerProfileUsernameEl = document.getElementById('player-profile-username');
            const playerProfileAvatarEl = document.getElementById('player-profile-avatar');
            const playerProfileFollowersEl = document.getElementById('player-profile-followers');
            const playerProfilePostsEl = document.getElementById('player-profile-posts');
            const playerProfileCoinsEl = document.getElementById('player-profile-coins');
            const followPlayerBtn = document.getElementById('follow-player-btn');


            // --- FUNCIONES DE MODAL ---
            function showModal(modalEl) {
                modalEl.classList.remove('hidden');
                setTimeout(() => {
                    modalEl.classList.remove('opacity-0', 'visibility-hidden');
                    modalEl.querySelector('.modal-content').classList.remove('scale-95');
                }, 10);
            }

            function hideModal(modalEl) {
                modalEl.classList.add('opacity-0');
                modalEl.querySelector('.modal-content').classList.add('scale-95');
                setTimeout(() => {
                    modalEl.classList.add('hidden', 'visibility-hidden');
                }, 250);
            }

            function showMessage(text) {
                messageTextEl.textContent = text;
                showModal(messageModalEl);
            }

            closeMessageBtn.addEventListener('click', () => hideModal(messageModalEl));
            showCreateModalBtn.addEventListener('click', () => showModal(createCoinModalEl));
            closeCreateModalBtn.addEventListener('click', () => hideModal(createCoinModalEl));
            closeChartModalBtn.addEventListener('click', () => {
                hideModal(chartModalEl);
                selectedCoinId = null;
                const coinElements = memecoinListEl.querySelectorAll('button');
                coinElements.forEach(child => {
                    child.classList.remove('bg-solana-purple/50');
                    child.classList.add('bg-item-bg');
                });
            });

            showCreatorDashboardBtnFromProfile.addEventListener('click', () => {
                hideModal(myProfileModalEl);
                showCreatorDashboard();
            });
            closeCreatorDashboardBtn.addEventListener('click', () => hideModal(creatorDashboardModalEl));

            closeSendSsolBtn.addEventListener('click', () => hideModal(sendSsolModalEl));
            closeLiveStreamBtn.addEventListener('click', () => hideModal(liveStreamModalEl));
            viewLiveBtnEl.addEventListener('click', () => showLiveStream());
            document.querySelectorAll('.boost-live-btn').forEach(btn => btn.addEventListener('click', (e) => boostLiveStream(e.target.dataset.boostLevel)));

            showMyProfileBtn.addEventListener('click', () => {
                const player = allPlayersCache.get(currentUserId);
                if (player) {
                    socialUsernameInputEl.value = player.username || '';
                    socialAvatarInputEl.value = player.avatarUrl || '';
                    socialAvatarPreviewEl.src = player.avatarUrl || 'https://placehold.co/60/374151/FFFFFF?text=P';
                }
                showModal(myProfileModalEl);
            });
            closeMyProfileBtn.addEventListener('click', () => hideModal(myProfileModalEl));

            createSocialPostBtn.addEventListener('click', () => showModal(createSocialPostModalEl));
            closeCreateSocialPostBtn.addEventListener('click', () => hideModal(createSocialPostModalEl));

            closePlayerProfileBtn.addEventListener('click', () => hideModal(playerProfileModalEl));

            showPnlModalBtn.addEventListener('click', () => showPnlModal());
            closePnlCardBtn.addEventListener('click', () => hideModal(pnlCardModalEl));


            // --- VARIABLES GLOBALES DEL JUEGO ---
            let currentUserId = null;
            let selectedCoinId = null;
            let targetPlayerId = null;
            let memecoinChart = null;
            let chartGradient = null; // Para el gradiente de la gr√°fica
            let allCoinsCache = new Map();
            let myPortfolioCache = new Map();
            let myAssetsCache = { assets: new Map(), office: new Map() }; // Separar assets
            let allPlayersCache = new Map();
            let mySocialPostsCache = new Map();
            let globalSocialFeedCache = new Map();
            let selectedProfilePlayerId = null;
            let myFollowsCache = new Set(); // Cache para saber a qui√©n sigo
            let chatListener = null; // Para el listener del chat

            // --- COMISIONES ---
            const LP_FEE = 0.0025; // 0.25%
            const CREATOR_FEE = 0.0005; // 0.05%
            const TOTAL_FEE = LP_FEE + CREATOR_FEE; // 0.3%
            const PROMO_POST_COST = 0.2; // Costo para promocionar un post

            // Referencias de Firestore
            const roomRef = collection(db, 'artifacts', appId, 'public', 'data', 'game_rooms', 'global_room', 'data');
            const playersRef = collection(db, 'artifacts', appId, 'public', 'data', 'game_rooms', 'global_room', 'players');
            const socialPostsRef = collection(db, 'artifacts', appId, 'public', 'data', 'game_rooms', 'global_room', 'social_posts');
            const chatRef = collection(db, 'artifacts', appId, 'public', 'data', 'game_rooms', 'global_room', 'chat_messages');


            // --- REFERENCIAS AL DOM (P√ÅGINAS) ---
            const ssolBalanceEl = document.getElementById('ssol-balance');
            const playerIdBannerEl = document.getElementById('player-id-banner');
            const coinFilterInputEl = document.getElementById('coin-filter-input');

            const pages = document.querySelectorAll('.page');
            const navButtons = document.querySelectorAll('.nav-btn');

            // Contenedores de listas
            const memecoinListEl = document.getElementById('memecoin-list');
            const portfolioListEl = document.getElementById('portfolio-list');
            const myLuxuryAssetsListEl = document.getElementById('my-luxury-assets-list'); // Lujo
            const myOfficeAssetsListEl = document.getElementById('my-office-assets-list'); // Oficina
            const officeLayoutEl = document.getElementById('office-layout'); // Layout de Oficina
            const socialFeedListEl = document.getElementById('social-feed-list');
            const playersListEl = document.getElementById('players-list');
            const chatMessagesEl = document.getElementById('chat-messages');

            // Formularios (dentro de modales y chat)
            const createCoinFormEl = document.getElementById('create-coin-form');
            const coinNameEl = document.getElementById('coin-name');
            const coinSymbolEl = document.getElementById('coin-symbol');
            const coinImageUrlEl = document.getElementById('coin-image-url');
            const coinXUrlEl = document.getElementById('coin-x-url');
            const coinInitialSsolEl = document.getElementById('coin-initial-ssol');
            const coinInitialTokensEl = document.getElementById('coin-initial-tokens');

            const buyFormEl = document.getElementById('buy-form-modal');
            const sellFormEl = document.getElementById('sell-form-modal');
            const buyAmountEl = document.getElementById('buy-amount-ssol-modal');
            const sellAmountEl = document.getElementById('sell-amount-token-modal');

            const chatFormEl = document.getElementById('chat-form');
            const chatInputEl = document.getElementById('chat-input');

            // --- L√ìGICA DE NAVEGACI√ìN (SPA) ---
            function showPage(pageId) {
                pages.forEach(page => {
                    page.classList.toggle('active', page.id === pageId);
                });
                navButtons.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.page === pageId);
                });

                // Si cambiamos al chat, iniciar el listener
                if (pageId === 'page-chat' && !chatListener) {
                    listenForChatMessages();
                }
            }

            navButtons.forEach(btn => {
                btn.addEventListener('click', () => showPage(btn.dataset.page));
            });


            // --- FUNCIONES DE UTILIDAD ---

            // Funci√≥n mejorada para parsear floats aceptando coma o punto
            function parseFloatStrict(value) {
                if (typeof value !== 'string' || value.trim() === '') return NaN;
                // Reemplaza la coma por punto para consistencia
                const normalizedValue = value.replace(',', '.');
                // Valida que sea un n√∫mero decimal positivo v√°lido
                if (!/^\d*(\.\d+)?$/.test(normalizedValue)) return NaN;
                const number = parseFloat(normalizedValue);
                return isNaN(number) || number < 0 ? NaN : number;
            }

            function formatPrice(value) {
                if (isNaN(value)) value = 0;
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 10
                }).format(value);
            }
            function formatCurrency(value) {
                if (isNaN(value)) value = 0;
                 return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(value);
            }
            function formatNumber(value, decimals = 2) {
                if (isNaN(value)) value = 0;
                return new Intl.NumberFormat('en-US', {
                    minimumFractionDigits: decimals,
                    maximumFractionDigits: decimals
                }).format(value);
            }
            function timeAgo(date) {
                if (!date) return 'justo ahora';
                const seconds = Math.floor((new Date() - date) / 1000);
                let interval = seconds / 31536000;
                if (interval > 1) return Math.floor(interval) + "a";
                interval = seconds / 2592000;
                if (interval > 1) return Math.floor(interval) + "m";
                interval = seconds / 86400;
                if (interval > 1) return Math.floor(interval) + "d";
                interval = seconds / 3600;
                if (interval > 1) return Math.floor(interval) + "h";
                interval = seconds / 60;
                if (interval > 1) return Math.floor(interval) + "min";
                return "ahora";
            }

            // --- L√ìGICA DE AUTENTICACI√ìN Y JUEGO ---

            async function initAuth() {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        playerIdBannerEl.textContent = `Tu ID de Jugador: ...${user.uid.slice(-6)}`;
                        console.log("Autenticado. ID de jugador:", currentUserId, "App ID:", appId);
                        await joinGame(user.uid);
                    } else {
                        try {
                            await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Error de autenticaci√≥n an√≥nima:", error);
                            showMessage("Error al conectar con el servidor. Por favor, recarga.");
                        }
                    }
                });
            }

            async function joinGame(userId) {
                const playerRef = doc(playersRef, userId);
                let playerDoc;
                try {
                    playerDoc = await getDoc(playerRef);
                } catch (error) {
                    console.error("Error en getDoc(playerRef):", error.message);
                    showMessage(`Error de permisos: No se pudo leer tu perfil. Revisa las reglas de Firestore.`);
                    return;
                }

                if (!playerDoc.exists()) {
                    try {
                        await setDoc(playerRef, {
                            userId: userId,
                            sSOL_balance: 2,
                            joinedAt: serverTimestamp(),
                            assets: {}, // Lujo
                            officeItems: {}, // Oficina
                            username: `Jugador${userId.slice(-4)}`,
                            avatarUrl: `https://placehold.co/60/374151/FFFFFF?text=${userId.slice(-1)}`,
                            socialFollowers: 0,
                            following: [] // Array de IDs de jugadores que sigo
                        });
                    } catch (error) {
                         console.error("Error en setDoc(playerRef):", error.message);
                         showMessage(`Error de permisos: No se pudo crear tu perfil.`);
                         return;
                    }
                }

                listenForPlayerBalance(userId);
                listenForPlayers();
                listenForMemecoins();
                listenForMyPortfolio(userId);
                listenForMySocialProfile(userId);
                listenForMySocialPosts(userId);
                listenForGlobalSocialFeed();
                listenForMyFollows(userId);

                // Iniciar el chat si la p√°gina de chat est√° activa (por defecto no lo est√°)
                if (document.getElementById('page-chat').classList.contains('active')) {
                    listenForChatMessages();
                }
            }

            // --- LISTENERS DE FIRESTORE (TIEMPO REAL) ---

            function listenForPlayerBalance(userId) {
                const playerRef = doc(playersRef, userId);
                onSnapshot(playerRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        ssolBalanceEl.textContent = `${formatNumber(data.sSOL_balance)} sSOL`;
                        myAssetsCache = {
                            assets: new Map(Object.entries(data.assets || {})),
                            office: new Map(Object.entries(data.officeItems || {}))
                        };
                        updateMyAssetsUI();
                    }
                }, (error) => {
                    console.error("Error en listener (PlayerBalance):", error.message);
                });
            }

            function listenForPlayers() {
                onSnapshot(query(playersRef), (snapshot) => {
                    playersListEl.innerHTML = '';
                    allPlayersCache.clear();
                    if (snapshot.empty) {
                        playersListEl.innerHTML = '<p class="text-gray-400">Est√°s solo aqu√≠...</p>';
                        return;
                    }
                    snapshot.forEach(doc => {
                        const player = doc.data();
                        allPlayersCache.set(player.userId, player);
                        const isMe = player.userId === currentUserId;

                        const playerEl = document.createElement('div');
                        playerEl.className = `flex w-full justify-between items-center p-3 rounded-lg ${isMe ? 'bg-solana-purple/30' : 'bg-item-bg'}`;
                        playerEl.innerHTML = `
                            <div class="flex items-center gap-3">
                                <img src="${player.avatarUrl || 'https://placehold.co/40/374151/FFFFFF?text=P'}" alt="avatar" class="w-10 h-10 rounded-full">
                                <div>
                                    <span class="font-semibold truncate ${isMe ? 'text-solana-green' : ''}">
                                        ${player.username || '...'} ${isMe ? '(T√∫)' : ''}
                                    </span>
                                    <span class="text-sm text-gray-400 block">${formatNumber(player.socialFollowers || 0, 0)} seguidores</span>
                                </div>
                            </div>
                            <span class="text-sm font-semibold">${formatNumber(player.sSOL_balance)} sSOL</span>
                        `;

                        if (!isMe) {
                            // A√±adir botones para Seguir y Enviar sSOL
                            const controlsEl = document.createElement('div');
                            controlsEl.className = "flex gap-2";

                            const sendBtn = document.createElement('button');
                            sendBtn.innerHTML = `<i class="ph ph-paper-plane-tilt text-xl"></i>`;
                            sendBtn.className = "p-2 bg-item-hover rounded-md hover:bg-gray-600 transition";
                            sendBtn.title = "Enviar sSOL";
                            sendBtn.addEventListener('click', () => {
                                targetPlayerId = player.userId;
                                sendSsolTargetNameEl.textContent = `${player.username || '...' + player.userId.slice(-6)}`;
                                showModal(sendSsolModalEl);
                            });

                            const profileBtn = document.createElement('button');
                            profileBtn.innerHTML = `<i class="ph ph-user text-xl"></i>`;
                            profileBtn.className = "p-2 bg-item-hover rounded-md hover:bg-gray-600 transition";
                            profileBtn.title = "Ver Perfil";
                            profileBtn.addEventListener('click', () => {
                                showPlayerProfile(player.userId);
                            });

                            controlsEl.appendChild(profileBtn);
                            controlsEl.appendChild(sendBtn);
                            playerEl.appendChild(controlsEl);
                        }

                        playersListEl.appendChild(playerEl);
                    });
                }, (error) => {
                    console.error("Error en listener (Players):", error.message);
                });
            }

            function listenForMyFollows(userId) {
                const playerRef = doc(playersRef, userId);
                onSnapshot(playerRef, (doc) => {
                    if (doc.exists()) {
                        myFollowsCache = new Set(doc.data().following || []);
                    }
                }, (error) => {
                    console.error("Error en listener (MyFollows):", error.message);
                });
            }

            function listenForMySocialProfile(userId) {
                const playerRef = doc(playersRef, userId);
                onSnapshot(playerRef, (doc) => {
                    if (doc.exists()) {
                        const player = doc.data();
                        // Actualizar modal de Mi Perfil
                        socialUsernameInputEl.value = player.username || '';
                        socialAvatarInputEl.value = player.avatarUrl || '';
                        socialAvatarPreviewEl.src = player.avatarUrl || 'https://placehold.co/60/374151/FFFFFF?text=P';

                        launchSocialFiCoinBtn.classList.toggle('hidden', (player.socialFollowers || 0) < 50);
                    }
                }, (error) => {
                    console.error("Error en listener (MySocialProfile):", error.message);
                });
            }

            function listenForMySocialPosts(userId) {
                const postsQuery = query(socialPostsRef, orderBy('createdAt', 'desc'));
                onSnapshot(postsQuery, (snapshot) => {
                    mySocialPostsEl.innerHTML = '';
                    mySocialPostsCache.clear();
                    let hasPosts = false;
                    snapshot.forEach(doc => {
                        const post = doc.data();
                        if (post.userId === userId) { // Filtrar solo mis posts
                            hasPosts = true;
                            mySocialPostsCache.set(doc.id, post);
                            const postEl = document.createElement('div');
                            postEl.className = 'bg-item-hover p-3 rounded-lg text-sm';
                            postEl.innerHTML = `
                                <p>${post.text}</p>
                                <p class="text-xs text-gray-500 mt-2">${new Date(post.createdAt.toDate()).toLocaleString()}</p>
                            `;
                            mySocialPostsEl.appendChild(postEl);
                        }
                    });
                    if (!hasPosts) {
                        mySocialPostsEl.innerHTML = '<p class="text-gray-400 text-sm">A√∫n no has hecho posts.</p>';
                    }
                }, (error) => {
                    console.error("Error en listener (MySocialPosts):", error.message);
                });
            }

            function listenForGlobalSocialFeed() {
                const q = query(socialPostsRef, orderBy("createdAt", "desc"), limit(100));
                onSnapshot(q, (snapshot) => {
                    socialFeedListEl.innerHTML = '';
                    globalSocialFeedCache.clear();
                    if (snapshot.empty) {
                        socialFeedListEl.innerHTML = '<p class="text-gray-400 text-center">¬°El feed est√° vac√≠o! S√© el primero en postear.</p>';
                        return;
                    }

                    const posts = [];
                    snapshot.forEach(doc => {
                        posts.push({ id: doc.id, ...doc.data() });
                    });

                    // Ordenar en JavaScript: boosted=true primero, luego por fecha
                    posts.sort((a, b) => {
                        if (a.boosted && !b.boosted) return -1;
                        if (!a.boosted && b.boosted) return 1;
                        const dateA = a.createdAt?.toDate() || new Date(0);
                        const dateB = b.createdAt?.toDate() || new Date(0);
                        return dateB - dateA;
                    });

                    posts.slice(0, 50).forEach(post => {
                        globalSocialFeedCache.set(post.id, post);

                        const player = allPlayersCache.get(post.userId) || { username: 'Desconocido', avatarUrl: '' };
                        const postEl = document.createElement('div');
                        postEl.className = `glassmorphism p-4 rounded-lg ${post.boosted ? 'border-2 border-solana-purple' : 'border border-transparent'}`;

                        let promoBtn = '';
                        if (post.userId === currentUserId && !post.boosted) {
                            promoBtn = `<button data-post-id="${post.id}" class="promote-post-btn text-sm text-solana-purple hover:text-solana-green transition">Promocionar (0.2 sSOL)</button>`;
                        } else if (post.boosted) {
                            promoBtn = `<span class="text-sm text-solana-purple font-semibold">¬°Promocionado!</span>`;
                        }

                        postEl.innerHTML = `
                            <div class="flex justify-between items-start">
                                <button data-player-id="${post.userId}" class="player-profile-link flex items-center gap-3 group">
                                    <img src="${player.avatarUrl || 'https://placehold.co/40/374151/FFFFFF?text=P'}" alt="avatar" class="w-10 h-10 rounded-full group-hover:opacity-80 transition">
                                    <div>
                                        <p class="font-semibold text-white group-hover:text-solana-green transition">${player.username}</p>
                                        <p class="text-xs text-gray-400">${timeAgo(post.createdAt?.toDate())}</p>
                                    </div>
                                </button>
                                ${promoBtn}
                            </div>
                            <p class="mt-3 text-gray-200">${post.text}</p>
                        `;
                        socialFeedListEl.appendChild(postEl);
                    });

                    // A√±adir listeners a los nuevos botones del feed
                    socialFeedListEl.querySelectorAll('.promote-post-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => promotePost(e.target.dataset.postId, e.target));
                    });
                    socialFeedListEl.querySelectorAll('.player-profile-link').forEach(btn => {
                        btn.addEventListener('click', (e) => showPlayerProfile(e.currentTarget.dataset.playerId));
                    });
                }, (error) => {
                    console.error("Error en listener (GlobalSocialFeed):", error.message);
                });
            }

            function listenForMyPortfolio(userId) {
                const portfolioRef = collection(playersRef, userId, 'wallet');
                // Ordenar por 'amount' no es ideal si 'amount' cambia mucho,
                // pero lo mantenemos simple. Ordenar en el cliente es mejor.
                onSnapshot(query(portfolioRef), (snapshot) => {
                    portfolioListEl.innerHTML = '';
                    myPortfolioCache.clear();

                    let portfolioItems = [];
                    snapshot.forEach(doc => {
                        const coin = doc.data();
                        if (coin.amount >= 0.00000001) {
                             portfolioItems.push({ ...coin, id: doc.id });
                        }
                    });

                    if (portfolioItems.length === 0) {
                        portfolioListEl.innerHTML = '<p class="text-gray-400">A√∫n no tienes monedas.</p>';
                        return;
                    }

                    // Ordenar por valor actual en el cliente
                    portfolioItems.sort((a, b) => {
                        const coinDataA = allCoinsCache.get(a.id);
                        const coinDataB = allCoinsCache.get(b.id);
                        const valueA = coinDataA ? a.amount * coinDataA.currentPrice : 0;
                        const valueB = coinDataB ? b.amount * coinDataB.currentPrice : 0;
                        return valueB - valueA; // Descendente
                    });

                    portfolioItems.forEach(coin => {
                        myPortfolioCache.set(coin.id, coin);

                        const coinData = allCoinsCache.get(coin.id);
                        const coinName = coinData ? `${coinData.name} (${coinData.symbol})` : 'Moneda Desconocida';
                        const currentValue = coinData ? coin.amount * coinData.currentPrice : 0;

                        const itemEl = document.createElement('div');
                        itemEl.className = 'flex justify-between items-center bg-item-bg p-3 rounded-lg';
                        itemEl.innerHTML = `
                            <div>
                                <div class="font-semibold">${coinName}</div>
                                <div class="text-sm text-gray-400">${formatNumber(coin.amount, 4)} tokens</div>
                            </div>
                            <div class="text-right">
                                <div class="font-semibold">${formatCurrency(currentValue)}</div>
                                <div class="text-sm text-gray-400">Valor</div>
                            </div>
                        `;
                        portfolioListEl.appendChild(itemEl);
                    });
                }, (error) => {
                    console.error("Error en listener (MyPortfolio):", error.message);
                });
            }

            function listenForMemecoins() {
                // Ordenar por fecha de creaci√≥n (nuevo a viejo)
                onSnapshot(query(roomRef, orderBy("createdAt", "desc")), (snapshot) => {
                    const newCache = new Map();
                    snapshot.forEach(doc => {
                        newCache.set(doc.id, { id: doc.id, ...doc.data() });
                    });
                    allCoinsCache = newCache;
                    updateMemecoinListUI();
                }, (error) => {
                    console.error("Error en listener (Memecoins):", error.message);
                });
            }

            function updateMemecoinListUI() {
                memecoinListEl.innerHTML = '';

                const filterText = coinFilterInputEl.value.toLowerCase();

                // El cach√© ya est√° ordenado por 'createdAt' (nuevo a viejo)
                let coinsToShow = Array.from(allCoinsCache.values());

                // Aplicar filtro si existe
                if (filterText) {
                    coinsToShow = coinsToShow.filter(coin =>
                        coin.name.toLowerCase().includes(filterText) ||
                        coin.symbol.toLowerCase().includes(filterText)
                    );
                }

                if (coinsToShow.length === 0) {
                    memecoinListEl.innerHTML = `<p class="text-gray-400 text-center mt-10">${filterText ? 'No se encontraron monedas.' : 'No hay monedas. ¬°Lanza la primera!'}</p>`;
                    return;
                }

                coinsToShow.forEach(coin => {
                    const priceChange = coin.priceHistory.length > 1 ? (coin.currentPrice - coin.priceHistory[coin.priceHistory.length - 2]) / coin.priceHistory[coin.priceHistory.length - 2] : 0;
                    const changeColor = priceChange >= 0 ? 'text-green-500' : 'text-red-500';
                    const changeIcon = priceChange >= 0 ? '‚ñ≤' : '‚ñº';
                    const placeholderImg = `https://placehold.co/40x40/${coin.id.slice(0,6)}/FFFFFF?text=${coin.symbol}`;

                    const coinEl = document.createElement('button');
                    coinEl.className = `w-full text-left p-3 rounded-lg transition duration-200 ${selectedCoinId === coin.id ? 'bg-solana-purple/50' : 'bg-item-bg hover:bg-item-hover'}`;
                    coinEl.dataset.coinId = coin.id;
                    coinEl.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <img src="${coin.imageUrl || placeholderImg}" onerror="this.src='${placeholderImg}'" alt="${coin.name}" class="w-10 h-10 rounded-full bg-gray-700">
                                <div>
                                    <span class="text-lg font-bold">${coin.name} (${coin.symbol})</span>
                                    <span class="text-xs text-gray-400 block" title="${coin.creatorId}">Creador: ${allPlayersCache.get(coin.creatorId)?.username || '...' + coin.creatorId.slice(-6)}</span>
                                </div>
                                ${coin.isLive ? `<span class="animate-livePulse text-xs font-bold bg-red-600 text-white px-2 py-0.5 rounded-md ml-2">LIVE</span>` : ''}
                                ${coin.xUrl ? `
                                    <div class="x-popover-container ml-1">
                                        <i class="ph ph-x text-gray-400 hover:text-x-blue cursor-pointer text-base"></i>
                                        <div class="x-popover glassmorphism p-3 rounded-lg shadow-xl text-xs">
                                            <div class="flex items-center gap-2 mb-2">
                                                <img src="${coin.imageUrl || placeholderImg}" alt="${coin.name}" class="w-8 h-8 rounded-full">
                                                <div>
                                                    <p class="font-bold text-white">${coin.name} <i class="ph ph-check-circle-fill text-x-blue text-xs align-middle"></i></p>
                                                    <p class="text-gray-400">@${(coin.name || 'memecoin').replace(/\s/g, '_').slice(0,10)}_Official</p>
                                                </div>
                                            </div>
                                            <p class="text-gray-300 mb-2">¬°Sigue el hype en X!</p>
                                            <div class="flex justify-between text-gray-400 mb-2">
                                                <span><strong class="text-white">${formatNumber(coin.followers || 0, 0)}</strong> Seguidores</span>
                                            </div>
                                            <a href="${coin.xUrl}" target="_blank" class="w-full inline-block bg-x-blue hover:bg-opacity-80 text-white font-bold py-1.5 px-2 rounded-md transition duration-200 text-center">Ver perfil en X</a>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="text-right">
                                <span class="text-lg font-mono">${formatPrice(coin.currentPrice)}</span>
                                <span class="text-sm font-semibold ${changeColor}">${changeIcon} ${formatNumber(priceChange * 100)}%</span>
                            </div>
                        </div>

                        <div class="grid grid-cols-3 sm:grid-cols-5 gap-2 mt-3 text-xs text-center">
                            <div>
                                <span class="text-gray-400 block">MC</span>
                                <span class="font-semibold">${formatCurrency(coin.marketCap || 0)}</span>
                            </div>
                            <div>
                                <span class="text-gray-400 block">Liquidez</span>
                                <span class="font-semibold">${formatCurrency(coin.sSolPool || 0)}</span>
                            </div>
                             <div>
                                <span class="text-gray-400 block">Volumen</span>
                                <span class="font-semibold">${formatCurrency(coin.volume || 0)}</span>
                            </div>
                             <div>
                                <span class="text-gray-400 block">Holders</span>
                                <span class="font-semibold">${formatNumber(coin.holderCount || 0, 0)}</span>
                            </div>
                            <div>
                                <span class="text-gray-400 block">Seguidores</span>
                                <span class="font-semibold">${formatNumber(coin.followers || 0, 0)}</span>
                            </div>
                        </div>
                    `;
                    coinEl.addEventListener('click', () => selectCoin(coin.id));
                    memecoinListEl.appendChild(coinEl);

                    if (coin.id === selectedCoinId) {
                        updateChart(coin);
                        updateSelectedCoinPrice(coin.currentPrice);
                        modalCoinNameEl.textContent = `${coin.name} (${coin.symbol})`;
                        modalContractIdEl.textContent = `ID de Contrato: ...${coin.contractId.slice(-6)}`;
                        modalLiveBadgeEl.classList.toggle('hidden', !coin.isLive);
                        viewLiveBtnEl.classList.toggle('hidden', !coin.isLive);
                    }
                });

                updatePortfolioValues();
            }

            coinFilterInputEl.addEventListener('input', updateMemecoinListUI);

            function updatePortfolioValues() {
                // Esta funci√≥n ahora solo re-renderiza los valores
                // en la p√°gina de Portafolio, usando el cach√© ordenado.
                portfolioListEl.innerHTML = '';
                if (myPortfolioCache.size === 0) {
                     portfolioListEl.innerHTML = '<p class="text-gray-400">A√∫n no tienes monedas.</p>';
                     return;
                }

                // Re-ordenar por valor actual, ya que los precios cambian
                let portfolioItems = Array.from(myPortfolioCache.values());
                portfolioItems.sort((a, b) => {
                    const coinDataA = allCoinsCache.get(a.id);
                    const coinDataB = allCoinsCache.get(b.id);
                    const valueA = coinDataA ? a.amount * coinDataA.currentPrice : 0;
                    const valueB = coinDataB ? b.amount * coinDataB.currentPrice : 0;
                    return valueB - valueA; // Descendente
                });

                portfolioItems.forEach(coin => {
                    const coinData = allCoinsCache.get(coin.id);
                    if (!coinData) return;

                    const coinName = `${coinData.name} (${coinData.symbol})`;
                    const currentValue = coin.amount * coinData.currentPrice;

                    const itemEl = document.createElement('div');
                    itemEl.className = 'flex justify-between items-center bg-item-bg p-3 rounded-lg';
                    itemEl.innerHTML = `
                        <div>
                            <div class="font-semibold">${coinName}</div>
                            <div class="text-sm text-gray-400">${formatNumber(coin.amount, 4)} tokens</div>
                        </div>
                        <div class="text-right">
                            <div class="font-semibold">${formatCurrency(currentValue)}</div>
                            <div class="text-sm text-gray-400">Valor</div>
                        </div>
                    `;
                    portfolioListEl.appendChild(itemEl);
                });
            }

            function updateMyAssetsUI() {
                myLuxuryAssetsListEl.innerHTML = '';
                myOfficeAssetsListEl.innerHTML = '';
                officeLayoutEl.innerHTML = ''; // Limpiar oficina

                if (myAssetsCache.assets.size === 0) {
                    myLuxuryAssetsListEl.innerHTML = '<p class="text-gray-400 text-sm">A√∫n no tienes activos de lujo.</p>';
                } else {
                    myAssetsCache.assets.forEach((count, item) => {
                        let emoji = '‚ùì';
                        if (item === 'lambo') emoji = 'üèéÔ∏è';
                        if (item === 'mansion') emoji = 'üè∞';
                        if (item === 'yate') emoji = 'üõ•Ô∏è';
                        if (item === 'jet') emoji = '‚úàÔ∏è';
                        const name = item.charAt(0).toUpperCase() + item.slice(1);
                        const itemEl = document.createElement('div');
                        itemEl.className = 'bg-item-bg p-3 rounded-lg text-center';
                        itemEl.innerHTML = `
                            <span class="text-2xl">${emoji}</span>
                            <div class="text-sm font-semibold">${name} (x${count})</div>
                        `;
                        myLuxuryAssetsListEl.appendChild(itemEl);
                    });
                }

                if (myAssetsCache.office.size === 0) {
                    myOfficeAssetsListEl.innerHTML = '<p class="text-gray-400 text-sm">A√∫n no tienes art√≠culos de oficina.</p>';
                } else {
                     myAssetsCache.office.forEach((data, item) => {
                        const name = item.charAt(0).toUpperCase() + item.slice(1);
                        const itemEl = document.createElement('div');
                        itemEl.className = 'bg-item-bg p-3 rounded-lg text-center';
                        itemEl.innerHTML = `
                            <span class="text-2xl">${data.emoji}</span>
                            <div class="text-sm font-semibold">${name} (x${data.count})</div>
                        `;
                        myOfficeAssetsListEl.appendChild(itemEl);

                        // A√±adir al layout de la oficina
                        const officeItemEl = document.createElement('span');
                        officeItemEl.className = 'office-item';
                        officeItemEl.style.cssText = data.pos;
                        officeItemEl.textContent = data.emoji;
                        officeLayoutEl.appendChild(officeItemEl);
                    });
                }
            }

            // --- L√ìGICA DE GR√ÅFICA (CHART.JS) ---

            function createChartGradient(ctx, color) {
                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                if (color === 'green') {
                    gradient.addColorStop(0, 'rgba(20, 241, 149, 0.5)'); // solana-green
                } else {
                    gradient.addColorStop(0, 'rgba(239, 68, 68, 0.5)'); // red-500
                }
                gradient.addColorStop(1, 'rgba(31, 41, 55, 0)'); // item-bg (transparente)
                return gradient;
            }

            function initChart() {
                // Registrar el plugin de anotaciones
                // CORRECCI√ìN: Verificar si el plugin existe antes de registrarlo
                if (typeof ChartAnnotation !== 'undefined') {
                    Chart.register(ChartAnnotation);
                    console.log("ChartAnnotation plugin registered successfully.");
                } else {
                    console.error("ChartAnnotation plugin not found or failed to load. Annotations will be disabled.");
                }

                const ctx = document.getElementById('coin-chart-modal').getContext('2d');
                chartGradient = createChartGradient(ctx, 'green'); // Gradiente por defecto

                memecoinChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'Precio',
                                data: [],
                                borderColor: '#14F195',
                                borderWidth: 2,
                                pointRadius: 0,
                                tension: 0.3,
                                fill: true,
                                backgroundColor: chartGradient,
                                yAxisID: 'yPrice',
                            },
                            {
                                label: 'Volumen',
                                data: [],
                                backgroundColor: 'rgba(153, 69, 255, 0.4)',
                                type: 'bar',
                                yAxisID: 'yVolume',
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            yPrice: {
                                type: 'linear',
                                position: 'left',
                                ticks: { color: '#9CA3AF', callback: (value) => formatPrice(value) },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            },
                            yVolume: {
                                type: 'linear',
                                position: 'right',
                                ticks: { display: false },
                                grid: { display: false },
                                beginAtZero: true
                            },
                            x: {
                                ticks: { display: false },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                enabled: true, mode: 'index', intersect: false,
                                callbacks: {
                                    label: (context) => {
                                        if (context.datasetIndex === 0) return `Precio: ${formatPrice(context.parsed.y)}`;
                                        if (context.datasetIndex === 1) return `Volumen: ${formatCurrency(context.parsed.y)}`;
                                        return '';
                                    }
                                }
                            },
                            // Plugin de anotaciones (l√≠neas de compra/venta)
                            annotation: {
                                annotations: {
                                    // Se a√±adir√°n din√°micamente
                                }
                            }
                        }
                    }
                });
            }

            function updateChart(coinData) {
                if (!memecoinChart) return;

                const history = coinData.priceHistory.slice(-50);
                const volumeHistory = (coinData.volumeHistory || []).slice(-50);

                let newColor = '#14F195';
                let newGradientColor = 'green';
                if (history.length > 1 && history[history.length - 1] < history[history.length - 2]) {
                    newColor = '#EF4444'; // red-500
                    newGradientColor = 'red';
                }

                memecoinChart.data.datasets[0].borderColor = newColor;
                memecoinChart.data.datasets[0].backgroundColor = createChartGradient(memecoinChart.ctx, newGradientColor);

                memecoinChart.data.labels = history.map((_, i) => i + 1);
                memecoinChart.data.datasets[0].data = history;
                memecoinChart.data.datasets[1].data = volumeHistory;

                // Actualizar l√≠neas de PnL solo si el plugin est√° disponible
                if (typeof ChartAnnotation !== 'undefined') {
                    updateChartAnnotations(coinData.id);
                }

                memecoinChart.update('none');
            }

            async function updateChartAnnotations(coinId) {
                if (!memecoinChart || typeof ChartAnnotation === 'undefined') return; // Salir si el plugin no carg√≥

                const walletRef = doc(playersRef, currentUserId, 'wallet', coinId);
                let annotations = {};

                try {
                    const walletDoc = await getDoc(walletRef);
                    if (walletDoc.exists()) {
                        const tradeHistory = walletDoc.data().tradeHistory || [];

                        tradeHistory.forEach((trade, index) => {
                            const isBuy = trade.type === 'buy';
                            annotations[`line${index}`] = {
                                type: 'line',
                                yMin: trade.price,
                                yMax: trade.price,
                                borderColor: isBuy ? 'rgba(34, 197, 94, 0.7)' : 'rgba(239, 68, 68, 0.7)', // green-500 / red-500
                                borderWidth: 2,
                                borderDash: [6, 6],
                                label: {
                                    content: isBuy ? `Compra (${formatNumber(trade.amountSsol)} sSOL)` : `Venta (${formatNumber(trade.amountSsol)} sSOL)`,
                                    enabled: true,
                                    position: 'start',
                                    backgroundColor: isBuy ? 'rgba(34, 197, 94, 0.7)' : 'rgba(239, 68, 68, 0.7)',
                                    font: { size: 10 },
                                    xPadding: 4,
                                    yPadding: 4,
                                    borderRadius: 4
                                }
                            };
                        });
                    }
                } catch (e) {
                    console.error("Error al obtener historial para anotaciones:", e);
                }

                memecoinChart.options.plugins.annotation.annotations = annotations;
            }

            function updateSelectedCoinPrice(price) {
                modalCoinPriceEl.textContent = `${formatPrice(price)}`;
            }

            // --- ACCIONES DEL JUGADOR ---

            function selectCoin(coinId) {
                selectedCoinId = coinId;
                const coinData = allCoinsCache.get(coinId);

                if (!coinData) return;

                modalCoinNameEl.textContent = `${coinData.name} (${coinData.symbol})`;
                modalContractIdEl.textContent = `ID de Contrato: ...${coinData.contractId.slice(-6)}`;
                updateSelectedCoinPrice(coinData.currentPrice);
                updateChart(coinData); // Esto tambi√©n llamar√° a updateChartAnnotations
                showModal(chartModalEl);

                modalLiveBadgeEl.classList.toggle('hidden', !coinData.isLive);
                viewLiveBtnEl.classList.toggle('hidden', !coinData.isLive);

                Array.from(memecoinListEl.children).forEach(child => {
                    child.classList.toggle('bg-solana-purple/50', child.dataset.coinId === coinId);
                    child.classList.toggle('bg-item-bg', child.dataset.coinId !== coinId);
                });
            }

            // Formulario de Crear Moneda
            createCoinFormEl.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = coinNameEl.value.trim();
                const symbol = coinSymbolEl.value.trim().toUpperCase();
                const imageUrl = coinImageUrlEl.value.trim();
                const xUrl = coinXUrlEl.value.trim();
                const initialSsol = parseFloat(coinInitialSsolEl.value);
                const initialTokens = parseFloat(coinInitialTokensEl.value);

                if (!name || !symbol || isNaN(initialSsol) || isNaN(initialTokens) || initialSsol <= 0 || initialTokens <= 0) {
                    showMessage("Por favor, completa todos los campos de liquidez con valores v√°lidos.");
                    return;
                }

                const launchCost = 0.01;
                const totalCost = launchCost + initialSsol;

                try {
                    await runTransaction(db, async (transaction) => {
                        const playerRef = doc(playersRef, currentUserId);
                        const playerDoc = await transaction.get(playerRef);

                        if (!playerDoc.exists()) throw new Error("No se encontr√≥ tu jugador.");

                        const currentBalance = playerDoc.data().sSOL_balance;
                        if (currentBalance < totalCost) {
                            throw new Error(`Fondos insuficientes. Necesitas ${formatNumber(totalCost)} sSOL (0.01 de fee + ${formatNumber(initialSsol)} de liquidez).`);
                        }

                        transaction.update(playerRef, { sSOL_balance: currentBalance - totalCost });

                        const newCoinRef = doc(roomRef);
                        const price = initialSsol / initialTokens;

                        transaction.set(newCoinRef, {
                            name: name,
                            symbol: symbol,
                            creatorId: currentUserId,
                            imageUrl: imageUrl || `https://placehold.co/40x40/${newCoinRef.id.slice(0,6)}/FFFFFF?text=${symbol}`,
                            xUrl: xUrl || '',
                            contractId: newCoinRef.id,
                            sSolPool: initialSsol,
                            tokenPool: initialTokens,
                            currentPrice: price,
                            priceHistory: [price],
                            volumeHistory: [0],
                            allTimeHigh: price,
                            allTimeLow: price,
                            createdAt: serverTimestamp(),
                            marketCap: initialSsol * 2,
                            volume: 0,
                            holderCount: 1,
                            lastHolderCountChange: 1,
                            creatorFeesSsol: 0,
                            creatorFeesToken: 0,
                            botSsolPool: 400,
                            botTokenPool: 0,
                            isLive: false,
                            liveViewers: 0,
                            followers: (playerDoc.data().socialFollowers || 0) + 1
                        });

                        const walletRef = doc(playersRef, currentUserId, 'wallet', newCoinRef.id);
                        transaction.set(walletRef, {
                            amount: initialTokens,
                            tradeHistory: [] // Historial de trades del jugador
                        });
                    });

                    hideModal(createCoinModalEl);
                    showMessage(`¬°Moneda ${name} (${symbol}) lanzada con √©xito!`);
                    createCoinFormEl.reset();
                    showPage('page-portafolio'); // Navegar al portafolio

                } catch (error) {
                    console.error("Error al lanzar moneda:", error);
                    showMessage(error.message);
                }
            });

            // --- L√ìGICA DE BOTS (REACTIVA Y PROACTIVA) ---

            function simulateBotTrade(coinData, playerAction, forceBuyProbability = null) {

                let {
                    botSsolPool, botTokenPool, sSolPool, tokenPool,
                    volume, priceHistory, volumeHistory, creatorId,
                    creatorFeesSsol, creatorFeesToken, marketCap, allTimeHigh, allTimeLow,
                    followers
                } = coinData;

                if (creatorId === 'bot') return {};

                let buyProbability = 0.6;
                if (playerAction === 'proactive' && forceBuyProbability !== null) {
                    buyProbability = forceBuyProbability;
                }

                const isBuy = (Math.random() < buyProbability);

                let ssolTraded = 0;
                let ssolForTrade = 0;
                let tokensForTrade = 0;
                let tokensReceived = 0;
                let ssolReceived = 0;
                let finalSsolPool = sSolPool;
                let finalTokenPool = tokenPool;
                let newCreatorFeesSsol = creatorFeesSsol || 0;
                let newCreatorFeesToken = creatorFeesToken || 0;
                let newFollowers = followers || 0;
                let creatorFollowsIncrement = 0; // Para seguir al creador

                if (isBuy) {
                    // El bot gasta sSOL para comprar tokens
                    const ssolToSpend = (Math.pow(Math.random(), 2) * (botSsolPool * 0.1));
                    if (ssolToSpend < 0.00000001 || botSsolPool < ssolToSpend) return {};

                    botSsolPool -= ssolToSpend;
                    ssolTraded = ssolToSpend;

                    // Aplicar comisiones (ambas van al creador)
                    const totalFee = ssolToSpend * TOTAL_FEE;
                    ssolForTrade = ssolToSpend - totalFee;

                    const k = sSolPool * tokenPool;
                    const newSsolPool_k = sSolPool + ssolForTrade; // LP no se incrementa con fees
                    finalTokenPool = k / newSsolPool_k;
                    tokensReceived = tokenPool - finalTokenPool;

                    finalSsolPool = newSsolPool_k;
                    newCreatorFeesSsol += totalFee; // Toda la fee para el creador

                    botTokenPool += tokensReceived;

                    newFollowers++;
                    if (Math.random() < 0.1) { // 10% de probabilidad de seguir al creador
                        creatorFollowsIncrement = 1;
                    }

                } else {
                    // El bot vende tokens para obtener sSOL
                    // Vender en parciales (m√°x 10%)
                    const sellPercentage = (Math.pow(Math.random(), 2) * 0.1);

                    const tokensToSell = botTokenPool * sellPercentage;
                    if (tokensToSell < 0.00000001) return {};

                    botTokenPool -= tokensToSell;

                    // Aplicar comisiones (ambas van al creador)
                    const totalFee = tokensToSell * TOTAL_FEE;
                    tokensForTrade = tokensToSell - totalFee;

                    const k = sSolPool * tokenPool;
                    const newTokenPool_k = tokenPool + tokensForTrade; // LP no se incrementa con fees
                    finalSsolPool = k / newTokenPool_k;
                    ssolReceived = sSolPool - finalSsolPool;
                    ssolTraded = ssolReceived;

                    finalTokenPool = newTokenPool_k;
                    newCreatorFeesToken += totalFee; // Toda la fee para el creador

                    botSsolPool += ssolReceived;
                }

                const newPrice = finalSsolPool / finalTokenPool;
                const newAllTimeHigh = Math.max(allTimeHigh || 0, newPrice);
                const newAllTimeLow = Math.min(allTimeLow || 999999, newPrice);
                const newMarketCap = newPrice * (finalTokenPool + botTokenPool);
                const newHistory = [...priceHistory, newPrice].slice(-50);
                const newVolumeHistory = [...(volumeHistory || []), ssolTraded].slice(-50);
                const newVolume = volume + ssolTraded;

                const updates = {
                    sSolPool: finalSsolPool,
                    tokenPool: finalTokenPool,
                    botSsolPool: botSsolPool,
                    botTokenPool: botTokenPool,
                    currentPrice: newPrice,
                    priceHistory: newHistory,
                    volumeHistory: newVolumeHistory,
                    volume: newVolume,
                    marketCap: newMarketCap,
                    creatorFeesSsol: newCreatorFeesSsol,
                    creatorFeesToken: newCreatorFeesToken,
                    allTimeHigh: newAllTimeHigh,
                    allTimeLow: newAllTimeLow,
                    creatorFollowsIncrement: creatorFollowsIncrement // Pasar el incremento
                };

                if (isBuy) updates.followers = newFollowers;

                return updates;
            }

            async function proactiveBotLoop() {
                if (allCoinsCache.size > 0 && allPlayersCache.size > 0) {

                    for (const [coinId, coin] of allCoinsCache.entries()) {

                        const allTimeHigh = coin.allTimeHigh || coin.priceHistory[0] || 0;
                        const currentPrice = coin.currentPrice;
                        let buyProbability = 0.5;
                        let tradeProbability = 0.0;

                        if (allTimeHigh > 0 && (currentPrice / allTimeHigh) < 0.2) {
                            tradeProbability = 0.1;
                            buyProbability = 0.05;
                        } else {
                            const priceHistory = coin.priceHistory || [];
                            let priceChange = 0;
                            if (priceHistory.length > 1) {
                                const prevPrice = priceHistory[priceHistory.length - 2];
                                if (prevPrice > 0) priceChange = (coin.currentPrice - prevPrice) / prevPrice;
                            }

                            const creator = allPlayersCache.get(coin.creatorId);
                            const creatorFollowers = creator ? (creator.socialFollowers || 0) : 0;
                            const creatorFollowerScore = Math.min(1.0, creatorFollowers / 1000);

                            const priceChangeScore = Math.min(1, priceChange / 0.1);
                            const volumeRatio = (coin.sSolPool > 0) ? (coin.volume || 0) / coin.sSolPool : 0;
                            const volumeScore = Math.min(1, volumeRatio / 10);
                            const holderScore = Math.min(1, (coin.lastHolderCountChange || 0) / 5);
                            // AJUSTE: Aumentar impacto de liveScore
                            const liveScore = coin.isLive ? Math.min(1.0, (coin.liveViewers || 0) / 1000) : 0.0;
                            const followersScore = Math.min(1, (coin.followers || 0) / 1000);

                             // AJUSTE: Aumentar peso de liveScore (de 2 a 5) y ajustar divisor
                            const totalHypeScore = (priceChangeScore + volumeScore + holderScore + (followersScore*1.5) + (liveScore * 5) + (creatorFollowerScore * 2)) / 11.5;

                            // AJUSTE: Aumentar probabilidad de trade con hype (de 0.5 a 0.7)
                            tradeProbability = totalHypeScore * 0.7;

                            // AJUSTE: Aumentar influencia en buyProbability (de 0.4 a 0.45)
                            if (priceChange > 0) buyProbability = 0.5 + (totalHypeScore * 0.45);
                            else buyProbability = 0.5 - ((1 - totalHypeScore) * 0.45);
                        }

                        // Probabilidad de seguir a un jugador aleatorio (simulando ver el feed)
                        if (Math.random() < 0.01) { // 1% de probabilidad por ciclo
                             try {
                                const playerIds = Array.from(allPlayersCache.keys());
                                const randomPlayerId = playerIds[Math.floor(Math.random() * playerIds.length)];
                                if (randomPlayerId && randomPlayerId !== coin.creatorId) {
                                    const targetPlayerRef = doc(playersRef, randomPlayerId);
                                    await updateDoc(targetPlayerRef, { socialFollowers: increment(1) });
                                }
                             } catch(e) { console.warn("Bot failed to follow random player:", e.message); }
                        }

                        if (Math.random() < tradeProbability) {
                            const coinRef = doc(roomRef, coinId);
                            try {
                                await runTransaction(db, async (transaction) => {
                                    const coinDoc = await transaction.get(coinRef);
                                    if (!coinDoc.exists()) return;

                                    const coinData = coinDoc.data();
                                    const botUpdates = simulateBotTrade(coinData, 'proactive', buyProbability);

                                    if (Object.keys(botUpdates).length > 0) {

                                        // Incrementar seguidores del creador si el bot decide seguir
                                        if (botUpdates.creatorFollowsIncrement > 0) {
                                            const creatorRef = doc(playersRef, coinData.creatorId);
                                            // Leer primero (si no se ha le√≠do)
                                            const creatorDoc = await transaction.get(creatorRef);
                                            if (creatorDoc.exists()) {
                                                transaction.update(creatorRef, {
                                                    socialFollowers: increment(botUpdates.creatorFollowsIncrement)
                                                });
                                            }
                                        }
                                        delete botUpdates.creatorFollowsIncrement;

                                        botUpdates.lastHolderCountChange = 0;
                                        transaction.update(coinRef, botUpdates);
                                    }
                                });
                            } catch (e) {
                                console.warn("Fallo la transacci√≥n proactiva del bot:", e.message);
                            }
                        }
                    }
                }
                setTimeout(proactiveBotLoop, 5000);
            }

            // Formulario de Compra
            buyFormEl.addEventListener('submit', async (e) => {
                e.preventDefault();
                const ssolToSpend = parseFloatStrict(buyAmountEl.value);
                if (!selectedCoinId || isNaN(ssolToSpend) || ssolToSpend <= 0) return showMessage("Ingresa un monto v√°lido.");

                let tokensReceived = 0;
                let newPrice = 0;
                try {
                    await runTransaction(db, async (transaction) => {
                        // --- 1. LECTURAS PRIMERO ---
                        const playerRef = doc(playersRef, currentUserId);
                        const coinRef = doc(roomRef, selectedCoinId);
                        const walletRef = doc(playersRef, currentUserId, 'wallet', selectedCoinId);

                        // CORRECCI√ìN DE TRANSACCI√ìN: Leer el creatorRef AHORA
                        const coinDataTemp = (await getDoc(coinRef)).data(); // Lectura preliminar solo para obtener creatorId
                        if (!coinDataTemp) throw new Error("La moneda no existe.");
                        const creatorRef = doc(playersRef, coinDataTemp.creatorId);

                        const [playerDoc, coinDoc, walletDoc, creatorDoc] = await Promise.all([
                            transaction.get(playerRef),
                            transaction.get(coinRef),
                            transaction.get(walletRef),
                            transaction.get(creatorRef) // Leer el creador aqu√≠
                        ]);

                        if (!playerDoc.exists() || !coinDoc.exists()) throw new Error("Datos no encontrados.");
                        if (!creatorDoc.exists()) throw new Error("Creador no encontrado.");

                        let playerData = playerDoc.data();
                        let coinData = coinDoc.data();

                        if (playerData.sSOL_balance < ssolToSpend) throw new Error("sSOL insuficiente.");

                        // --- 2. L√ìGICA DE TRADE ---

                        // Impacto del Bot (si existe)
                        const botUpdates = simulateBotTrade(coinData, 'reactive_buy');
                        coinData = { ...coinData, ...botUpdates };

                        const ssolTraded = ssolToSpend;
                        const totalFee = ssolToSpend * TOTAL_FEE;
                        const ssolForTrade = ssolToSpend - totalFee;

                        const k = coinData.sSolPool * coinData.tokenPool;
                        const newSsolPool_k = coinData.sSolPool + ssolForTrade; // LP no se incrementa con fees
                        const newTokenPool = k / newSsolPool_k;
                        tokensReceived = coinData.tokenPool - newTokenPool;
                        const finalSsolPool = newSsolPool_k;

                        newPrice = finalSsolPool / newTokenPool; // Precio *despu√©s* de la compra
                        const newAllTimeHigh = Math.max(coinData.allTimeHigh || 0, newPrice);
                        const newAllTimeLow = Math.min(coinData.allTimeLow || 999999, newPrice);
                        const newMarketCap = newPrice * (newTokenPool + coinData.botTokenPool);
                        const newHistory = [...coinData.priceHistory, newPrice].slice(-50);
                        const newVolumeHistory = [...(coinData.volumeHistory || []), ssolTraded].slice(-50);
                        const newVolume = coinData.volume + ssolTraded;
                        const newCreatorFeesSsol = (coinData.creatorFeesSsol || 0) + totalFee;

                        let newHolderCount = coinData.holderCount;
                        let holderChange = 0;
                        let newFollowers = coinData.followers || 0;
                        let creatorFollowsIncrement = 0;
                        const currentTokens = walletDoc.exists() ? walletDoc.data().amount : 0;

                        if (currentTokens < 0.00000001) {
                            newHolderCount++;
                            holderChange = 1;
                            newFollowers++;
                            creatorFollowsIncrement = 1; // ¬°El jugador sigue al creador en la primera compra!
                        }
                        const newLastHolderCountChange = (coinData.lastHolderCountChange || 0) + holderChange;

                        const playerTradeHistory = walletDoc.exists() ? walletDoc.data().tradeHistory || [] : [];
                        const updatedTradeHistory = [...playerTradeHistory, {
                            type: 'buy',
                            price: newPrice, // Guardar el precio de impacto
                            amountSsol: ssolToSpend,
                            amountToken: tokensReceived,
                            coinId: selectedCoinId,
                            timestamp: new Date()
                        }].slice(-50);

                        // --- 3. ESCRITURAS AL FINAL ---

                        transaction.update(playerRef, { sSOL_balance: playerData.sSOL_balance - ssolToSpend });
                        transaction.set(walletRef, { amount: currentTokens + tokensReceived, tradeHistory: updatedTradeHistory }, { merge: true });

                        // Incrementar seguidores del creador
                        if (creatorFollowsIncrement > 0) {
                            transaction.update(creatorRef, { socialFollowers: increment(creatorFollowsIncrement) });
                        }
                        if (botUpdates.creatorFollowsIncrement > 0) {
                            transaction.update(creatorRef, { socialFollowers: increment(botUpdates.creatorFollowsIncrement) });
                        }
                        delete botUpdates.creatorFollowsIncrement;

                        transaction.update(coinRef, {
                             ...botUpdates,
                            sSolPool: finalSsolPool, tokenPool: newTokenPool,
                            currentPrice: newPrice, priceHistory: newHistory,
                            volume: newVolume, volumeHistory: newVolumeHistory,
                            marketCap: newMarketCap, holderCount: newHolderCount,
                            lastHolderCountChange: newLastHolderCountChange,
                            creatorFeesSsol: newCreatorFeesSsol,
                            allTimeHigh: newAllTimeHigh, allTimeLow: newAllTimeLow,
                            followers: newFollowers
                        });
                    });

                    showMessage(`¬°Compraste ${formatNumber(tokensReceived, 4)} ${allCoinsCache.get(selectedCoinId).symbol} a un precio de ${formatPrice(newPrice)}!`);
                    buyAmountEl.value = '';

                } catch (error) {
                    console.error("Error al comprar:", error);
                    showMessage(error.message);
                }
            });

            // Formulario de Venta
            sellFormEl.addEventListener('submit', async (e) => {
                e.preventDefault();
                const tokensToSell = parseFloatStrict(sellAmountEl.value);
                if (!selectedCoinId || isNaN(tokensToSell) || tokensToSell <= 0) return showMessage("Ingresa un monto v√°lido.");

                let ssolReceived = 0;
                let newPrice = 0;
                try {
                    await runTransaction(db, async (transaction) => {
                        // --- 1. LECTURAS PRIMERO ---
                        const playerRef = doc(playersRef, currentUserId);
                        const coinRef = doc(roomRef, selectedCoinId);
                        const walletRef = doc(playersRef, currentUserId, 'wallet', selectedCoinId);

                        // CORRECCI√ìN DE TRANSACCI√ìN: Leer el creatorRef AHORA
                        const coinDataTemp = (await getDoc(coinRef)).data(); // Lectura preliminar
                        if (!coinDataTemp) throw new Error("La moneda no existe.");
                        const creatorRef = doc(playersRef, coinDataTemp.creatorId);

                        const [playerDoc, coinDoc, walletDoc, creatorDoc] = await Promise.all([
                            transaction.get(playerRef),
                            transaction.get(coinRef),
                            transaction.get(walletRef),
                            transaction.get(creatorRef) // Leer el creador aqu√≠
                        ]);

                        if (!playerDoc.exists() || !coinDoc.exists()) throw new Error("Datos no encontrados.");
                        if (!walletDoc.exists() || walletDoc.data().amount < tokensToSell) throw new Error("No tienes suficientes tokens.");
                        if (!creatorDoc.exists()) throw new Error("Creador no encontrado.");

                        let playerData = playerDoc.data();
                        let coinData = coinDoc.data();
                        const walletData = walletDoc.data();

                        // --- 2. L√ìGICA DE TRADE ---

                        const botUpdates = simulateBotTrade(coinData, 'reactive_sell');
                        coinData = { ...coinData, ...botUpdates };

                        const totalFee = tokensToSell * TOTAL_FEE;
                        const tokensForTrade = tokensToSell - totalFee;

                        const k = coinData.sSolPool * coinData.tokenPool;
                        const newTokenPool_k = coinData.tokenPool + tokensForTrade; // LP no se incrementa con fees
                        const newSsolPool = k / newTokenPool_k;
                        ssolReceived = coinData.sSolPool - newSsolPool;
                        const finalTokenPool = newTokenPool_k;
                        const ssolTraded = ssolReceived;

                        if (ssolReceived < 0.00000001) throw new Error("Liquidez demasiado baja.");

                        newPrice = newSsolPool / finalTokenPool; // Precio *despu√©s* de la venta
                        const newAllTimeHigh = Math.max(coinData.allTimeHigh || 0, newPrice);
                        const newAllTimeLow = Math.min(coinData.allTimeLow || 999999, newPrice);
                        const newMarketCap = newPrice * (finalTokenPool + coinData.botTokenPool);
                        const newHistory = [...coinData.priceHistory, newPrice].slice(-50);
                        const newVolumeHistory = [...(coinData.volumeHistory || []), ssolTraded].slice(-50);
                        const newVolume = coinData.volume + ssolTraded;
                        const newCreatorFeesToken = (coinData.creatorFeesToken || 0) + totalFee; // Toda la fee al creador

                        let newHolderCount = coinData.holderCount;
                        let holderChange = 0;
                        const currentTokens = walletData.amount;
                        const newAmountInWallet = currentTokens - tokensToSell;
                        if (newAmountInWallet < 0.00000001 && currentTokens >= 0.00000001) {
                            newHolderCount--;
                            holderChange = -1;
                        }
                        const newLastHolderCountChange = (coinData.lastHolderCountChange || 0) + holderChange;

                        const playerTradeHistory = walletData.tradeHistory || [];
                        const updatedTradeHistory = [...playerTradeHistory, {
                            type: 'sell',
                            price: newPrice, // Guardar el precio de impacto
                            amountSsol: ssolReceived,
                            amountToken: tokensToSell,
                            coinId: selectedCoinId,
                            timestamp: new Date()
                        }].slice(-50);

                        // --- 3. ESCRITURAS AL FINAL ---

                        transaction.update(playerRef, { sSOL_balance: playerData.sSOL_balance + ssolReceived });
                        transaction.set(walletRef, { amount: newAmountInWallet, tradeHistory: updatedTradeHistory }, { merge: true });

                        if (botUpdates.creatorFollowsIncrement > 0) {
                            transaction.update(creatorRef, { socialFollowers: increment(botUpdates.creatorFollowsIncrement) });
                        }
                        delete botUpdates.creatorFollowsIncrement;

                        transaction.update(coinRef, {
                             ...botUpdates,
                            sSolPool: newSsolPool, tokenPool: finalTokenPool,
                            currentPrice: newPrice, priceHistory: newHistory,
                            volume: newVolume, volumeHistory: newVolumeHistory,
                            marketCap: newMarketCap, holderCount: newHolderCount,
                            lastHolderCountChange: newLastHolderCountChange,
                            creatorFeesToken: newCreatorFeesToken,
                            allTimeHigh: newAllTimeHigh, allTimeLow: newAllTimeLow
                        });
                    });

                    showMessage(`¬°Vendiste ${formatNumber(tokensToSell, 4)} ${allCoinsCache.get(selectedCoinId).symbol} por ${formatNumber(ssolReceived)} sSOL!`);
                    sellAmountEl.value = '';

                } catch (error) {
                    console.error("Error al vender:", error);
                    showMessage(error.message);
                }
            });

            document.querySelectorAll('.sell-percent-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const percent = parseFloat(btn.dataset.percent);
                    const coin = myPortfolioCache.get(selectedCoinId);
                    if (coin) {
                        // CORRECCI√ìN: Calcular con 2 decimales para evitar errores de precisi√≥n
                        const amountToSell = (coin.amount * percent).toFixed(2);
                        sellAmountEl.value = amountToSell;
                    } else {
                        showMessage("No tienes esta moneda.");
                        sellAmountEl.value = '0';
                    }
                });
            });

            // --- NUEVAS FUNCIONES: P2P, PANEL DE CREADOR, TIENDA, SOCIALFI, CHAT ---

            sendSsolFormEl.addEventListener('submit', async (e) => {
                e.preventDefault();
                const amountToSend = parseFloat(sendSsolAmountEl.value);
                if (!targetPlayerId || isNaN(amountToSend) || amountToSend <= 0) return showMessage("Monto inv√°lido.");

                try {
                    await runTransaction(db, async (transaction) => {
                        const senderRef = doc(playersRef, currentUserId);
                        const receiverRef = doc(playersRef, targetPlayerId);
                        const [senderDoc, receiverDoc] = await Promise.all([ transaction.get(senderRef), transaction.get(receiverRef) ]);
                        if (!senderDoc.exists() || !receiverDoc.exists()) throw new Error("Datos no encontrados.");
                        const senderData = senderDoc.data();
                        if (senderData.sSOL_balance < amountToSend) throw new Error("sSOL insuficiente.");

                        transaction.update(senderRef, { sSOL_balance: increment(-amountToSend) });
                        transaction.update(receiverRef, { sSOL_balance: increment(amountToSend) });
                    });

                    showMessage(`¬°Enviaste ${formatNumber(amountToSend)} sSOL a ${allPlayersCache.get(targetPlayerId)?.username || '...'}!`);
                    hideModal(sendSsolModalEl);
                    sendSsolFormEl.reset();

                } catch (error) {
                    console.error("Error al enviar sSOL:", error);
                    showMessage(error.message);
                }
            });

            function showCreatorDashboard() {
                creatorCoinsListEl.innerHTML = '';
                let hasCoins = false;

                // Ordenar por fecha (nuevo a viejo)
                const myCoins = Array.from(allCoinsCache.values())
                    .filter(coin => coin.creatorId === currentUserId)
                    .sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));

                myCoins.forEach(coin => {
                    hasCoins = true;
                    const itemEl = document.createElement('div');
                    itemEl.className = 'bg-item-hover p-3 rounded-lg';
                    itemEl.innerHTML = `
                        <div class="flex justify-between items-center mb-3">
                            <span class="font-semibold text-lg">${coin.name} (${coin.symbol})</span>
                            <button data-coin-id="${coin.id}" class="go-live-btn ${coin.isLive ? 'bg-gray-600' : 'bg-red-600 hover:bg-red-700'} text-white font-bold py-2 px-3 rounded-md text-sm transition">
                                ${coin.isLive ? 'EN VIVO' : 'Ir en Vivo'}
                            </button>
                        </div>
                        <div class="bg-gray-700/50 p-3 rounded-lg">
                            <h4 class="font-semibold mb-2">Comisiones Ganadas (Totales: 0.3%)</h4>
                            <div class="text-sm text-gray-300">sSOL: <span id="fee-ssol-${coin.id}">${formatNumber(coin.creatorFeesSsol, 6)}</span></div>
                            <div class="text-sm text-gray-300">${coin.symbol}: <span id="fee-token-${coin.id}">${formatNumber(coin.creatorFeesToken, 2)}</span></div>
                            <button data-coin-id="${coin.id}" class="claim-fee-btn w-full mt-2 bg-solana-green text-gray-900 font-bold py-2 px-3 rounded-md text-sm hover:bg-opacity-80 transition">Reclamar</button>
                        </div>
                    `;
                    creatorCoinsListEl.appendChild(itemEl);
                });

                if (!hasCoins) creatorCoinsListEl.innerHTML = '<p class="text-gray-400 text-center">No has creado ninguna moneda.</p>';

                creatorCoinsListEl.querySelectorAll('.claim-fee-btn').forEach(btn => btn.addEventListener('click', (e) => claimFees(e.target.dataset.coinId, e.target)));
                creatorCoinsListEl.querySelectorAll('.go-live-btn').forEach(btn => btn.addEventListener('click', (e) => toggleLive(e.target.dataset.coinId, e.target)));

                showModal(creatorDashboardModalEl);
            }

            async function claimFees(coinId, btn) {
                const coin = allCoinsCache.get(coinId);
                if (!coin || (coin.creatorFeesSsol < 0.00000001 && coin.creatorFeesToken < 0.00000001)) return showMessage("No hay comisiones que reclamar.");

                btn.disabled = true; btn.textContent = '...';
                const ssolToClaim = coin.creatorFeesSsol; const tokensToClaim = coin.creatorFeesToken;

                try {
                    await runTransaction(db, async (transaction) => {
                        const coinRef = doc(roomRef, coinId);
                        const playerRef = doc(playersRef, currentUserId);
                        const walletRef = doc(playersRef, currentUserId, 'wallet', coinId);
                        const [coinDoc, playerDoc, walletDoc] = await Promise.all([
                            transaction.get(coinRef), transaction.get(playerRef), transaction.get(walletRef)
                        ]);
                        if (!coinDoc.exists() || !playerDoc.exists()) throw new Error("Datos no encontrados.");

                        const walletData = walletDoc.exists() ? walletDoc.data() : { amount: 0, tradeHistory: [] };

                        transaction.update(coinRef, { creatorFeesSsol: 0, creatorFeesToken: 0 });
                        transaction.update(playerRef, { sSOL_balance: increment(ssolToClaim) });
                        transaction.set(walletRef, { amount: walletData.amount + tokensToClaim }, { merge: true });
                    });
                    showMessage("¬°Comisiones reclamadas!");
                    btn.textContent = "Reclamado";
                } catch (e) {
                    showMessage(e.message);
                    btn.disabled = false; btn.textContent = "Reclamar";
                }
            }

            async function toggleLive(coinId, btn) {
                const coin = allCoinsCache.get(coinId);
                const newState = !coin.isLive;
                btn.disabled = true; btn.textContent = '...';

                try {
                    const coinRef = doc(roomRef, coinId);
                    const initialViewers = newState ? 50 + Math.floor(Math.random() * 50) : 0;
                    const initialFollowers = newState ? (coin.followers || 0) + 5 + Math.floor(Math.random() * 10) : coin.followers;
                    await updateDoc(coinRef, { isLive: newState, liveViewers: initialViewers, followers: initialFollowers });

                    showMessage(newState ? "¬°Est√°s en vivo!" : "Directo finalizado.");
                    btn.textContent = newState ? "EN VIVO" : "Ir en Vivo";
                    btn.classList.toggle('bg-gray-600', newState); btn.classList.toggle('bg-red-600', !newState);
                    btn.disabled = false;
                } catch (e) { showMessage(e.message); btn.disabled = false; }
            }

            function showLiveStream() {
                if (!selectedCoinId) return;
                const coin = allCoinsCache.get(selectedCoinId); if (!coin) return;
                liveCoinNameEl.textContent = `LIVE: ${coin.name}`;
                liveViewersEl.textContent = formatNumber(coin.liveViewers || 0, 0);
                showModal(liveStreamModalEl);

                const coinRef = doc(roomRef, selectedCoinId);
                onSnapshot(coinRef, (doc) => {
                    if (doc.exists() && doc.data().isLive) {
                        liveViewersEl.textContent = formatNumber(doc.data().liveViewers || 0, 0);
                    } else {
                        hideModal(liveStreamModalEl);
                    }
                }, (error) => {
                     console.warn("Error en listener de Live Stream:", error.message);
                     hideModal(liveStreamModalEl);
                });
            }

            async function boostLiveStream(level) {
                if (!selectedCoinId) return;
                let boostCost = 0, viewerBonus = 0, followerBonus = 0;
                switch (level) {
                    case 'small':  boostCost = 0.1; viewerBonus = 100 + Math.floor(Math.random() * 100); followerBonus = 10 + Math.floor(Math.random() * 20); break;
                    case 'medium': boostCost = 1;   viewerBonus = 500 + Math.floor(Math.random() * 500); followerBonus = 50 + Math.floor(Math.random() * 50); break;
                    case 'large':  boostCost = 10;  viewerBonus = 2000 + Math.floor(Math.random() * 3000); followerBonus = 200 + Math.floor(Math.random() * 300); break;
                    default: return showMessage("Nivel de boost inv√°lido.");
                }

                const btn = document.querySelector(`.boost-live-btn[data-boost-level="${level}"]`);
                if (btn) { btn.disabled = true; btn.textContent = '...'; }

                try {
                    await runTransaction(db, async (transaction) => {
                        const playerRef = doc(playersRef, currentUserId); const coinRef = doc(roomRef, selectedCoinId);
                        const [playerDoc, coinDoc] = await Promise.all([ transaction.get(playerRef), transaction.get(coinRef) ]);
                        if (!playerDoc.exists() || !coinDoc.exists()) throw new Error("Datos no encontrados.");
                        if (playerDoc.data().sSOL_balance < boostCost) throw new Error("sSOL insuficiente.");

                        transaction.update(playerRef, { sSOL_balance: increment(-boostCost) });
                        transaction.update(coinRef, {
                            liveViewers: increment(viewerBonus),
                            followers: increment(followerBonus)
                        });
                    });
                    showMessage(`¬°Boost (${level}) aplicado!`);
                } catch (e) { showMessage(e.message); }
                if (btn) { btn.disabled = false; btn.textContent = `Boost (${boostCost} sSOL)`; }
            }

            // Bot√≥n gen√©rico para comprar activos
            document.querySelectorAll('.buy-asset-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const target = e.currentTarget;
                    const item = target.dataset.item;
                    const cost = parseFloat(target.dataset.cost);
                    const category = target.dataset.category; // 'assets' (lujo) o 'office'

                    target.disabled = true; target.textContent = '...';

                    try {
                        await runTransaction(db, async (transaction) => {
                            const playerRef = doc(playersRef, currentUserId);
                            const playerDoc = await transaction.get(playerRef);
                            if (!playerDoc.exists()) throw new Error("No se encontr√≥ al jugador.");
                            if (playerDoc.data().sSOL_balance < cost) throw new Error("sSOL insuficiente.");

                            let updateData = { sSOL_balance: increment(-cost) };

                            if (category === 'office') {
                                const emoji = target.dataset.emoji;
                                const pos = target.dataset.pos;
                                const currentCount = playerDoc.data().officeItems?.[item]?.count || 0;
                                updateData[`officeItems.${item}`] = {
                                    count: currentCount + 1,
                                    emoji: emoji,
                                    pos: pos
                                };
                            } else {
                                updateData[`assets.${item}`] = increment(1);
                            }

                            transaction.update(playerRef, updateData);
                        });
                        showMessage(`¬°Felicidades! ¬°Compraste un ${item}!`);
                    } catch (e) { showMessage(e.message); }
                    target.disabled = false; target.textContent = 'Comprar';
                });
            });

            editSocialProfileFormEl.addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = socialUsernameInputEl.value.trim();
                const avatarUrl = socialAvatarInputEl.value.trim();
                if (!username) return showMessage("El nombre de usuario no puede estar vac√≠o.");

                try {
                    const playerRef = doc(playersRef, currentUserId);
                    await updateDoc(playerRef, {
                        username: username,
                        avatarUrl: avatarUrl || `https://placehold.co/60/374151/FFFFFF?text=${username.slice(0,1)}`
                    });
                    showMessage("Perfil actualizado.");
                    hideModal(myProfileModalEl);
                } catch (error) { showMessage("Error al actualizar perfil."); }
            });

            createSocialPostFormEl.addEventListener('submit', async (e) => {
                e.preventDefault();
                const postText = socialPostTextEl.value.trim();
                if (!postText) return showMessage("El post no puede estar vac√≠o.");

                try {
                    const postRef = doc(socialPostsRef); // Usar la colecci√≥n global
                    const player = allPlayersCache.get(currentUserId);
                    await setDoc(postRef, {
                        userId: currentUserId,
                        username: player.username,
                        avatarUrl: player.avatarUrl,
                        text: postText,
                        createdAt: serverTimestamp(),
                        likes: 0,
                        boosted: false
                    });
                    showMessage("Post publicado.");
                    hideModal(createSocialPostModalEl);
                    createSocialPostFormEl.reset();
                    showPage('page-social'); // Ir al feed
                } catch (error) { showMessage("Error al publicar post."); }
            });

            async function promotePost(postId, btn) {
                btn.disabled = true; btn.textContent = '...';
                try {
                    await runTransaction(db, async (transaction) => {
                        const playerRef = doc(playersRef, currentUserId);
                        const postRef = doc(socialPostsRef, postId);
                        const playerDoc = await transaction.get(playerRef);

                        if (!playerDoc.exists()) throw new Error("No se encontr√≥ al jugador.");
                        if (playerDoc.data().sSOL_balance < PROMO_POST_COST) throw new Error(`sSOL insuficiente. Necesitas ${PROMO_POST_COST}.`);

                        transaction.update(playerRef, { sSOL_balance: increment(-PROMO_POST_COST) });
                        transaction.update(postRef, { boosted: true });
                    });
                    showMessage("¬°Post promocionado!");
                } catch (e) {
                    showMessage(e.message);
                    btn.disabled = false; btn.textContent = `Promocionar (0.2 sSOL)`;
                }
            }

            async function showPlayerProfile(playerId) {
                if (playerId === currentUserId) {
                    showMyProfileBtn.click();
                    return;
                }

                selectedProfilePlayerId = playerId;
                const player = allPlayersCache.get(playerId);
                if (!player) return showMessage("No se encontr√≥ al jugador.");

                playerProfileUsernameEl.textContent = player.username;
                playerProfileAvatarEl.src = player.avatarUrl || 'https://placehold.co/60/374151/FFFFFF?text=P';
                playerProfileFollowersEl.textContent = formatNumber(player.socialFollowers || 0, 0);

                updateFollowButton();

                playerProfilePostsEl.innerHTML = '<p class="text-gray-400 text-sm">Cargando posts...</p>';
                playerProfileCoinsEl.innerHTML = '<p class="text-gray-400 text-sm">Cargando monedas...</p>';
                showModal(playerProfileModalEl);

                // Cargar posts del jugador
                const postsQuery = query(socialPostsRef, orderBy('createdAt', 'desc'), limit(10));
                const postsSnapshot = await getDocs(postsQuery);
                playerProfilePostsEl.innerHTML = '';
                let hasPosts = false;
                postsSnapshot.forEach(doc => {
                    if (doc.data().userId === playerId) {
                        hasPosts = true;
                        const post = doc.data();
                        const postEl = document.createElement('div');
                        postEl.className = 'bg-item-hover p-3 rounded-lg text-sm';
                        postEl.innerHTML = `
                            <p>${post.text}</p>
                            <p class="text-xs text-gray-500 mt-2">${new Date(post.createdAt.toDate()).toLocaleString()}</p>
                        `;
                        playerProfilePostsEl.appendChild(postEl);
                    }
                });
                if (!hasPosts) playerProfilePostsEl.innerHTML = '<p class="text-gray-400 text-sm">Este jugador no tiene posts.</p>';

                // Cargar monedas creadas
                playerProfileCoinsEl.innerHTML = '';
                let hasCoins = false;
                allCoinsCache.forEach(coin => {
                    if (coin.creatorId === playerId) {
                        hasCoins = true;
                        const coinEl = document.createElement('div');
                        coinEl.className = 'bg-item-hover p-2 rounded-lg text-sm flex items-center gap-2';
                        coinEl.innerHTML = `
                            <img src="${coin.imageUrl}" alt="${coin.symbol}" class="w-6 h-6 rounded-full">
                            <span>${coin.name} (${coin.symbol})</span>
                        `;
                        playerProfileCoinsEl.appendChild(coinEl);
                    }
                });
                if (!hasCoins) playerProfileCoinsEl.innerHTML = '<p class="text-gray-400 text-sm">Este jugador no ha creado monedas.</p>';
            }

            function updateFollowButton() {
                if (myFollowsCache.has(selectedProfilePlayerId)) {
                    followPlayerBtn.textContent = "Dejar de Seguir";
                    followPlayerBtn.classList.remove('bg-x-blue', 'hover:bg-opacity-80');
                    followPlayerBtn.classList.add('bg-gray-600', 'hover:bg-gray-700');
                } else {
                    followPlayerBtn.textContent = "Seguir";
                    followPlayerBtn.classList.add('bg-x-blue', 'hover:bg-opacity-80');
                    followPlayerBtn.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                }
            }

            followPlayerBtn.addEventListener('click', async () => {
                if (!selectedProfilePlayerId) return;

                followPlayerBtn.disabled = true;
                const isFollowing = myFollowsCache.has(selectedProfilePlayerId);

                try {
                    await runTransaction(db, async (transaction) => {
                        const myPlayerRef = doc(playersRef, currentUserId);
                        const targetPlayerRef = doc(playersRef, selectedProfilePlayerId);

                        // Leer mi propio doc primero
                        const myPlayerDoc = await transaction.get(myPlayerRef);
                        if (!myPlayerDoc.exists()) throw new Error("No existes.");
                        const currentFollows = myPlayerDoc.data().following || [];

                        // Leer doc del objetivo
                        const targetPlayerDoc = await transaction.get(targetPlayerRef);
                        if (!targetPlayerDoc.exists()) throw new Error("Jugador objetivo no existe.");

                        if (isFollowing) {
                            // Dejar de seguir
                            const newFollows = currentFollows.filter(id => id !== selectedProfilePlayerId);
                            transaction.update(myPlayerRef, { following: newFollows });
                            transaction.update(targetPlayerRef, { socialFollowers: increment(-1) });
                            myFollowsCache.delete(selectedProfilePlayerId);
                        } else {
                            // Seguir
                            const newFollows = [...currentFollows, selectedProfilePlayerId];
                            transaction.update(myPlayerRef, { following: newFollows });
                            transaction.update(targetPlayerRef, { socialFollowers: increment(1) });
                            myFollowsCache.add(selectedProfilePlayerId);
                        }
                    });

                    updateFollowButton();
                    const targetPlayer = allPlayersCache.get(selectedProfilePlayerId);
                    if (targetPlayer) {
                        playerProfileFollowersEl.textContent = formatNumber(targetPlayer.socialFollowers + (isFollowing ? -1 : 1), 0);
                    }

                } catch (e) {
                    showMessage("Error al seguir/dejar de seguir: " + e.message);
                }
                followPlayerBtn.disabled = false;
            });

            launchSocialFiCoinBtn.addEventListener('click', () => {
                const player = allPlayersCache.get(currentUserId);
                if (player && (player.socialFollowers || 0) >= 50) {
                    coinNameEl.value = `${player.username || 'Mi'} Coin`;
                    coinSymbolEl.value = (player.username || 'ME').slice(0,5).toUpperCase();
                    coinImageUrlEl.value = player.avatarUrl || '';
                    hideModal(myProfileModalEl);
                    showModal(createCoinModalEl);
                } else {
                    showMessage("Necesitas al menos 50 seguidores.");
                }
            });

            // --- L√ìGICA DE CHAT ---
            function listenForChatMessages() {
                // Si ya hay un listener, no crear otro
                if (chatListener) return;

                console.log("Iniciando listener de chat...");
                const q = query(chatRef, orderBy("timestamp", "desc"), limit(50));

                chatListener = onSnapshot(q, (snapshot) => {
                    chatMessagesEl.innerHTML = '';
                    if (snapshot.empty) {
                        chatMessagesEl.innerHTML = '<p class="text-gray-400 text-center text-sm">A√∫n no hay mensajes. ¬°S√© el primero!</p>';
                        return;
                    }

                    const messages = [];
                    snapshot.forEach(doc => messages.push(doc.data()));

                    // Invertir para mostrar viejo a nuevo
                    messages.reverse().forEach(msg => {
                        const player = allPlayersCache.get(msg.userId) || { username: 'Jugador', avatarUrl: '' };
                        const isMe = msg.userId === currentUserId;

                        const msgEl = document.createElement('div');
                        msgEl.className = `flex gap-2 ${isMe ? 'flex-row-reverse' : ''}`;
                        msgEl.innerHTML = `
                            <img src="${player.avatarUrl || 'https://placehold.co/32/374151/FFFFFF?text=P'}" alt="avatar" class="w-8 h-8 rounded-full ${isMe ? 'hidden' : ''}">
                            <div class="flex-grow ${isMe ? 'text-right' : ''}">
                                <span class="text-xs font-semibold ${isMe ? 'text-solana-green' : 'text-solana-purple'}">${player.username}</span>
                                <div class="bg-item-hover p-3 rounded-lg ${isMe ? 'bg-solana-purple/50' : ''} inline-block max-w-xs">
                                    <p class="text-sm text-white">${msg.text}</p>
                                </div>
                            </div>
                        `;
                        chatMessagesEl.appendChild(msgEl);
                    });

                    // Auto-scroll al fondo
                    chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;

                }, (error) => {
                    console.error("Error en listener (Chat):", error.message);
                    chatMessagesEl.innerHTML = '<p class="text-red-500 text-center text-sm">Error al cargar el chat.</p>';
                });
            }

            chatFormEl.addEventListener('submit', async (e) => {
                e.preventDefault();
                const text = chatInputEl.value.trim();
                if (!text) return;

                chatInputEl.value = ''; // Limpiar input inmediatamente

                try {
                    await addDoc(chatRef, {
                        userId: currentUserId,
                        text: text,
                        timestamp: serverTimestamp()
                    });
                } catch (error) {
                    console.error("Error al enviar mensaje:", error);
                    showMessage("No se pudo enviar tu mensaje.");
                    chatInputEl.value = text; // Restaurar texto si falla
                }
            });

            // --- L√ìGICA DE PNL ---
            async function showPnlModal() {
                if (!selectedCoinId) return showMessage("Selecciona una moneda primero.");

                const coin = allCoinsCache.get(selectedCoinId);
                const walletRef = doc(playersRef, currentUserId, 'wallet', selectedCoinId);

                let walletDoc;
                try {
                    walletDoc = await getDoc(walletRef);
                } catch (e) {
                    return showMessage("Error al leer tu billetera: " + e.message);
                }

                if (!walletDoc.exists() || !walletDoc.data().tradeHistory || walletDoc.data().tradeHistory.length === 0) {
                    return showMessage("No tienes historial de trades para esta moneda.");
                }

                const tradeHistory = walletDoc.data().tradeHistory || [];
                const currentTokens = walletDoc.data().amount || 0;

                let totalSsolInvested = 0;
                let totalSsolRealized = 0;
                let totalTokensBought = 0;
                let totalTokensSold = 0;

                tradeHistory.forEach(trade => {
                    if (trade.type === 'buy') {
                        totalSsolInvested += trade.amountSsol;
                        totalTokensBought += trade.amountToken;
                    } else if (trade.type === 'sell') {
                        totalSsolRealized += trade.amountSsol;
                        totalTokensSold += trade.amountToken;
                    }
                });

                const avgBuyPrice = totalTokensBought > 0 ? totalSsolInvested / totalTokensBought : 0;
                const currentValue = currentTokens * coin.currentPrice;

                // PnL Total = (Ganado por ventas + Valor actual) - Invertido
                const totalPnL_sSOL = (totalSsolRealized + currentValue) - totalSsolInvested;

                // PnL % = (Ganancia / Inversi√≥n) * 100
                const totalPnL_Percent = totalSsolInvested > 0 ? (totalPnL_sSOL / totalSsolInvested) * 100 : 0;

                // --- Actualizar el Modal ---
                pnlCoinSymbolEl.textContent = coin.symbol;

                // PnL Total (sSOL y %)
                pnlTotalSsolEl.textContent = `${totalPnL_sSOL >= 0 ? '+' : ''}${formatNumber(totalPnL_sSOL, 4)} sSOL`;
                pnlTotalPercentEl.textContent = `${totalPnL_Percent >= 0 ? '+' : ''}${formatNumber(totalPnL_Percent, 2)}%`;

                if (totalPnL_sSOL >= 0) {
                    pnlTotalSsolEl.className = 'text-2xl font-semibold mb-6 pnl-value-positive';
                    pnlTotalPercentEl.className = 'text-4xl font-bold mb-1 pnl-value-positive';
                } else {
                    pnlTotalSsolEl.className = 'text-2xl font-semibold mb-6 pnl-value-negative';
                    pnlTotalPercentEl.className = 'text-4xl font-bold mb-1 pnl-value-negative';
                }

                // Detalles
                pnlTotalInvestedEl.textContent = formatNumber(totalSsolInvested, 4);
                pnlTotalRealizedEl.textContent = formatNumber(totalSsolRealized, 4);
                pnlCurrentValueEl.textContent = formatNumber(currentValue, 4);
                pnlCurrentTokensEl.textContent = formatNumber(currentTokens, 4);
                pnlAvgBuyPriceEl.textContent = formatPrice(avgBuyPrice);

                showModal(pnlCardModalEl);
            }


            // --- INICIAR EL JUEGO ---
            initAuth();
            initChart();

            setTimeout(proactiveBotLoop, 5000);

            showMessage("¬°Bienvenido! Bots ajustados para reaccionar m√°s a los boosts.");

        } // --- FIN: ENVOLTORIO MAIN ASYNC ---

        // Llamar a la funci√≥n principal para iniciar todo
        main().catch(err => {
            console.error("Error fatal al iniciar la aplicaci√≥n:", err);
            const messageModalEl = document.getElementById('message-modal');
            const messageTextEl = document.getElementById('message-text');
            if (messageTextEl && messageModalEl) {
                messageTextEl.textContent = `Error fatal al iniciar: ${err.message}. Revisa la consola.`;
                messageModalEl.classList.remove('hidden');
                messageModalEl.classList.remove('opacity-0', 'visibility-hidden');
            }
        });

    </script>
</body>
</html>
